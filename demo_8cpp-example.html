<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.18"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AriaCoda: demo.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AriaCoda
   &#160;<span id="projectnumber">cdf8a12May11,2021</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.18 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('demo_8cpp-example.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">demo.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<p>General purpose testing and demo program, using ArMode classes to provide keyboard control of various robot functions.demo uses ArMode subclasses from ARIA. These modes provide keyboard control of various aspects and accessories of the robot, and can be re-used in your programs if you wish. <br  />
 The ArMode classes are defined in ArModes.cpp.</p>
<p>"demo" is a useful program for testing out the operation of the robot for diagnostic or demonstration purposes. Other example programs focus on individual areas.</p>
<div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment">Adept MobileRobots Robotics Interface for Applications (ARIA)</span></div>
<div class="line"><span class="comment">Copyright (C) 2004-2005 ActivMedia Robotics LLC</span></div>
<div class="line"><span class="comment">Copyright (C) 2006-2010 MobileRobots Inc.</span></div>
<div class="line"><span class="comment">Copyright (C) 2011-2015 Adept Technology, Inc.</span></div>
<div class="line"><span class="comment">Copyright (C) 2016-2018 Omron Adept Technologies, Inc.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">     This program is free software; you can redistribute it and/or modify</span></div>
<div class="line"><span class="comment">     it under the terms of the GNU General Public License as published by</span></div>
<div class="line"><span class="comment">     the Free Software Foundation; either version 2 of the License, or</span></div>
<div class="line"><span class="comment">     (at your option) any later version.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">     This program is distributed in the hope that it will be useful,</span></div>
<div class="line"><span class="comment">     but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div>
<div class="line"><span class="comment">     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></div>
<div class="line"><span class="comment">     GNU General Public License for more details.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">     You should have received a copy of the GNU General Public License</span></div>
<div class="line"><span class="comment">     along with this program; if not, write to the Free Software</span></div>
<div class="line"><span class="comment">     Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">*/</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;Aria/Aria.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Aria/ariaTypedefs.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Aria/ArActionGroups.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Aria/ArGripper.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Aria/ArTcpConnection.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Aria/ArSerialConnection.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Aria/ArPTZ.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Aria/ArRobotConfigPacketReader.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Aria/ArFunctor.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Aria/ArExport.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Aria/ariaOSDef.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Aria/ArRobot.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Aria/ariaInternal.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Aria/ArKeyHandler.h&quot;</span></div>
<div class="line"><span class="comment">//#include &quot;Aria/ArSonyPTZ.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Aria/ArVCC4.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Aria/ArDPPTU.h&quot;</span></div>
<div class="line"><span class="comment">//#include &quot;Aria/ArAMPTU.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Aria/ArRVisionPTZ.h&quot;</span></div>
<div class="line"><span class="comment">//#include &quot;Aria/ArSick.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Aria/ArLaser.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Aria/ArAnalogGyro.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Aria/ArRobotConfigPacketReader.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Aria/ArBatteryMTX.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;list&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">size_t</span> OutputBuffLen = 1056;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">bool</span> handleDebugMessage(ArRobotPacket *pkt)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span>(pkt-&gt;getID() != ArCommands::MARCDEBUG) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">  <span class="keywordtype">char</span> msg[256];</div>
<div class="line">  pkt-&gt;bufToStr(msg, <span class="keyword">sizeof</span>(msg));</div>
<div class="line">  msg[255] = 0;</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Controller Firmware Debug: %s&quot;</span>, msg);</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>ArMode </div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  AREXPORT ArMode(ArRobot *robot, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> key, <span class="keywordtype">char</span> key2);</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> ~ArMode();</div>
<div class="line">  AREXPORT <span class="keyword">const</span> <span class="keywordtype">char</span> *getName();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> activate() = 0;</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> deactivate() = 0;</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> userTask() {}</div>
<div class="line"> </div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> help() {}</div>
<div class="line">  AREXPORT <span class="keywordtype">bool</span> baseActivate(); </div>
<div class="line">  AREXPORT <span class="keywordtype">bool</span> baseDeactivate();</div>
<div class="line">  AREXPORT <span class="keyword">static</span> <span class="keywordtype">void</span> baseHelp();</div>
<div class="line">  AREXPORT <span class="keywordtype">char</span> getKey();</div>
<div class="line">  AREXPORT <span class="keywordtype">char</span> getKey2();</div>
<div class="line"><span class="keyword">protected</span>:</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> addKeyHandler(<span class="keywordtype">int</span> keyToHandle, ArFunctor *functor);</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> remKeyHandler(ArFunctor *functor);</div>
<div class="line">  <span class="comment">// Our activeArMode</span></div>
<div class="line">  AREXPORT <span class="keyword">static</span> ArMode *ourActiveMode;</div>
<div class="line">  std::string myName;</div>
<div class="line">  ArRobot *myRobot;</div>
<div class="line">  ArFunctorC&lt;ArMode&gt; myActivateCB;</div>
<div class="line">  ArFunctorC&lt;ArMode&gt; myDeactivateCB;</div>
<div class="line">  ArFunctorC&lt;ArMode&gt; myUserTaskCB;</div>
<div class="line">  <span class="keywordtype">char</span> myKey;</div>
<div class="line">  <span class="keywordtype">char</span> myKey2;</div>
<div class="line">  <span class="comment">// our help callback, its NULL until its initialized</span></div>
<div class="line">  <span class="keyword">static</span> ArGlobalFunctor *ourHelpCB;</div>
<div class="line">  <span class="keyword">static</span> std::list&lt;ArMode *&gt; ourModes;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>ArModeTeleop : <span class="keyword">public</span> ArMode</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  AREXPORT ArModeTeleop(ArRobot *robot, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> key, <span class="keywordtype">char</span> key2);</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> ~ArModeTeleop();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> activate();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> deactivate();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> help();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> userTask();</div>
<div class="line"><span class="keyword">protected</span>:</div>
<div class="line">  <span class="comment">//ArActionGroupTeleop myGroup;</span></div>
<div class="line">  <span class="comment">// use our new ratio drive instead</span></div>
<div class="line">  ArActionGroupRatioDrive myGroup;</div>
<div class="line">  ArFunctorC&lt;ArRobot&gt; myEnableMotorsCB;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>ArModeUnguardedTeleop : <span class="keyword">public</span> ArMode</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  AREXPORT ArModeUnguardedTeleop(ArRobot *robot, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> key, <span class="keywordtype">char</span> key2);</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> ~ArModeUnguardedTeleop();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> activate();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> deactivate();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> help();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> userTask();</div>
<div class="line"><span class="keyword">protected</span>:</div>
<div class="line">  <span class="comment">//ArActionGroupUnguardedTeleop myGroup;</span></div>
<div class="line">  <span class="comment">// use our new ratio drive instead</span></div>
<div class="line">  ArActionGroupRatioDriveUnsafe myGroup;</div>
<div class="line">  ArFunctorC&lt;ArRobot&gt; myEnableMotorsCB;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>ArModeWander : <span class="keyword">public</span> ArMode</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  AREXPORT ArModeWander(ArRobot *robot, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> key, <span class="keywordtype">char</span> key2);</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> ~ArModeWander();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> activate();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> deactivate();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> help();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> userTask();</div>
<div class="line"><span class="keyword">protected</span>:</div>
<div class="line">  ArActionGroupWander myGroup;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>ArModeGripper : <span class="keyword">public</span> ArMode</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  AREXPORT ArModeGripper(ArRobot *robot, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> key,</div>
<div class="line">             <span class="keywordtype">char</span> key2);</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> ~ArModeGripper();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> activate();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> deactivate();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> userTask();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> help();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> open();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> close();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> up();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> down();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> stop();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> exercise();</div>
<div class="line"><span class="keyword">protected</span>:</div>
<div class="line">  <span class="keyword">enum</span> ExerState {</div>
<div class="line">    UP_OPEN,</div>
<div class="line">    UP_CLOSE,</div>
<div class="line">    DOWN_CLOSE,</div>
<div class="line">    DOWN_OPEN</div>
<div class="line">  };</div>
<div class="line">  ArGripper myGripper;</div>
<div class="line">  <span class="keywordtype">bool</span> myExercising;</div>
<div class="line">  ExerState myExerState;</div>
<div class="line">  ArTime myLastExer;</div>
<div class="line">  ArFunctorC&lt;ArModeGripper&gt; myOpenCB;</div>
<div class="line">  ArFunctorC&lt;ArModeGripper&gt; myCloseCB;</div>
<div class="line">  ArFunctorC&lt;ArModeGripper&gt; myUpCB;</div>
<div class="line">  ArFunctorC&lt;ArModeGripper&gt; myDownCB;</div>
<div class="line">  ArFunctorC&lt;ArModeGripper&gt; myStopCB;</div>
<div class="line">  ArFunctorC&lt;ArModeGripper&gt; myExerciseCB;</div>
<div class="line">  </div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>ArModeCamera : <span class="keyword">public</span> ArMode</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  AREXPORT ArModeCamera(ArRobot *robot, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> key,</div>
<div class="line">             <span class="keywordtype">char</span> key2);</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> ~ArModeCamera();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> activate();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> deactivate();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> userTask();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> help();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> up();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> down();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> left();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> right();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> center();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> zoomIn();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> zoomOut();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> exercise();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> toggleAutoFocus();</div>
<div class="line"><span class="comment">//  AREXPORT void sony();</span></div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> canon();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> dpptu();</div>
<div class="line"><span class="comment">//  AREXPORT void amptu();</span></div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> canonInverted();</div>
<div class="line"><span class="comment">//  AREXPORT void sonySerial();</span></div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> canonSerial();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> dpptuSerial();</div>
<div class="line"><span class="comment">//  AREXPORT void amptuSerial();</span></div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> canonInvertedSerial();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> rvisionSerial();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> com1();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> com2();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> com3();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> com4();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> usb0();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> usb9();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> aux1();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> aux2();</div>
<div class="line"><span class="keyword">protected</span>:</div>
<div class="line">  <span class="keywordtype">void</span> takeCameraKeys();</div>
<div class="line">  <span class="keywordtype">void</span> giveUpCameraKeys();</div>
<div class="line">  <span class="keywordtype">void</span> helpCameraKeys();</div>
<div class="line">  <span class="keywordtype">void</span> takePortKeys();</div>
<div class="line">  <span class="keywordtype">void</span> giveUpPortKeys();</div>
<div class="line">  <span class="keywordtype">void</span> helpPortKeys();</div>
<div class="line">  <span class="keywordtype">void</span> takeAuxKeys();</div>
<div class="line">  <span class="keywordtype">void</span> giveUpAuxKeys();</div>
<div class="line">  <span class="keywordtype">void</span> helpAuxKeys();</div>
<div class="line">  <span class="keywordtype">void</span> takeMovementKeys();</div>
<div class="line">  <span class="keywordtype">void</span> giveUpMovementKeys();</div>
<div class="line">  <span class="keywordtype">void</span> helpMovementKeys();</div>
<div class="line">  <span class="keyword">enum</span> State {</div>
<div class="line">    STATE_CAMERA,</div>
<div class="line">    STATE_PORT,</div>
<div class="line">    STATE_MOVEMENT</div>
<div class="line">  };</div>
<div class="line">  <span class="keywordtype">void</span> cameraToMovement();</div>
<div class="line">  <span class="keywordtype">void</span> cameraToPort();</div>
<div class="line">  <span class="keywordtype">void</span> cameraToAux();</div>
<div class="line">  <span class="keywordtype">void</span> portToMovement();</div>
<div class="line">  <span class="keywordtype">void</span> auxToMovement();</div>
<div class="line">  <span class="keyword">enum</span> ExerState {</div>
<div class="line">    CENTER,</div>
<div class="line">    UP_LEFT,</div>
<div class="line">    UP_RIGHT,</div>
<div class="line">    DOWN_RIGHT,</div>
<div class="line">    DOWN_LEFT</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">bool</span> myExercising;</div>
<div class="line">  State myState;</div>
<div class="line">  ExerState myExerState;</div>
<div class="line">  ArTime myLastExer;</div>
<div class="line">  <span class="keywordtype">bool</span> myExerZoomedIn;</div>
<div class="line">  ArTime myLastExerZoomed;</div>
<div class="line">  ArSerialConnection myConn;</div>
<div class="line">  ArPTZ *myCam;</div>
<div class="line">  ArFunctorC&lt;ArModeCamera&gt; myUpCB;</div>
<div class="line">  ArFunctorC&lt;ArModeCamera&gt; myDownCB;</div>
<div class="line">  ArFunctorC&lt;ArModeCamera&gt; myLeftCB;</div>
<div class="line">  ArFunctorC&lt;ArModeCamera&gt; myRightCB;</div>
<div class="line">  ArFunctorC&lt;ArModeCamera&gt; myCenterCB;</div>
<div class="line">  ArFunctorC&lt;ArModeCamera&gt; myZoomInCB;</div>
<div class="line">  ArFunctorC&lt;ArModeCamera&gt; myZoomOutCB;</div>
<div class="line">  ArFunctorC&lt;ArModeCamera&gt; myExerciseCB;</div>
<div class="line"><span class="comment">//  ArFunctorC&lt;ArModeCamera&gt; mySonyCB;</span></div>
<div class="line">  ArFunctorC&lt;ArModeCamera&gt; myCanonCB;</div>
<div class="line">  ArFunctorC&lt;ArModeCamera&gt; myDpptuCB;</div>
<div class="line"><span class="comment">//  ArFunctorC&lt;ArModeCamera&gt; myAmptuCB;</span></div>
<div class="line">  ArFunctorC&lt;ArModeCamera&gt; myCanonInvertedCB;</div>
<div class="line"><span class="comment">//  ArFunctorC&lt;ArModeCamera&gt; mySonySerialCB;</span></div>
<div class="line">  ArFunctorC&lt;ArModeCamera&gt; myCanonSerialCB;</div>
<div class="line">  ArFunctorC&lt;ArModeCamera&gt; myDpptuSerialCB;</div>
<div class="line"><span class="comment">//  ArFunctorC&lt;ArModeCamera&gt; myAmptuSerialCB;</span></div>
<div class="line">  ArFunctorC&lt;ArModeCamera&gt; myCanonInvertedSerialCB;</div>
<div class="line">  ArFunctorC&lt;ArModeCamera&gt; myRVisionSerialCB;</div>
<div class="line">  ArFunctorC&lt;ArModeCamera&gt; myCom1CB;</div>
<div class="line">  ArFunctorC&lt;ArModeCamera&gt; myCom2CB;</div>
<div class="line">  ArFunctorC&lt;ArModeCamera&gt; myCom3CB;</div>
<div class="line">  ArFunctorC&lt;ArModeCamera&gt; myCom4CB;</div>
<div class="line">  ArFunctorC&lt;ArModeCamera&gt; myUSBCom0CB;</div>
<div class="line">  ArFunctorC&lt;ArModeCamera&gt; myUSBCom9CB;</div>
<div class="line">  ArFunctorC&lt;ArModeCamera&gt; myAux1CB;</div>
<div class="line">  ArFunctorC&lt;ArModeCamera&gt; myAux2CB;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">int</span> myPanAmount;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">int</span> myTiltAmount;</div>
<div class="line">  <span class="keywordtype">bool</span> myAutoFocusOn;</div>
<div class="line">  ArFunctorC&lt;ArModeCamera&gt; myToggleAutoFocusCB;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>ArModeSonar : <span class="keyword">public</span> ArMode</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  AREXPORT ArModeSonar(ArRobot *robot, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> key, <span class="keywordtype">char</span> key2);</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> ~ArModeSonar();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> activate();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> deactivate();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> userTask();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> help();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> allSonar();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> firstSonar();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> secondSonar();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> thirdSonar();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> fourthSonar();</div>
<div class="line"><span class="keyword">protected</span>:</div>
<div class="line">  <span class="keyword">enum</span> State </div>
<div class="line">  {</div>
<div class="line">    STATE_ALL,</div>
<div class="line">    STATE_FIRST,</div>
<div class="line">    STATE_SECOND,</div>
<div class="line">    STATE_THIRD,</div>
<div class="line">    STATE_FOURTH</div>
<div class="line">  };</div>
<div class="line">  State myState;</div>
<div class="line">  ArFunctorC&lt;ArModeSonar&gt; myAllSonarCB;</div>
<div class="line">  ArFunctorC&lt;ArModeSonar&gt; myFirstSonarCB;</div>
<div class="line">  ArFunctorC&lt;ArModeSonar&gt; mySecondSonarCB;</div>
<div class="line">  ArFunctorC&lt;ArModeSonar&gt; myThirdSonarCB;</div>
<div class="line">  ArFunctorC&lt;ArModeSonar&gt; myFourthSonarCB;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>ArModeBumps : <span class="keyword">public</span> ArMode</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  AREXPORT ArModeBumps(ArRobot *robot, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> key, <span class="keywordtype">char</span> key2);</div>
<div class="line">  AREXPORT ~ArModeBumps();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> activate();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> deactivate();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> userTask();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> help();</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>ArModePosition : <span class="keyword">public</span> ArMode</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  AREXPORT ArModePosition(ArRobot *robot, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> key,</div>
<div class="line">              <span class="keywordtype">char</span> key2, ArAnalogGyro *gyro = NULL);</div>
<div class="line">  AREXPORT ~ArModePosition();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> activate();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> deactivate();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> userTask();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> help();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> up();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> down();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> left();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> right();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> stop();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> reset();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> mode();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> gyro();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> incDistance();</div>
<div class="line">  AREXPORT <span class="keywordtype">void</span> decDistance();</div>
<div class="line"><span class="keyword">protected</span>:</div>
<div class="line">  <span class="keyword">enum</span> Mode { MODE_BOTH, MODE_EITHER };</div>
<div class="line">  ArAnalogGyro *myGyro;</div>
<div class="line">  <span class="keywordtype">double</span> myGyroZero;</div>
<div class="line">  <span class="keywordtype">double</span> myRobotZero;</div>
<div class="line">  Mode myMode;</div>
<div class="line">  std::string myModeString;</div>
<div class="line">  <span class="keywordtype">bool</span> myInHeadingMode;</div>
<div class="line">  <span class="keywordtype">double</span> myHeading;</div>
<div class="line">  <span class="keywordtype">double</span> myDistance;</div>
<div class="line">  ArFunctorC&lt;ArModePosition&gt; myUpCB;</div>
<div class="line">  ArFunctorC&lt;ArModePosition&gt; myDownCB;</div>
<div class="line">  ArFunctorC&lt;ArModePosition&gt; myLeftCB;</div>
<div class="line">  ArFunctorC&lt;ArModePosition&gt; myRightCB;</div>
<div class="line">  ArFunctorC&lt;ArModePosition&gt; myStopCB;  </div>
<div class="line">  ArFunctorC&lt;ArModePosition&gt; myResetCB;  </div>
<div class="line">  ArFunctorC&lt;ArModePosition&gt; myModeCB;</div>
<div class="line">  ArFunctorC&lt;ArModePosition&gt; myGyroCB;</div>
<div class="line">  ArFunctorC&lt;ArModePosition&gt; myIncDistCB;</div>
<div class="line">  ArFunctorC&lt;ArModePosition&gt; myDecDistCB;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>ArModeIO : <span class="keyword">public</span> ArMode</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  AREXPORT ArModeIO(ArRobot *robot, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> key,</div>
<div class="line">              <span class="keywordtype">char</span> key2);</div>
<div class="line">  AREXPORT ~ArModeIO();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> activate();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> deactivate();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> userTask();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> help();</div>
<div class="line"><span class="keyword">protected</span>:</div>
<div class="line">  <span class="keywordtype">bool</span> myExplanationReady;</div>
<div class="line">  <span class="keywordtype">bool</span> myExplained;</div>
<div class="line">  ArTime myLastPacketTime;</div>
<div class="line">  <span class="keywordtype">char</span> myExplanation[OutputBuffLen];</div>
<div class="line">  <span class="keywordtype">char</span> myOutput[OutputBuffLen];</div>
<div class="line">  ArFunctorC&lt;ArModeIO&gt; myProcessIOCB;</div>
<div class="line">  <span class="keywordtype">void</span> toggleOutput(<span class="keywordtype">int</span> output);</div>
<div class="line">  ArFunctor1C&lt;ArModeIO, int&gt; myTog1CB;</div>
<div class="line">  ArFunctor1C&lt;ArModeIO, int&gt; myTog2CB;</div>
<div class="line">  ArFunctor1C&lt;ArModeIO, int&gt; myTog3CB;</div>
<div class="line">  ArFunctor1C&lt;ArModeIO, int&gt; myTog4CB;</div>
<div class="line">  ArFunctor1C&lt;ArModeIO, int&gt; myTog5CB;</div>
<div class="line">  ArFunctor1C&lt;ArModeIO, int&gt; myTog6CB;</div>
<div class="line">  ArFunctor1C&lt;ArModeIO, int&gt; myTog7CB;</div>
<div class="line">  ArFunctor1C&lt;ArModeIO, int&gt; myTog8CB;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>ArModeLaser : <span class="keyword">public</span> ArMode</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  AREXPORT ArModeLaser(ArRobot *robot, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> key, <span class="keywordtype">char</span> key2);</div>
<div class="line">  AREXPORT ~ArModeLaser();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> activate();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> deactivate();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> userTask();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> help();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> switchToLaser(<span class="keywordtype">int</span> laserNumber);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">protected</span>:</div>
<div class="line">  <span class="keywordtype">void</span> togMiddle();</div>
<div class="line">  <span class="keywordtype">void</span> togConnect();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">enum</span> State {</div>
<div class="line">    STATE_UNINITED,</div>
<div class="line">    STATE_CONNECTING,</div>
<div class="line">    STATE_CONNECTED</div>
<div class="line">  };</div>
<div class="line">  </div>
<div class="line">  State myState;</div>
<div class="line">  ArLaser *myLaser;</div>
<div class="line">  <span class="keywordtype">int</span> myLaserNumber;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">bool</span> myPrintMiddle;</div>
<div class="line"> </div>
<div class="line">  ArFunctorC&lt;ArModeLaser&gt; myTogMiddleCB;</div>
<div class="line"> </div>
<div class="line">  std::map&lt;int, ArLaser *&gt; myLasers;</div>
<div class="line">  std::map&lt;int, ArFunctor1C&lt;ArModeLaser, int&gt; *&gt; myLaserCallbacks;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment">class ArModeActs : public ArMode</span></div>
<div class="line"><span class="comment">{</span></div>
<div class="line"><span class="comment">public:</span></div>
<div class="line"><span class="comment">  AREXPORT ArModeActs(ArRobot *robot, const char *name, char key, char key2,</span></div>
<div class="line"><span class="comment">              ArACTS_1_2 *acts = NULL);</span></div>
<div class="line"><span class="comment">  AREXPORT virtual ~ArModeActs();</span></div>
<div class="line"><span class="comment">  AREXPORT virtual void activate();</span></div>
<div class="line"><span class="comment">  AREXPORT virtual void deactivate();</span></div>
<div class="line"><span class="comment">  AREXPORT virtual void help();</span></div>
<div class="line"><span class="comment">  AREXPORT virtual void userTask();</span></div>
<div class="line"><span class="comment">  AREXPORT virtual void channel1();</span></div>
<div class="line"><span class="comment">  AREXPORT virtual void channel2();</span></div>
<div class="line"><span class="comment">  AREXPORT virtual void channel3();</span></div>
<div class="line"><span class="comment">  AREXPORT virtual void channel4();</span></div>
<div class="line"><span class="comment">  AREXPORT virtual void channel5();</span></div>
<div class="line"><span class="comment">  AREXPORT virtual void channel6();</span></div>
<div class="line"><span class="comment">  AREXPORT virtual void channel7();</span></div>
<div class="line"><span class="comment">  AREXPORT virtual void channel8();</span></div>
<div class="line"><span class="comment">  AREXPORT virtual void stop();</span></div>
<div class="line"><span class="comment">  AREXPORT virtual void start();</span></div>
<div class="line"><span class="comment">  AREXPORT virtual void toggleAcquire();</span></div>
<div class="line"><span class="comment">  </span></div>
<div class="line"><span class="comment">protected:</span></div>
<div class="line"><span class="comment">  ArActionGroupColorFollow *myGroup;</span></div>
<div class="line"><span class="comment">  ArPTZ *camera;</span></div>
<div class="line"><span class="comment">  ArACTS_1_2 *myActs;</span></div>
<div class="line"><span class="comment">  ArRobot *myRobot;</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">  ArFunctorC&lt;ArModeActs&gt; myChannel1CB;</span></div>
<div class="line"><span class="comment">  ArFunctorC&lt;ArModeActs&gt; myChannel2CB;</span></div>
<div class="line"><span class="comment">  ArFunctorC&lt;ArModeActs&gt; myChannel3CB;</span></div>
<div class="line"><span class="comment">  ArFunctorC&lt;ArModeActs&gt; myChannel4CB;</span></div>
<div class="line"><span class="comment">  ArFunctorC&lt;ArModeActs&gt; myChannel5CB;</span></div>
<div class="line"><span class="comment">  ArFunctorC&lt;ArModeActs&gt; myChannel6CB;</span></div>
<div class="line"><span class="comment">  ArFunctorC&lt;ArModeActs&gt; myChannel7CB;</span></div>
<div class="line"><span class="comment">  ArFunctorC&lt;ArModeActs&gt; myChannel8CB;</span></div>
<div class="line"><span class="comment">  ArFunctorC&lt;ArModeActs&gt; myStopCB;</span></div>
<div class="line"><span class="comment">  ArFunctorC&lt;ArModeActs&gt; myStartCB;</span></div>
<div class="line"><span class="comment">  ArFunctorC&lt;ArModeActs&gt; myToggleAcquireCB;</span></div>
<div class="line"><span class="comment">};</span></div>
<div class="line"><span class="comment">*/</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>ArModeCommand : <span class="keyword">public</span> ArMode</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  AREXPORT ArModeCommand(ArRobot *robot, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> key,</div>
<div class="line">              <span class="keywordtype">char</span> key2);</div>
<div class="line">  AREXPORT ~ArModeCommand();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> activate();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> deactivate();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> help();</div>
<div class="line"><span class="keyword">protected</span>:</div>
<div class="line">  <span class="keywordtype">void</span> takeKeys();</div>
<div class="line">  <span class="keywordtype">void</span> giveUpKeys();</div>
<div class="line">  <span class="keywordtype">void</span> addChar(<span class="keywordtype">int</span> ch);</div>
<div class="line">  <span class="keywordtype">void</span> finishParsing();</div>
<div class="line">  <span class="keywordtype">void</span> reset(<span class="keywordtype">bool</span> print = <span class="keyword">true</span>);</div>
<div class="line">  <span class="keywordtype">char</span> myCommandString[70];</div>
<div class="line">  ArFunctor1C&lt;ArModeCommand, int&gt; my0CB;</div>
<div class="line">  ArFunctor1C&lt;ArModeCommand, int&gt; my1CB;</div>
<div class="line">  ArFunctor1C&lt;ArModeCommand, int&gt; my2CB;</div>
<div class="line">  ArFunctor1C&lt;ArModeCommand, int&gt; my3CB;</div>
<div class="line">  ArFunctor1C&lt;ArModeCommand, int&gt; my4CB;</div>
<div class="line">  ArFunctor1C&lt;ArModeCommand, int&gt; my5CB;</div>
<div class="line">  ArFunctor1C&lt;ArModeCommand, int&gt; my6CB;</div>
<div class="line">  ArFunctor1C&lt;ArModeCommand, int&gt; my7CB;</div>
<div class="line">  ArFunctor1C&lt;ArModeCommand, int&gt; my8CB;</div>
<div class="line">  ArFunctor1C&lt;ArModeCommand, int&gt; my9CB;</div>
<div class="line">  ArFunctor1C&lt;ArModeCommand, int&gt; myMinusCB;</div>
<div class="line">  ArFunctor1C&lt;ArModeCommand, int&gt; myBackspaceCB;</div>
<div class="line">  ArFunctor1C&lt;ArModeCommand, int&gt; mySpaceCB;</div>
<div class="line">  ArFunctorC&lt;ArModeCommand&gt; myEnterCB;</div>
<div class="line"> </div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment">class ArModeTCM2 : public ArMode</span></div>
<div class="line"><span class="comment">{</span></div>
<div class="line"><span class="comment">public:</span></div>
<div class="line"><span class="comment">  AREXPORT ArModeTCM2(ArRobot *robot, const char *name, char key, char key2, ArTCM2 *tcm2 = NULL);</span></div>
<div class="line"><span class="comment">  AREXPORT virtual ~ArModeTCM2();</span></div>
<div class="line"><span class="comment">  AREXPORT virtual void activate();</span></div>
<div class="line"><span class="comment">  AREXPORT virtual void deactivate();</span></div>
<div class="line"><span class="comment">  AREXPORT virtual void help();</span></div>
<div class="line"><span class="comment">  AREXPORT virtual void userTask();</span></div>
<div class="line"><span class="comment">  </span></div>
<div class="line"><span class="comment">protected:</span></div>
<div class="line"><span class="comment">  void init();</span></div>
<div class="line"><span class="comment">  ArTCM2 *myTCM2;</span></div>
<div class="line"><span class="comment">  ArCompassConnector *connector;</span></div>
<div class="line"><span class="comment">  ArRobot *myRobot;</span></div>
<div class="line"><span class="comment">  ArFunctorC&lt;ArTCM2&gt; *myOffCB;</span></div>
<div class="line"><span class="comment">  ArFunctorC&lt;ArTCM2&gt; *myCompassCB;</span></div>
<div class="line"><span class="comment">  ArFunctorC&lt;ArTCM2&gt; *myOnePacketCB;</span></div>
<div class="line"><span class="comment">  ArFunctorC&lt;ArTCM2&gt; *myContinuousPacketsCB;</span></div>
<div class="line"><span class="comment">  ArFunctorC&lt;ArTCM2&gt; *myUserCalibrationCB;</span></div>
<div class="line"><span class="comment">  ArFunctorC&lt;ArTCM2&gt; *myAutoCalibrationCB;</span></div>
<div class="line"><span class="comment">  ArFunctorC&lt;ArTCM2&gt; *myStopCalibrationCB;</span></div>
<div class="line"><span class="comment">  ArFunctorC&lt;ArTCM2&gt; *myResetCB;</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">};</span></div>
<div class="line"><span class="comment">*/</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>ArModeConfig : <span class="keyword">public</span> ArMode</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  AREXPORT ArModeConfig(ArRobot *robot, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> key, <span class="keywordtype">char</span> key2);</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> activate();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> deactivate();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> help();</div>
<div class="line">  </div>
<div class="line"><span class="keyword">protected</span>:</div>
<div class="line">  ArRobot *myRobot;</div>
<div class="line">  ArRobotConfigPacketReader myConfigPacketReader;</div>
<div class="line">  ArFunctorC&lt;ArModeConfig&gt; myGotConfigPacketCB;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> gotConfigPacket();</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>ArModeRobotStatus : <span class="keyword">public</span> ArMode</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  AREXPORT ArModeRobotStatus(ArRobot *robot, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> key, <span class="keywordtype">char</span> key2);</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> activate();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> deactivate();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> help();</div>
<div class="line">  AREXPORT <span class="keyword">virtual</span> <span class="keywordtype">void</span> userTask();</div>
<div class="line">  </div>
<div class="line"><span class="keyword">protected</span>:</div>
<div class="line">  ArRobot *myRobot;</div>
<div class="line">  ArRetFunctor1C&lt;bool, ArModeRobotStatus, ArRobotPacket*&gt; myDebugMessageCB;</div>
<div class="line">  ArRetFunctor1C&lt;bool, ArModeRobotStatus, ArRobotPacket*&gt; mySafetyStateCB;</div>
<div class="line">  ArRetFunctor1C&lt;bool, ArModeRobotStatus, ArRobotPacket*&gt; mySafetyWarningCB;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> printFlags();</div>
<div class="line">  <span class="keywordtype">void</span> printFlagsHeader();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//std::string byte_as_bitstring(unsigned char byte);</span></div>
<div class="line">  <span class="comment">//std::string int16_as_bitstring(ArTypes::Byte2 n);</span></div>
<div class="line">  <span class="comment">//std::string int32_as_bitstring(ArTypes::Byte4 n);</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">bool</span> handleDebugMessage(ArRobotPacket *p);</div>
<div class="line">  <span class="keywordtype">bool</span> handleSafetyStatePacket(ArRobotPacket *p);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> *safetyStateName(<span class="keywordtype">int</span> state);</div>
<div class="line">  <span class="keywordtype">bool</span> handleSafetyWarningPacket(ArRobotPacket *p);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">bool</span> myBatteryShutdown;</div>
<div class="line">  <span class="keywordtype">void</span> toggleShutdown();</div>
<div class="line">  ArFunctorC&lt;ArModeRobotStatus&gt; myToggleShutdownCB;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv)</div>
<div class="line">{</div>
<div class="line">  <span class="comment">// Initialize some global data</span></div>
<div class="line">  Aria::init();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// If you want ArLog to print &quot;Verbose&quot; level messages uncomment this:</span></div>
<div class="line">  <span class="comment">//ArLog::init(ArLog::StdOut, ArLog::Verbose);</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">// This object parses program options from the command line</span></div>
<div class="line">  ArArgumentParser parser(&amp;argc, argv);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Load some default values for command line arguments from /etc/Aria.args</span></div>
<div class="line">  <span class="comment">// (Linux) or the ARIAARGS environment variable.</span></div>
<div class="line">  parser.loadDefaultArguments();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Central object that is an interface to the robot and its integrated</span></div>
<div class="line">  <span class="comment">// devices, and which manages control of the robot by the rest of the program.</span></div>
<div class="line">  ArRobot robot;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Object that connects to the robot or simulator using program options</span></div>
<div class="line">  ArRobotConnector robotConnector(&amp;parser, &amp;robot);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// If the robot has an Analog Gyro, this object will activate it, and </span></div>
<div class="line">  <span class="comment">// if the robot does not automatically use the gyro to correct heading,</span></div>
<div class="line">  <span class="comment">// this object reads data from it and corrects the pose in ArRobot</span></div>
<div class="line">  ArAnalogGyro gyro(&amp;robot);</div>
<div class="line"> </div>
<div class="line">  robot.addPacketHandler(<span class="keyword">new</span> ArGlobalRetFunctor1&lt;bool, ArRobotPacket*&gt;(&amp;handleDebugMessage));</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Connect to the robot, get some initial data from it such as type and name,</span></div>
<div class="line">  <span class="comment">// and then load parameter files for this robot.</span></div>
<div class="line">  <span class="keywordflow">if</span> (!robotConnector.connectRobot())</div>
<div class="line">  {</div>
<div class="line">    <span class="comment">// Error connecting:</span></div>
<div class="line">    <span class="comment">// if the user gave the -help argumentp, then just print out what happened,</span></div>
<div class="line">    <span class="comment">// and continue so options can be displayed later.</span></div>
<div class="line">    <span class="keywordflow">if</span> (!parser.checkHelpAndWarnUnparsed())</div>
<div class="line">    {</div>
<div class="line">      ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Could not connect to robot, will not have parameter file so options displayed later may not include everything&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// otherwise abort</span></div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">      ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Error, could not connect to robot.&quot;</span>);</div>
<div class="line">      Aria::logOptions();</div>
<div class="line">      Aria::exit(1);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span>(!robot.isConnected())</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Internal error: robot connector succeeded but ArRobot::isConnected() is false!&quot;</span>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Connector for laser rangefinders</span></div>
<div class="line">  ArLaserConnector laserConnector(&amp;parser, &amp;robot, &amp;robotConnector);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Connector for compasses</span></div>
<div class="line">  <span class="comment">//ArCompassConnector compassConnector(&amp;parser);</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Parse the command line options. Fail and print the help message if the parsing fails</span></div>
<div class="line">  <span class="comment">// or if the help was requested with the -help option</span></div>
<div class="line">  <span class="keywordflow">if</span> (!Aria::parseArgs() || !parser.checkHelpAndWarnUnparsed())</div>
<div class="line">  {    </div>
<div class="line">    Aria::logOptions();</div>
<div class="line">    Aria::exit(1);</div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Used to access and process sonar range data</span></div>
<div class="line">  ArSonarDevice sonarDev;</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// Used to perform actions when keyboard keys are pressed</span></div>
<div class="line">  ArKeyHandler keyHandler;</div>
<div class="line">  Aria::setKeyHandler(&amp;keyHandler);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// ArRobot contains an exit action for the Escape key. It also </span></div>
<div class="line">  <span class="comment">// stores a pointer to the keyhandler so that other parts of the program can</span></div>
<div class="line">  <span class="comment">// use the same keyhandler.</span></div>
<div class="line">  robot.attachKeyHandler(&amp;keyHandler);</div>
<div class="line">  printf(<span class="stringliteral">&quot;You may press escape to exit\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Attach sonarDev to the robot so it gets data from it.</span></div>
<div class="line">  robot.addRangeDevice(&amp;sonarDev);</div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  <span class="comment">// Start the robot task loop running in a new background thread. The &#39;true&#39; argument means if it loses</span></div>
<div class="line">  <span class="comment">// connection the task loop stops and the thread exits.</span></div>
<div class="line">  robot.runAsync(<span class="keyword">true</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Connect to the laser(s) if lasers were configured in this robot&#39;s parameter</span></div>
<div class="line">  <span class="comment">// file or on the command line, and run laser processing thread if applicable</span></div>
<div class="line">  <span class="comment">// for that laser class.  For the purposes of this demo, add all</span></div>
<div class="line">  <span class="comment">// possible lasers to ArRobot&#39;s list rather than just the ones that were</span></div>
<div class="line">  <span class="comment">// connected by this call so when you enter laser mode, you</span></div>
<div class="line">  <span class="comment">// can then interactively choose which laser to use from that list of all</span></div>
<div class="line">  <span class="comment">// lasers mentioned in robot parameters and on command line. Normally,</span></div>
<div class="line">  <span class="comment">// only connected lasers are put in ArRobot&#39;s list.</span></div>
<div class="line">  <span class="keywordflow">if</span> (!laserConnector.connectLasers(</div>
<div class="line">        <span class="keyword">false</span>,  <span class="comment">// continue after connection failures</span></div>
<div class="line">        <span class="keyword">false</span>,  <span class="comment">// add only connected lasers to ArRobot</span></div>
<div class="line">        <span class="keyword">true</span>    <span class="comment">// add all lasers to ArRobot</span></div>
<div class="line">  ))</div>
<div class="line">  {</div>
<div class="line">     printf(<span class="stringliteral">&quot;Warning: Could not connect to laser(s). Set LaserAutoConnect to false in this robot&#39;s individual parameter file to disable laser connection.\n&quot;</span>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* not needed, robot connector will do it by default</span></div>
<div class="line"><span class="comment">  if (!sonarConnector.connectSonars(</span></div>
<div class="line"><span class="comment">        false,  // continue after connection failures</span></div>
<div class="line"><span class="comment">        false,  // add only connected lasers to ArRobot</span></div>
<div class="line"><span class="comment">        true    // add all lasers to ArRobot</span></div>
<div class="line"><span class="comment">  ))</span></div>
<div class="line"><span class="comment">  {</span></div>
<div class="line"><span class="comment">    printf(&quot;Could not connect to sonars... exiting\n&quot;);</span></div>
<div class="line"><span class="comment">    Aria::exit(2);</span></div>
<div class="line"><span class="comment">  }</span></div>
<div class="line"><span class="comment">*/</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Create and connect to the compass if the robot has one.</span></div>
<div class="line"><span class="comment">//  ArTCM2 *compass = compassConnector.create(&amp;robot);</span></div>
<div class="line"><span class="comment">//  if(compass &amp;&amp; !compass-&gt;blockingConnect()) {</span></div>
<div class="line"><span class="comment">//    compass = NULL;</span></div>
<div class="line"><span class="comment">//  }</span></div>
<div class="line">  </div>
<div class="line">  <span class="comment">// Sleep for a second so some messages from the initial responses</span></div>
<div class="line">  <span class="comment">// from robots and cameras and such can catch up</span></div>
<div class="line">  ArUtil::sleep(1000);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// We need to lock the robot since we&#39;ll be setting up these modes</span></div>
<div class="line">  <span class="comment">// while the robot task loop thread is already running, and they </span></div>
<div class="line">  <span class="comment">// need to access some shared data in ArRobot.</span></div>
<div class="line">  robot.lock();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// now add all the modes for this demo</span></div>
<div class="line">  <span class="comment">// these classes are defined in ArModes.cpp in ARIA&#39;s source code.</span></div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">if</span>(robot.getOrigRobotConfig()-&gt;getHasGripper())</div>
<div class="line">    <span class="keyword">new</span> ArModeGripper(&amp;robot, <span class="stringliteral">&quot;gripper&quot;</span>, <span class="charliteral">&#39;g&#39;</span>, <span class="charliteral">&#39;G&#39;</span>);</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;Robot does not indicate that it has a gripper.&quot;</span>);</div>
<div class="line">  <span class="comment">//ArModeActs actsMode(&amp;robot, &quot;acts&quot;, &#39;a&#39;, &#39;A&#39;);</span></div>
<div class="line">  <span class="comment">//ArModeTCM2 tcm2(&amp;robot, &quot;tcm2&quot;, &#39;m&#39;, &#39;M&#39;, compass);</span></div>
<div class="line">  ArModeIO io(&amp;robot, <span class="stringliteral">&quot;io&quot;</span>, <span class="charliteral">&#39;i&#39;</span>, <span class="charliteral">&#39;I&#39;</span>);</div>
<div class="line">  ArModeRobotStatus stat(&amp;robot, <span class="stringliteral">&quot;detailed status/error flags&quot;</span>, <span class="charliteral">&#39;f&#39;</span>, <span class="charliteral">&#39;F&#39;</span>);</div>
<div class="line">  ArModeConfig cfg(&amp;robot, <span class="stringliteral">&quot;report robot config&quot;</span>, <span class="charliteral">&#39;o&#39;</span> , <span class="charliteral">&#39;O&#39;</span>);</div>
<div class="line">  ArModeCommand command(&amp;robot, <span class="stringliteral">&quot;command&quot;</span>, <span class="charliteral">&#39;d&#39;</span>, <span class="charliteral">&#39;D&#39;</span>);</div>
<div class="line">  ArModeCamera camera(&amp;robot, <span class="stringliteral">&quot;camera&quot;</span>, <span class="charliteral">&#39;c&#39;</span>, <span class="charliteral">&#39;C&#39;</span>);</div>
<div class="line">  ArModePosition position(&amp;robot, <span class="stringliteral">&quot;position&quot;</span>, <span class="charliteral">&#39;p&#39;</span>, <span class="charliteral">&#39;P&#39;</span>, &amp;gyro);</div>
<div class="line">  ArModeSonar sonar(&amp;robot, <span class="stringliteral">&quot;sonar&quot;</span>, <span class="charliteral">&#39;s&#39;</span>, <span class="charliteral">&#39;S&#39;</span>);</div>
<div class="line">  ArModeBumps bumps(&amp;robot, <span class="stringliteral">&quot;bumps&quot;</span>, <span class="charliteral">&#39;b&#39;</span>, <span class="charliteral">&#39;B&#39;</span>);</div>
<div class="line">  ArModeLaser laser(&amp;robot, <span class="stringliteral">&quot;laser&quot;</span>, <span class="charliteral">&#39;l&#39;</span>, <span class="charliteral">&#39;L&#39;</span>);</div>
<div class="line">  ArModeWander wander(&amp;robot, <span class="stringliteral">&quot;wander&quot;</span>, <span class="charliteral">&#39;w&#39;</span>, <span class="charliteral">&#39;W&#39;</span>);</div>
<div class="line">  ArModeUnguardedTeleop unguardedTeleop(&amp;robot, <span class="stringliteral">&quot;unguarded teleop&quot;</span>, <span class="charliteral">&#39;u&#39;</span>, <span class="charliteral">&#39;U&#39;</span>);</div>
<div class="line">  ArModeTeleop teleop(&amp;robot, <span class="stringliteral">&quot;teleop&quot;</span>, <span class="charliteral">&#39;t&#39;</span>, <span class="charliteral">&#39;T&#39;</span>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="comment">// activate the default mode</span></div>
<div class="line">  teleop.activate();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// turn on the motors</span></div>
<div class="line">  robot.comInt(ArCommands::ENABLE, 1);</div>
<div class="line"> </div>
<div class="line">  robot.unlock();</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// Block execution of the main thread here and wait for the robot&#39;s task loop</span></div>
<div class="line">  <span class="comment">// thread to exit (e.g. by robot disconnecting, escape key pressed, or OS</span></div>
<div class="line">  <span class="comment">// signal)</span></div>
<div class="line">  robot.waitForRunExit();</div>
<div class="line"> </div>
<div class="line">  Aria::exit(0);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">ArMode *ArMode::ourActiveMode = NULL;</div>
<div class="line">ArGlobalFunctor *ArMode::ourHelpCB = NULL;</div>
<div class="line">std::list&lt;ArMode *&gt; ArMode::ourModes;</div>
<div class="line"> </div>
<div class="line">AREXPORT ArMode::ArMode(ArRobot *robot, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> key, </div>
<div class="line">            <span class="keywordtype">char</span> key2) :</div>
<div class="line">  myActivateCB(this, &amp;ArMode::activate),</div>
<div class="line">  myDeactivateCB(this, &amp;ArMode::deactivate),</div>
<div class="line">  myUserTaskCB(this, &amp;ArMode::userTask)</div>
<div class="line">{</div>
<div class="line">  ArKeyHandler *keyHandler;</div>
<div class="line">  myName = name;</div>
<div class="line">  myRobot = robot;</div>
<div class="line">  myKey = key;</div>
<div class="line">  myKey2 = key2;</div>
<div class="line">  <span class="comment">// see if there is already a keyhandler, if not make one for ourselves</span></div>
<div class="line">  <span class="keywordflow">if</span> ((keyHandler = Aria::getKeyHandler()) == NULL)</div>
<div class="line">  {</div>
<div class="line">    keyHandler = <span class="keyword">new</span> ArKeyHandler;</div>
<div class="line">    Aria::setKeyHandler(keyHandler);</div>
<div class="line">    <span class="keywordflow">if</span> (myRobot != NULL)</div>
<div class="line">      myRobot-&gt;attachKeyHandler(keyHandler);</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;ArMode: No robot to attach a keyHandler to, keyHandling won&#39;t work... either make your own keyHandler and drive it yourself, make a keyhandler and attach it to a robot, or give this a robot to attach to.&quot;</span>);</div>
<div class="line">  }  </div>
<div class="line">  <span class="keywordflow">if</span> (ourHelpCB == NULL)</div>
<div class="line">  {</div>
<div class="line">    ourHelpCB = <span class="keyword">new</span> ArGlobalFunctor(&amp;ArMode::baseHelp);</div>
<div class="line">    <span class="keywordflow">if</span> (!keyHandler-&gt;addKeyHandler(<span class="charliteral">&#39;h&#39;</span>, ourHelpCB))</div>
<div class="line">      ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;The key handler already has a key for &#39;h&#39;, ArMode will not be invoked on an &#39;h&#39; keypress.&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (!keyHandler-&gt;addKeyHandler(<span class="charliteral">&#39;H&#39;</span>, ourHelpCB))</div>
<div class="line">      ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;The key handler already has a key for &#39;H&#39;, ArMode will not be invoked on an &#39;H&#39; keypress.&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (!keyHandler-&gt;addKeyHandler(<span class="charliteral">&#39;?&#39;</span>, ourHelpCB))</div>
<div class="line">      ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;The key handler already has a key for &#39;?&#39;, ArMode will not be invoked on an &#39;?&#39; keypress.&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (!keyHandler-&gt;addKeyHandler(<span class="charliteral">&#39;/&#39;</span>, ourHelpCB))</div>
<div class="line">      ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;The key handler already has a key for &#39;/&#39;, ArMode will not be invoked on an &#39;/&#39; keypress.&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// now that we have one, add our keys as callbacks, print out big</span></div>
<div class="line">  <span class="comment">// warning messages if they fail</span></div>
<div class="line">  <span class="keywordflow">if</span> (myKey != <span class="charliteral">&#39;\0&#39;</span>)</div>
<div class="line">    <span class="keywordflow">if</span> (!keyHandler-&gt;addKeyHandler(myKey, &amp;myActivateCB))</div>
<div class="line">      ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;The key handler already has a key for &#39;%c&#39;, ArMode will not work correctly.&quot;</span>, myKey);</div>
<div class="line">  <span class="keywordflow">if</span> (myKey2 != <span class="charliteral">&#39;\0&#39;</span>)</div>
<div class="line">    <span class="keywordflow">if</span> (!keyHandler-&gt;addKeyHandler(myKey2, &amp;myActivateCB))</div>
<div class="line">      ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;The key handler already has a key for &#39;%c&#39;, ArMode will not work correctly.&quot;</span>, myKey2);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// toss this mode into our list of modes</span></div>
<div class="line">  ourModes.push_front(<span class="keyword">this</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT ArMode::~ArMode()</div>
<div class="line">{</div>
<div class="line">  ArKeyHandler *keyHandler;</div>
<div class="line">  <span class="keywordflow">if</span> ((keyHandler = Aria::getKeyHandler()) != NULL)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">if</span> (myKey != <span class="charliteral">&#39;\0&#39;</span>)</div>
<div class="line">      keyHandler-&gt;remKeyHandler(myKey);</div>
<div class="line">    <span class="keywordflow">if</span> (myKey2 != <span class="charliteral">&#39;\0&#39;</span>)</div>
<div class="line">      keyHandler-&gt;remKeyHandler(myKey2);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (myRobot != NULL)</div>
<div class="line">    myRobot-&gt;remUserTask(&amp;myUserTaskCB);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">bool</span> ArMode::baseActivate()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (ourActiveMode == <span class="keyword">this</span>)</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">  myRobot-&gt;deactivateActions();</div>
<div class="line">  <span class="keywordflow">if</span> (myRobot != NULL)</div>
<div class="line">  {</div>
<div class="line">    myRobot-&gt;addUserTask((myName+<span class="stringliteral">&quot;_mode_usertask&quot;</span>).c_str(), 50, &amp;myUserTaskCB);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (ourActiveMode != NULL)</div>
<div class="line">    ourActiveMode-&gt;deactivate();</div>
<div class="line">  ourActiveMode = <span class="keyword">this</span>;</div>
<div class="line">  <span class="keywordflow">if</span> (myRobot != NULL)</div>
<div class="line">  {</div>
<div class="line">    myRobot-&gt;stop();</div>
<div class="line">    myRobot-&gt;clearDirectMotion();</div>
<div class="line">  }</div>
<div class="line">  </div>
<div class="line">  baseHelp();</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">bool</span> ArMode::baseDeactivate()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (myRobot != NULL)</div>
<div class="line">    myRobot-&gt;remUserTask(&amp;myUserTaskCB);</div>
<div class="line">  <span class="keywordflow">if</span> (ourActiveMode == <span class="keyword">this</span>)</div>
<div class="line">  {</div>
<div class="line">    ourActiveMode = NULL;</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keyword">const</span> <span class="keywordtype">char</span> *ArMode::getName()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">return</span> myName.c_str();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">char</span> ArMode::getKey()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">return</span> myKey;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">char</span> ArMode::getKey2()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">return</span> myKey2;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArMode::baseHelp()</div>
<div class="line">{</div>
<div class="line">  std::list&lt;ArMode *&gt;::iterator it;</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;\n\nYou can do these actions with these keys:\n&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;quit: escape&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;help: &#39;h&#39; or &#39;H&#39; or &#39;?&#39; or &#39;/&#39;&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;\nYou can switch to other modes with these keys:&quot;</span>);</div>
<div class="line">  <span class="keywordflow">for</span> (it = ourModes.begin(); it != ourModes.end(); ++it)</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%30s mode: &#39;%c&#39; or &#39;%c&#39;&quot;</span>, (*it)-&gt;getName(), </div>
<div class="line">           (*it)-&gt;getKey(), (*it)-&gt;getKey2());</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (ourActiveMode == NULL)</div>
<div class="line">    ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;You are in no mode currently.&quot;</span>);</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;You are in &#39;%s&#39; mode currently.\n&quot;</span>,</div>
<div class="line">           ourActiveMode-&gt;getName());</div>
<div class="line">    ourActiveMode-&gt;help();</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArMode::addKeyHandler(<span class="keywordtype">int</span> keyToHandle, ArFunctor *functor)</div>
<div class="line">{</div>
<div class="line">  ArKeyHandler *keyHandler;</div>
<div class="line">  std::string charStr;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// see if there is already a keyhandler, if not something is wrong</span></div>
<div class="line">  <span class="comment">// (since constructor should make one if there isn&#39;t one yet</span></div>
<div class="line">  <span class="keywordflow">if</span> ((keyHandler = Aria::getKeyHandler()) == NULL)</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Terse,<span class="stringliteral">&quot;ArMode &#39;%s&#39;::keyHandler: There should already be a key handler, but there isn&#39;t... mode won&#39;t work right.&quot;</span>, getName());</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (!keyHandler-&gt;addKeyHandler(keyToHandle, functor))</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordtype">bool</span> specialKey = <span class="keyword">true</span>;</div>
<div class="line">    <span class="keywordflow">switch</span> (keyToHandle) {</div>
<div class="line">    <span class="keywordflow">case</span> ArKeyHandler::UP:</div>
<div class="line">      charStr = <span class="stringliteral">&quot;Up&quot;</span>;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> ArKeyHandler::DOWN:</div>
<div class="line">      charStr = <span class="stringliteral">&quot;Down&quot;</span>;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> ArKeyHandler::LEFT:</div>
<div class="line">      charStr = <span class="stringliteral">&quot;Left&quot;</span>;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> ArKeyHandler::RIGHT:</div>
<div class="line">      charStr = <span class="stringliteral">&quot;Right&quot;</span>;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> ArKeyHandler::ESCAPE:</div>
<div class="line">      charStr = <span class="stringliteral">&quot;Escape&quot;</span>;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> ArKeyHandler::F1:</div>
<div class="line">      charStr = <span class="stringliteral">&quot;F1&quot;</span>;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> ArKeyHandler::F2:</div>
<div class="line">      charStr = <span class="stringliteral">&quot;F2&quot;</span>;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> ArKeyHandler::F3:</div>
<div class="line">      charStr = <span class="stringliteral">&quot;F3&quot;</span>;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> ArKeyHandler::F4:</div>
<div class="line">      charStr = <span class="stringliteral">&quot;F4&quot;</span>;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> ArKeyHandler::SPACE:</div>
<div class="line">      charStr = <span class="stringliteral">&quot;Space&quot;</span>;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> ArKeyHandler::TAB:</div>
<div class="line">      charStr = <span class="stringliteral">&quot;Tab&quot;</span>;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> ArKeyHandler::ENTER:</div>
<div class="line">      charStr = <span class="stringliteral">&quot;Enter&quot;</span>;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> ArKeyHandler::BACKSPACE:</div>
<div class="line">      charStr = <span class="stringliteral">&quot;Backspace&quot;</span>;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">      charStr = (char)keyToHandle;</div>
<div class="line">      specialKey = <span class="keyword">false</span>;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (specialKey || (keyToHandle &gt;= <span class="charliteral">&#39;!&#39;</span> &amp;&amp; keyToHandle &lt;= <span class="charliteral">&#39;~&#39;</span>))</div>
<div class="line">      ArLog::log(ArLog::Terse,  </div>
<div class="line">         <span class="stringliteral">&quot;ArMode &#39;%s&#39;: The key handler has a duplicate key for &#39;%s&#39; so the mode may not work right.&quot;</span>, getName(), charStr.c_str());</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      ArLog::log(ArLog::Terse,  </div>
<div class="line">         <span class="stringliteral">&quot;ArMode &#39;%s&#39;: The key handler has a duplicate key for number %d so the mode may not work right.&quot;</span>, getName(), keyToHandle);</div>
<div class="line">  }</div>
<div class="line">  </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArMode::remKeyHandler(ArFunctor *functor)</div>
<div class="line">{</div>
<div class="line">  ArKeyHandler *keyHandler;</div>
<div class="line">  std::string charStr;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// see if there is already a keyhandler, if not something is wrong</span></div>
<div class="line">  <span class="comment">// (since constructor should make one if there isn&#39;t one yet</span></div>
<div class="line">  <span class="keywordflow">if</span> ((keyHandler = Aria::getKeyHandler()) == NULL)</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Terse,<span class="stringliteral">&quot;ArMode &#39;%s&#39;::keyHandler: There should already be a key handler, but there isn&#39;t... mode won&#39;t work right.&quot;</span>, getName());</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (!keyHandler-&gt;remKeyHandler(functor))</div>
<div class="line">    ArLog::log(ArLog::Terse,  </div>
<div class="line">           <span class="stringliteral">&quot;ArMode &#39;%s&#39;: The key handler already didn&#39;t have the given functor so the mode may not be working right.&quot;</span>, getName());</div>
<div class="line">}</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">std::string byte_as_bitstring(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <span class="keywordtype">byte</span>) </div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">char</span> tmp[9];</div>
<div class="line">  <span class="keywordtype">int</span> bit; </div>
<div class="line">  <span class="keywordtype">int</span> ch;</div>
<div class="line">  <span class="keywordflow">for</span>(bit = 7, ch = 0; bit &gt;= 0; bit--,ch++)</div>
<div class="line">    tmp[ch] = ((<span class="keywordtype">byte</span>&gt;&gt;bit)&amp;1) ? <span class="charliteral">&#39;1&#39;</span> : <span class="charliteral">&#39;0&#39;</span>;</div>
<div class="line">  tmp[8] = 0;</div>
<div class="line">  <span class="keywordflow">return</span> std::string(tmp);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">std::string int16_as_bitstring(ArTypes::Byte2 n) </div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">char</span> tmp[17];</div>
<div class="line">  <span class="keywordtype">int</span> bit;</div>
<div class="line">  <span class="keywordtype">int</span> ch;</div>
<div class="line">  <span class="keywordflow">for</span>(bit = 15, ch = 0; bit &gt;= 0; bit--, ch++)</div>
<div class="line">    tmp[ch] = ((n&gt;&gt;bit)&amp;1) ? <span class="charliteral">&#39;1&#39;</span> : <span class="charliteral">&#39;0&#39;</span>;</div>
<div class="line">  tmp[16] = 0;</div>
<div class="line">  <span class="keywordflow">return</span> std::string(tmp);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">std::string int32_as_bitstring(ArTypes::Byte4 n)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">char</span> tmp[33];</div>
<div class="line">  <span class="keywordtype">int</span> bit;</div>
<div class="line">  <span class="keywordtype">int</span> ch;</div>
<div class="line">  <span class="keywordflow">for</span>(bit = 31, ch = 0; bit &gt;= 0; bit--, ch++)</div>
<div class="line">    tmp[ch] = ((n&gt;&gt;bit)&amp;1) ? <span class="charliteral">&#39;1&#39;</span> : <span class="charliteral">&#39;0&#39;</span>;</div>
<div class="line">  tmp[32] = 0;</div>
<div class="line">  <span class="keywordflow">return</span> std::string(tmp);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT ArModeTeleop::ArModeTeleop(ArRobot *robot, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> key, <span class="keywordtype">char</span> key2): </div>
<div class="line">  ArMode(robot, name, key, key2),</div>
<div class="line">  myGroup(robot),</div>
<div class="line">  myEnableMotorsCB(robot, &amp;ArRobot::enableMotors)</div>
<div class="line">{</div>
<div class="line">  myGroup.deactivate();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT ArModeTeleop::~ArModeTeleop()</div>
<div class="line">{</div>
<div class="line">  </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeTeleop::activate()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (!baseActivate())</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;e&#39;</span>, &amp;myEnableMotorsCB);</div>
<div class="line">  myGroup.activateExclusive();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeTeleop::deactivate()</div>
<div class="line">{</div>
<div class="line">  remKeyHandler(&amp;myEnableMotorsCB);</div>
<div class="line">  <span class="keywordflow">if</span> (!baseDeactivate())</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  myGroup.deactivate();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeTeleop::help()</div>
<div class="line">{</div>
<div class="line">  ArLog::log(ArLog::Terse, </div>
<div class="line">       <span class="stringliteral">&quot;Teleop mode will drive under your joystick or keyboard control.&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, </div>
<div class="line">         <span class="stringliteral">&quot;It will not allow you to drive into obstacles it can see,&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, </div>
<div class="line">      <span class="stringliteral">&quot;though if you are presistent you may be able to run into something.&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;For joystick, hold in the trigger button and then move the joystick to drive.&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;For keyboard control these are the keys and their actions:&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  speed up if forward or no motion, slow down if going backwards&quot;</span>, <span class="stringliteral">&quot;up arrow&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  slow down if going forwards, speed up if backward or no motion&quot;</span>, <span class="stringliteral">&quot;down arrow&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  turn left&quot;</span>, <span class="stringliteral">&quot;left arrow&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  turn right&quot;</span>, <span class="stringliteral">&quot;right arrow&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span> (myRobot-&gt;hasLatVel())</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  move left&quot;</span>, <span class="stringliteral">&quot;z&quot;</span>);</div>
<div class="line">    ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  move right&quot;</span>, <span class="stringliteral">&quot;x&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  stop&quot;</span>, <span class="stringliteral">&quot;space bar&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  (re)enable motors&quot;</span>, <span class="stringliteral">&quot;e&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span> (!myRobot-&gt;hasLatVel())</div>
<div class="line">    printf(<span class="stringliteral">&quot;%10s %10s %10s %10s %10s %10s&quot;</span>, <span class="stringliteral">&quot;transVel&quot;</span>, <span class="stringliteral">&quot;rotVel&quot;</span>, <span class="stringliteral">&quot;x&quot;</span>, <span class="stringliteral">&quot;y&quot;</span>, <span class="stringliteral">&quot;th&quot;</span>, <span class="stringliteral">&quot;volts&quot;</span>);</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    printf(<span class="stringliteral">&quot;%10s %10s %10s %10s %10s %10s %10s&quot;</span>, <span class="stringliteral">&quot;transVel&quot;</span>, <span class="stringliteral">&quot;rotVel&quot;</span>, <span class="stringliteral">&quot;latVel&quot;</span>, <span class="stringliteral">&quot;x&quot;</span>, <span class="stringliteral">&quot;y&quot;</span>, <span class="stringliteral">&quot;th&quot;</span>, <span class="stringliteral">&quot;volts&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span>(myRobot-&gt;haveStateOfCharge())</div>
<div class="line">    printf(<span class="stringliteral">&quot; %10s&quot;</span>, <span class="stringliteral">&quot;soc&quot;</span>);</div>
<div class="line">  printf(<span class="stringliteral">&quot; %10s&quot;</span>, <span class="stringliteral">&quot;&quot;</span>); <span class="comment">//flags</span></div>
<div class="line">  printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">  fflush(stdout);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeTeleop::userTask()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (!myRobot-&gt;hasLatVel())</div>
<div class="line">    printf(<span class="stringliteral">&quot;\r%10.0f %10.0f %10.0f %10.0f %10.1f %10.1f&quot;</span>, myRobot-&gt;getVel(), </div>
<div class="line">       myRobot-&gt;getRotVel(), myRobot-&gt;getX(), myRobot-&gt;getY(), </div>
<div class="line">       myRobot-&gt;getTh(), myRobot-&gt;getRealBatteryVoltage());</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    printf(<span class="stringliteral">&quot;\r%9.0f %9.0f %9.0f %9.0f %9.0f %9.1f %9.1f&quot;</span>, </div>
<div class="line">       myRobot-&gt;getVel(), myRobot-&gt;getRotVel(), myRobot-&gt;getLatVel(),</div>
<div class="line">       myRobot-&gt;getX(), myRobot-&gt;getY(), myRobot-&gt;getTh(), </div>
<div class="line">       myRobot-&gt;getRealBatteryVoltage());</div>
<div class="line">  <span class="keywordflow">if</span>(myRobot-&gt;haveStateOfCharge())</div>
<div class="line">    printf(<span class="stringliteral">&quot; %9.1f&quot;</span>, myRobot-&gt;getStateOfCharge());</div>
<div class="line">  <span class="keywordflow">if</span>(myRobot-&gt;isEStopPressed()) printf(<span class="stringliteral">&quot; [ESTOP]&quot;</span>); </div>
<div class="line">  <span class="keywordflow">if</span>(myRobot-&gt;isLeftMotorStalled() || myRobot-&gt;isRightMotorStalled()) printf(<span class="stringliteral">&quot; [STALL] &quot;</span>); </div>
<div class="line">  <span class="keywordflow">if</span>(!myRobot-&gt;areMotorsEnabled()) printf(<span class="stringliteral">&quot; [DISABLED] &quot;</span>); </div>
<div class="line">  </div>
<div class="line">  <span class="comment">// spaces to cover previous output</span></div>
<div class="line">  <span class="keywordflow">if</span>(!myRobot-&gt;isEStopPressed() || !(myRobot-&gt;isLeftMotorStalled() &amp;&amp; myRobot-&gt;isRightMotorStalled()) || myRobot-&gt;areMotorsEnabled())</div>
<div class="line">    printf(<span class="stringliteral">&quot;                 &quot;</span>);</div>
<div class="line"> </div>
<div class="line">  fflush(stdout);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT ArModeUnguardedTeleop::ArModeUnguardedTeleop(ArRobot *robot,</div>
<div class="line">                              <span class="keyword">const</span> <span class="keywordtype">char</span> *name, </div>
<div class="line">                              <span class="keywordtype">char</span> key, <span class="keywordtype">char</span> key2): </div>
<div class="line">  ArMode(robot, name, key, key2),</div>
<div class="line">  myGroup(robot),</div>
<div class="line">  myEnableMotorsCB(robot, &amp;ArRobot::enableMotors)</div>
<div class="line">{</div>
<div class="line">  myGroup.deactivate();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT ArModeUnguardedTeleop::~ArModeUnguardedTeleop()</div>
<div class="line">{</div>
<div class="line">  </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeUnguardedTeleop::activate()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (!baseActivate())</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;e&#39;</span>, &amp;myEnableMotorsCB);</div>
<div class="line">  myGroup.activateExclusive();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeUnguardedTeleop::deactivate()</div>
<div class="line">{</div>
<div class="line">  remKeyHandler(&amp;myEnableMotorsCB);</div>
<div class="line">  <span class="keywordflow">if</span> (!baseDeactivate())</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  myGroup.deactivate();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeUnguardedTeleop::help()</div>
<div class="line">{</div>
<div class="line">  ArLog::log(ArLog::Terse, </div>
<div class="line">       <span class="stringliteral">&quot;Unguarded teleop mode will drive under your joystick or keyboard control.&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, </div>
<div class="line">         <span class="stringliteral">&quot;\n### THIS MODE IS UNGUARDED AND UNSAFE, BE CAREFUL DRIVING&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse,</div>
<div class="line">         <span class="stringliteral">&quot;\nAs it will allow you to drive into things or down stairs.&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;For joystick, hold in the trigger button and then move the joystick to drive.&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;For keyboard control these are the keys and their actions:&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  speed up if forward or no motion, slow down if going backwards&quot;</span>, <span class="stringliteral">&quot;up arrow&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  slow down if going forwards, speed up if backward or no motion&quot;</span>, <span class="stringliteral">&quot;down arrow&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  turn left&quot;</span>, <span class="stringliteral">&quot;left arrow&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  turn right&quot;</span>, <span class="stringliteral">&quot;right arrow&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span> (myRobot-&gt;hasLatVel())</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  move left&quot;</span>, <span class="stringliteral">&quot;z&quot;</span>);</div>
<div class="line">    ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  move right&quot;</span>, <span class="stringliteral">&quot;x&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  stop&quot;</span>, <span class="stringliteral">&quot;space bar&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  (re)enable motors&quot;</span>, <span class="stringliteral">&quot;e&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span> (!myRobot-&gt;hasLatVel())</div>
<div class="line">    printf(<span class="stringliteral">&quot;%10s %10s %10s %10s %10s %10s&quot;</span>, <span class="stringliteral">&quot;transVel&quot;</span>, <span class="stringliteral">&quot;rotVel&quot;</span>, <span class="stringliteral">&quot;x&quot;</span>, <span class="stringliteral">&quot;y&quot;</span>, <span class="stringliteral">&quot;th&quot;</span>, <span class="stringliteral">&quot;volts&quot;</span>);</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    printf(<span class="stringliteral">&quot;%10s %10s %10s %10s %10s %10s %10s&quot;</span>, <span class="stringliteral">&quot;transVel&quot;</span>, <span class="stringliteral">&quot;rotVel&quot;</span>, <span class="stringliteral">&quot;latVel&quot;</span>, <span class="stringliteral">&quot;x&quot;</span>, <span class="stringliteral">&quot;y&quot;</span>, <span class="stringliteral">&quot;th&quot;</span>, <span class="stringliteral">&quot;volts&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span>(myRobot-&gt;haveStateOfCharge())</div>
<div class="line">    printf(<span class="stringliteral">&quot; %10s&quot;</span>, <span class="stringliteral">&quot;soc&quot;</span>);</div>
<div class="line">  printf(<span class="stringliteral">&quot; %10s&quot;</span>, <span class="stringliteral">&quot;&quot;</span>); <span class="comment">//flags</span></div>
<div class="line">  printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">  fflush(stdout);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeUnguardedTeleop::userTask()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (!myRobot-&gt;hasLatVel())</div>
<div class="line">    printf(<span class="stringliteral">&quot;\r%9.0f %9.0f %9.0f %9.0f %9.1f %9.1f&quot;</span>, myRobot-&gt;getVel(), </div>
<div class="line">       myRobot-&gt;getRotVel(), myRobot-&gt;getX(), myRobot-&gt;getY(), </div>
<div class="line">       myRobot-&gt;getTh(), myRobot-&gt;getRealBatteryVoltage());</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    printf(<span class="stringliteral">&quot;\r%9.0f %9.0f %9.0f %9.0f %9.0f %9.1f %9.1f&quot;</span>, </div>
<div class="line">       myRobot-&gt;getVel(), myRobot-&gt;getRotVel(), myRobot-&gt;getLatVel(),</div>
<div class="line">       myRobot-&gt;getX(), myRobot-&gt;getY(), myRobot-&gt;getTh(), </div>
<div class="line">       myRobot-&gt;getRealBatteryVoltage());</div>
<div class="line">  <span class="keywordflow">if</span>(myRobot-&gt;haveStateOfCharge())</div>
<div class="line">    printf(<span class="stringliteral">&quot; %9.1f&quot;</span>, myRobot-&gt;getStateOfCharge());</div>
<div class="line">  <span class="keywordflow">if</span>(myRobot-&gt;isEStopPressed()) printf(<span class="stringliteral">&quot; [ESTOP] &quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span>(myRobot-&gt;isLeftMotorStalled() || myRobot-&gt;isRightMotorStalled()) printf(<span class="stringliteral">&quot; [STALL] &quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span>(!myRobot-&gt;areMotorsEnabled()) printf(<span class="stringliteral">&quot; [DISABLED] &quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// spaces to cover previous output</span></div>
<div class="line">  <span class="keywordflow">if</span>(!myRobot-&gt;isEStopPressed() || !(myRobot-&gt;isLeftMotorStalled() &amp;&amp; myRobot-&gt;isRightMotorStalled()) || myRobot-&gt;areMotorsEnabled())</div>
<div class="line">    printf(<span class="stringliteral">&quot;                 &quot;</span>);</div>
<div class="line"> </div>
<div class="line">  fflush(stdout);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT ArModeWander::ArModeWander(ArRobot *robot, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> key, <span class="keywordtype">char</span> key2): </div>
<div class="line">  ArMode(robot, name, key, key2),</div>
<div class="line">  myGroup(robot)</div>
<div class="line">{</div>
<div class="line">  myGroup.deactivate();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT ArModeWander::~ArModeWander()</div>
<div class="line">{</div>
<div class="line">  </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeWander::activate()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (!baseActivate())</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  myGroup.activateExclusive();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeWander::deactivate()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (!baseDeactivate())</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  myGroup.deactivate(); </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeWander::help()</div>
<div class="line">{</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Wander mode will simply drive around forwards until it finds an obstacle,&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;then it will turn until its clear, and continue.&quot;</span>);</div>
<div class="line">  printf(<span class="stringliteral">&quot;%10s %10s %10s %10s %10s %10s\n&quot;</span>, <span class="stringliteral">&quot;transVel&quot;</span>, <span class="stringliteral">&quot;rotVel&quot;</span>, <span class="stringliteral">&quot;x&quot;</span>, <span class="stringliteral">&quot;y&quot;</span>, <span class="stringliteral">&quot;th&quot;</span>, <span class="stringliteral">&quot;volts&quot;</span>);</div>
<div class="line">  fflush(stdout);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeWander::userTask()</div>
<div class="line">{</div>
<div class="line">  printf(<span class="stringliteral">&quot;\r%10.0f %10.0f %10.0f %10.0f %10.1f %10.1f&quot;</span>, myRobot-&gt;getVel(), </div>
<div class="line">     myRobot-&gt;getRotVel(), myRobot-&gt;getX(), myRobot-&gt;getY(), </div>
<div class="line">     myRobot-&gt;getTh(), myRobot-&gt;getRealBatteryVoltage());</div>
<div class="line">  fflush(stdout);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT ArModeGripper::ArModeGripper(ArRobot *robot, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, </div>
<div class="line">                      <span class="keywordtype">char</span> key, <span class="keywordtype">char</span> key2): </div>
<div class="line">  ArMode(robot, name, key, key2),</div>
<div class="line">  myGripper(robot),</div>
<div class="line">  myOpenCB(this, &amp;ArModeGripper::open),</div>
<div class="line">  myCloseCB(this, &amp;ArModeGripper::close),</div>
<div class="line">  myUpCB(this, &amp;ArModeGripper::up),</div>
<div class="line">  myDownCB(this, &amp;ArModeGripper::down),</div>
<div class="line">  myStopCB(this, &amp;ArModeGripper::stop),</div>
<div class="line">  myExerciseCB(this, &amp;ArModeGripper::exercise)</div>
<div class="line">{</div>
<div class="line">  myExercising = <span class="keyword">false</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT ArModeGripper::~ArModeGripper()</div>
<div class="line">{</div>
<div class="line">  </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeGripper::activate()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (!baseActivate())</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">  addKeyHandler(ArKeyHandler::UP, &amp;myUpCB);</div>
<div class="line">  addKeyHandler(ArKeyHandler::DOWN, &amp;myDownCB);</div>
<div class="line">  addKeyHandler(ArKeyHandler::RIGHT, &amp;myOpenCB);</div>
<div class="line">  addKeyHandler(ArKeyHandler::LEFT, &amp;myCloseCB);  </div>
<div class="line">  addKeyHandler(ArKeyHandler::SPACE, &amp;myStopCB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;e&#39;</span>, &amp;myExerciseCB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;E&#39;</span>, &amp;myExerciseCB);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeGripper::deactivate()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (!baseDeactivate())</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">  remKeyHandler(&amp;myUpCB);</div>
<div class="line">  remKeyHandler(&amp;myDownCB);</div>
<div class="line">  remKeyHandler(&amp;myOpenCB);</div>
<div class="line">  remKeyHandler(&amp;myCloseCB);</div>
<div class="line">  remKeyHandler(&amp;myStopCB);</div>
<div class="line">  remKeyHandler(&amp;myExerciseCB);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeGripper::userTask()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> val;</div>
<div class="line">  printf(<span class="stringliteral">&quot;\r&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span> (myGripper.getBreakBeamState() &amp; 2) <span class="comment">// outer </span></div>
<div class="line">    printf(<span class="stringliteral">&quot;%13s&quot;</span>, <span class="stringliteral">&quot;blocked&quot;</span>);</div>
<div class="line">  <span class="keywordflow">else</span> </div>
<div class="line">    printf(<span class="stringliteral">&quot;%13s&quot;</span>, <span class="stringliteral">&quot;clear&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span> (myGripper.getBreakBeamState() &amp; 1) <span class="comment">// inner</span></div>
<div class="line">    printf(<span class="stringliteral">&quot;%13s&quot;</span>, <span class="stringliteral">&quot;blocked&quot;</span>);</div>
<div class="line">  <span class="keywordflow">else</span> </div>
<div class="line">    printf(<span class="stringliteral">&quot;%13s&quot;</span>, <span class="stringliteral">&quot;clear&quot;</span>);</div>
<div class="line">  val = myGripper.getGripState(); <span class="comment">// gripper portion</span></div>
<div class="line">  <span class="keywordflow">if</span> (val == 0)</div>
<div class="line">    printf(<span class="stringliteral">&quot;%13s&quot;</span>, <span class="stringliteral">&quot;between&quot;</span>);</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (val == 1)</div>
<div class="line">    printf(<span class="stringliteral">&quot;%13s&quot;</span>, <span class="stringliteral">&quot;open&quot;</span>);</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (val == 2)</div>
<div class="line">    printf(<span class="stringliteral">&quot;%13s&quot;</span>, <span class="stringliteral">&quot;closed&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span> (myGripper.isLiftMaxed()) <span class="comment">// lift</span></div>
<div class="line">    printf(<span class="stringliteral">&quot;%13s&quot;</span>, <span class="stringliteral">&quot;maxed&quot;</span>);</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    printf(<span class="stringliteral">&quot;%13s&quot;</span>, <span class="stringliteral">&quot;clear&quot;</span>);</div>
<div class="line">  val = myGripper.getPaddleState(); <span class="comment">// paddle section</span></div>
<div class="line">  <span class="keywordflow">if</span> (val &amp; 1) <span class="comment">// left paddle</span></div>
<div class="line">    printf(<span class="stringliteral">&quot;%13s&quot;</span>, <span class="stringliteral">&quot;triggered&quot;</span>);</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    printf(<span class="stringliteral">&quot;%13s&quot;</span>, <span class="stringliteral">&quot;clear&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span> (val &amp; 2) <span class="comment">// right paddle</span></div>
<div class="line">    printf(<span class="stringliteral">&quot;%13s&quot;</span>, <span class="stringliteral">&quot;triggered&quot;</span>);</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    printf(<span class="stringliteral">&quot;%13s&quot;</span>, <span class="stringliteral">&quot;clear&quot;</span>);</div>
<div class="line">  fflush(stdout);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// exercise the thing</span></div>
<div class="line">  <span class="keywordflow">if</span> (myExercising)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">switch</span> (myExerState) {</div>
<div class="line">    <span class="keywordflow">case</span> UP_OPEN:</div>
<div class="line">      <span class="keywordflow">if</span> ((myLastExer.mSecSince() &gt; 3000 &amp;&amp; myGripper.isLiftMaxed()) ||</div>
<div class="line">      myLastExer.mSecSince() &gt; 30000)</div>
<div class="line">      {</div>
<div class="line">    myGripper.gripClose();</div>
<div class="line">    myExerState = UP_CLOSE;</div>
<div class="line">    myLastExer.setToNow();</div>
<div class="line">    <span class="keywordflow">if</span> (myLastExer.mSecSince() &gt; 30000)</div>
<div class="line">      ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;\nLift took more than thirty seconds to raise, there is probably a problem with it.\n&quot;</span>);</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> UP_CLOSE:</div>
<div class="line">      <span class="keywordflow">if</span> (myGripper.getGripState() == 2 || myLastExer.mSecSince() &gt; 10000)</div>
<div class="line">      {</div>
<div class="line">    myGripper.liftDown();</div>
<div class="line">    myExerState = DOWN_CLOSE;</div>
<div class="line">    myLastExer.setToNow();</div>
<div class="line">    <span class="keywordflow">if</span> (myLastExer.mSecSince() &gt; 10000)</div>
<div class="line">      ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;\nGripper took more than 10 seconds to close, there is probably a problem with it.\n&quot;</span>);</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> DOWN_CLOSE:</div>
<div class="line">      <span class="keywordflow">if</span> ((myLastExer.mSecSince() &gt; 3000 &amp;&amp; myGripper.isLiftMaxed()) ||</div>
<div class="line">      myLastExer.mSecSince() &gt; 30000)</div>
<div class="line">      {</div>
<div class="line">    myGripper.gripOpen();</div>
<div class="line">    myExerState = DOWN_OPEN;</div>
<div class="line">    myLastExer.setToNow();</div>
<div class="line">    <span class="keywordflow">if</span> (myLastExer.mSecSince() &gt; 30000)</div>
<div class="line">      ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;\nLift took more than thirty seconds to raise, there is probably a problem with it.\n&quot;</span>);</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> DOWN_OPEN:</div>
<div class="line">      <span class="keywordflow">if</span> (myGripper.getGripState() == 1 || myLastExer.mSecSince() &gt; 10000)</div>
<div class="line">      {</div>
<div class="line">    myGripper.liftUp();</div>
<div class="line">    myExerState = UP_OPEN;</div>
<div class="line">    myLastExer.setToNow();</div>
<div class="line">    <span class="keywordflow">if</span> (myLastExer.mSecSince() &gt; 10000)</div>
<div class="line">      ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;\nGripper took more than 10 seconds to open, there is probably a problem with it.\n&quot;</span>);</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }      </div>
<div class="line">    </div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeGripper::open()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (myExercising == <span class="keyword">true</span>)</div>
<div class="line">  {</div>
<div class="line">    myExercising = <span class="keyword">false</span>;</div>
<div class="line">    myGripper.gripperHalt();</div>
<div class="line">  }</div>
<div class="line">  myGripper.gripOpen();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeGripper::close()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (myExercising == <span class="keyword">true</span>)</div>
<div class="line">  {</div>
<div class="line">    myExercising = <span class="keyword">false</span>;</div>
<div class="line">    myGripper.gripperHalt();</div>
<div class="line">  }</div>
<div class="line">  myGripper.gripClose();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeGripper::up()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (myExercising == <span class="keyword">true</span>)</div>
<div class="line">  {</div>
<div class="line">    myExercising = <span class="keyword">false</span>;</div>
<div class="line">    myGripper.gripperHalt();</div>
<div class="line">  }</div>
<div class="line">  myGripper.liftUp();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeGripper::down()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (myExercising == <span class="keyword">true</span>)</div>
<div class="line">  {</div>
<div class="line">    myExercising = <span class="keyword">false</span>;</div>
<div class="line">    myGripper.gripperHalt();</div>
<div class="line">  }</div>
<div class="line">  myGripper.liftDown();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeGripper::stop()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (myExercising == <span class="keyword">true</span>)</div>
<div class="line">  {</div>
<div class="line">    myExercising = <span class="keyword">false</span>;</div>
<div class="line">    myGripper.gripperHalt();</div>
<div class="line">  }</div>
<div class="line">  myGripper.gripperHalt();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeGripper::exercise()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (myExercising == <span class="keyword">false</span>)</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Terse, </div>
<div class="line">       <span class="stringliteral">&quot;\nGripper will now be exercised until another command is given.&quot;</span>);</div>
<div class="line">    myExercising = <span class="keyword">true</span>;</div>
<div class="line">    myExerState = UP_OPEN;</div>
<div class="line">    myGripper.liftUp();</div>
<div class="line">    myGripper.gripOpen();</div>
<div class="line">    myLastExer.setToNow();</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeGripper::help()</div>
<div class="line">{</div>
<div class="line">  ArLog::log(ArLog::Terse, </div>
<div class="line">         <span class="stringliteral">&quot;Gripper mode will let you control or exercise the gripper.&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, </div>
<div class="line">      <span class="stringliteral">&quot;If you start exercising the gripper it will stop your other commands.&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, </div>
<div class="line">         <span class="stringliteral">&quot;If you use other commands it will interrupt the exercising.&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  raise lift&quot;</span>, <span class="stringliteral">&quot;up arrow&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  lower lift&quot;</span>, <span class="stringliteral">&quot;down arrow&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  close gripper paddles&quot;</span>, <span class="stringliteral">&quot;left arrow&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  open gripper paddles&quot;</span>, <span class="stringliteral">&quot;right arrow&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  stop gripper paddles and lift&quot;</span>, </div>
<div class="line">         <span class="stringliteral">&quot;space bar&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  exercise the gripper&quot;</span>, <span class="stringliteral">&quot;&#39;e&#39; or &#39;E&#39;&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;\nGripper status:&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s%13s%13s%13s%13s%13s&quot;</span>, <span class="stringliteral">&quot;BB outer&quot;</span>, <span class="stringliteral">&quot;BB inner&quot;</span>,</div>
<div class="line">         <span class="stringliteral">&quot;Paddles&quot;</span>, <span class="stringliteral">&quot;Lift&quot;</span>, <span class="stringliteral">&quot;LeftPaddle&quot;</span>, <span class="stringliteral">&quot;RightPaddle&quot;</span>);</div>
<div class="line">  </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">AREXPORT ArModeCamera::ArModeCamera(ArRobot *robot, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, </div>
<div class="line">                      <span class="keywordtype">char</span> key, <span class="keywordtype">char</span> key2): </div>
<div class="line">  ArMode(robot, name, key, key2),</div>
<div class="line">  myUpCB(this, &amp;ArModeCamera::up),</div>
<div class="line">  myDownCB(this, &amp;ArModeCamera::down),</div>
<div class="line">  myLeftCB(this, &amp;ArModeCamera::left),</div>
<div class="line">  myRightCB(this, &amp;ArModeCamera::right),</div>
<div class="line">  myCenterCB(this, &amp;ArModeCamera::center),</div>
<div class="line">  myZoomInCB(this, &amp;ArModeCamera::zoomIn),  </div>
<div class="line">  myZoomOutCB(this, &amp;ArModeCamera::zoomOut),</div>
<div class="line">  myExerciseCB(this, &amp;ArModeCamera::exercise),</div>
<div class="line"><span class="comment">//  mySonyCB(this, &amp;ArModeCamera::sony),</span></div>
<div class="line">  myCanonCB(this, &amp;ArModeCamera::canon),</div>
<div class="line">  myDpptuCB(this, &amp;ArModeCamera::dpptu),</div>
<div class="line"><span class="comment">//  myAmptuCB(this, &amp;ArModeCamera::amptu),</span></div>
<div class="line">  myCanonInvertedCB(this, &amp;ArModeCamera::canonInverted),</div>
<div class="line"><span class="comment">//  mySonySerialCB(this, &amp;ArModeCamera::sonySerial),</span></div>
<div class="line">  myCanonSerialCB(this, &amp;ArModeCamera::canonSerial),</div>
<div class="line">  myDpptuSerialCB(this, &amp;ArModeCamera::dpptuSerial),</div>
<div class="line"><span class="comment">//  myAmptuSerialCB(this, &amp;ArModeCamera::amptuSerial),</span></div>
<div class="line">  myCanonInvertedSerialCB(this, &amp;ArModeCamera::canonInvertedSerial),</div>
<div class="line">  myRVisionSerialCB(this, &amp;ArModeCamera::rvisionSerial),</div>
<div class="line">  myCom1CB(this, &amp;ArModeCamera::com1),</div>
<div class="line">  myCom2CB(this, &amp;ArModeCamera::com2),</div>
<div class="line">  myCom3CB(this, &amp;ArModeCamera::com3),</div>
<div class="line">  myCom4CB(this, &amp;ArModeCamera::com4),</div>
<div class="line">  myUSBCom0CB(this, &amp;ArModeCamera::usb0),</div>
<div class="line">  myUSBCom9CB(this, &amp;ArModeCamera::usb9),</div>
<div class="line">  myAux1CB(this, &amp;ArModeCamera::aux1),</div>
<div class="line">  myAux2CB(this, &amp;ArModeCamera::aux2),</div>
<div class="line">  myPanAmount(5),</div>
<div class="line">  myTiltAmount(3),</div>
<div class="line">  myAutoFocusOn(true),</div>
<div class="line">  myToggleAutoFocusCB(this, &amp;ArModeCamera::toggleAutoFocus)</div>
<div class="line">{</div>
<div class="line">  myState = STATE_CAMERA;</div>
<div class="line">  myExercising = <span class="keyword">false</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT ArModeCamera::~ArModeCamera()</div>
<div class="line">{</div>
<div class="line">  </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeCamera::activate()</div>
<div class="line">{</div>
<div class="line">  ArKeyHandler *keyHandler;</div>
<div class="line">  <span class="keywordflow">if</span> (!baseActivate())</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  <span class="comment">// see if there is already a keyhandler, if not something is wrong</span></div>
<div class="line">  <span class="comment">// (since constructor should make one if there isn&#39;t one yet</span></div>
<div class="line">  <span class="keywordflow">if</span> ((keyHandler = Aria::getKeyHandler()) == NULL)</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Terse,<span class="stringliteral">&quot;ArModeCamera::activate: There should already be a key handler, but there isn&#39;t... mode won&#39;t work&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (myState == STATE_CAMERA)</div>
<div class="line">    takeCameraKeys();</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (myState == STATE_PORT)</div>
<div class="line">    takePortKeys();</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (myState == STATE_MOVEMENT)</div>
<div class="line">    takeMovementKeys();</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    ArLog::log(ArLog::Terse,<span class="stringliteral">&quot;ArModeCamera in bad state.&quot;</span>);</div>
<div class="line">  </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeCamera::deactivate()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (!baseDeactivate())</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  <span class="keywordflow">if</span> (myState == STATE_CAMERA)</div>
<div class="line">    giveUpCameraKeys();</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (myState == STATE_PORT)</div>
<div class="line">    giveUpPortKeys();</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (myState == STATE_MOVEMENT)</div>
<div class="line">    giveUpMovementKeys();</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    ArLog::log(ArLog::Terse,<span class="stringliteral">&quot;ArModeCamera in bad state.&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeCamera::userTask()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (myExercising &amp;&amp; myCam != NULL &amp;&amp; myLastExer.mSecSince() &gt; 7000)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">switch</span> (myExerState) {</div>
<div class="line">    <span class="keywordflow">case</span> CENTER:</div>
<div class="line">      myCam-&gt;panTilt(myCam-&gt;getMaxNegPan(), myCam-&gt;getMaxPosTilt());</div>
<div class="line">      myExerState = UP_LEFT;</div>
<div class="line">      myLastExer.setToNow();</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> UP_LEFT:</div>
<div class="line">      myCam-&gt;panTilt(myCam-&gt;getMaxPosPan(), myCam-&gt;getMaxPosTilt());</div>
<div class="line">      myExerState = UP_RIGHT;</div>
<div class="line">      myLastExer.setToNow();</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> UP_RIGHT:</div>
<div class="line">      myCam-&gt;panTilt(myCam-&gt;getMaxPosPan(), myCam-&gt;getMaxNegTilt());</div>
<div class="line">      myExerState = DOWN_RIGHT;</div>
<div class="line">      myLastExer.setToNow();</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> DOWN_RIGHT:</div>
<div class="line">      myCam-&gt;panTilt(myCam-&gt;getMaxNegPan(), myCam-&gt;getMaxNegTilt());</div>
<div class="line">      myExerState = DOWN_LEFT;</div>
<div class="line">      myLastExer.setToNow();</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> DOWN_LEFT:</div>
<div class="line">      myCam-&gt;panTilt(0, 0);</div>
<div class="line">      myExerState = CENTER;</div>
<div class="line">      myLastExer.setToNow();</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }      </div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (myExercising &amp;&amp; myCam != NULL &amp;&amp; myCam-&gt;canZoom() &amp;&amp; </div>
<div class="line">      myLastExerZoomed.mSecSince() &gt; 35000)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">if</span> (myExerZoomedIn)</div>
<div class="line">      myCam-&gt;zoom(myCam-&gt;getMinZoom());</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      myCam-&gt;zoom(myCam-&gt;getMaxZoom());</div>
<div class="line">    myLastExerZoomed.setToNow();</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeCamera::left()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (myExercising == <span class="keyword">true</span>)</div>
<div class="line">    myExercising = <span class="keyword">false</span>;</div>
<div class="line">  myCam-&gt;panRel(-myPanAmount);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeCamera::right()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (myExercising == <span class="keyword">true</span>)</div>
<div class="line">    myExercising = <span class="keyword">false</span>;</div>
<div class="line">  myCam-&gt;panRel(myPanAmount);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeCamera::up()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (myExercising == <span class="keyword">true</span>)</div>
<div class="line">    myExercising = <span class="keyword">false</span>;</div>
<div class="line">  myCam-&gt;tiltRel(myTiltAmount);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeCamera::down()</div>
<div class="line">{  </div>
<div class="line">  <span class="keywordflow">if</span> (myExercising == <span class="keyword">true</span>)</div>
<div class="line">    myExercising = <span class="keyword">false</span>;</div>
<div class="line">  myCam-&gt;tiltRel(-myTiltAmount);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeCamera::center()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (myExercising == <span class="keyword">true</span>)</div>
<div class="line">    myExercising = <span class="keyword">false</span>;</div>
<div class="line">  myCam-&gt;panTilt(0, 0);</div>
<div class="line">  myCam-&gt;zoom(myCam-&gt;getMinZoom());</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeCamera::exercise()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (myExercising == <span class="keyword">false</span>)</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Terse, </div>
<div class="line">       <span class="stringliteral">&quot;Camera will now be exercised until another command is given.&quot;</span>);</div>
<div class="line">    myExercising = <span class="keyword">true</span>;</div>
<div class="line">    myExerState = UP_LEFT;</div>
<div class="line">    myLastExer.setToNow();</div>
<div class="line">    myCam-&gt;panTilt(myCam-&gt;getMaxNegPan(), myCam-&gt;getMaxPosTilt());</div>
<div class="line">    myLastExerZoomed.setToNow();</div>
<div class="line">    myExerZoomedIn = <span class="keyword">true</span>;</div>
<div class="line">    <span class="keywordflow">if</span> (myCam-&gt;canZoom())</div>
<div class="line">      myCam-&gt;zoom(myCam-&gt;getMaxZoom());</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeCamera::toggleAutoFocus()</div>
<div class="line">{</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Turning autofocus %s&quot;</span>, myAutoFocusOn?<span class="stringliteral">&quot;off&quot;</span>:<span class="stringliteral">&quot;on&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span>(myCam-&gt;setAutoFocus(!myAutoFocusOn))</div>
<div class="line">    myAutoFocusOn = !myAutoFocusOn;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeCamera::help()</div>
<div class="line">{</div>
<div class="line">  ArLog::log(ArLog::Terse, </div>
<div class="line">         <span class="stringliteral">&quot;Camera mode will let you control or exercise the camera.&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, </div>
<div class="line">      <span class="stringliteral">&quot;If you start exercising the camera it will stop your other commands.&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span> (myState == STATE_CAMERA)</div>
<div class="line">    helpCameraKeys();</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (myState == STATE_PORT)</div>
<div class="line">    helpPortKeys();</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (myState == STATE_MOVEMENT)</div>
<div class="line">    helpMovementKeys();</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Something is horribly wrong and mode camera is in no state.&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeCamera::zoomIn()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (myCam-&gt;canZoom())</div>
<div class="line">  {</div>
<div class="line">    myCam-&gt;zoom(myCam-&gt;getZoom() + </div>
<div class="line">     ArMath::roundInt((myCam-&gt;getMaxZoom() - myCam-&gt;getMinZoom()) * .01));</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeCamera::zoomOut()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (myCam-&gt;canZoom())</div>
<div class="line">  {</div>
<div class="line">    myCam-&gt;zoom(myCam-&gt;getZoom() - </div>
<div class="line">    ArMath::roundInt((myCam-&gt;getMaxZoom() - myCam-&gt;getMinZoom()) * .01));</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment">AREXPORT void ArModeCamera::sony()</span></div>
<div class="line"><span class="comment">{</span></div>
<div class="line"><span class="comment">  myCam = new ArSonyPTZ(myRobot);</span></div>
<div class="line"><span class="comment">  ArLog::log(ArLog::Terse, &quot;\nSony selected, now need to select the aux port.&quot;);</span></div>
<div class="line"><span class="comment">  cameraToAux();</span></div>
<div class="line"><span class="comment">}</span></div>
<div class="line"><span class="comment">*/</span></div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeCamera::canon()</div>
<div class="line">{</div>
<div class="line">  myCam = <span class="keyword">new</span> ArVCC4(myRobot);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;\nCanon selected, now need to select the aux port.&quot;</span>);</div>
<div class="line">  cameraToAux();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeCamera::dpptu()</div>
<div class="line">{</div>
<div class="line">  myCam = <span class="keyword">new</span> ArDPPTU(myRobot);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;\nDPPTU selected, now need to select the aux port.&quot;</span>);</div>
<div class="line">  cameraToAux();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment">AREXPORT void ArModeCamera::amptu()</span></div>
<div class="line"><span class="comment">{</span></div>
<div class="line"><span class="comment">  myCam = new ArAMPTU(myRobot);</span></div>
<div class="line"><span class="comment">  ArLog::log(ArLog::Terse, </span></div>
<div class="line"><span class="comment">         &quot;\nActivMedia Pan Tilt Unit selected, now need to select the aux port.&quot;);</span></div>
<div class="line"><span class="comment">  cameraToAux();</span></div>
<div class="line"><span class="comment">}</span></div>
<div class="line"><span class="comment">*/</span></div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeCamera::canonInverted()</div>
<div class="line">{</div>
<div class="line">  myCam = <span class="keyword">new</span> ArVCC4(myRobot, <span class="keyword">true</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;\nInverted Canon selected, now need to select the aux port.&quot;</span>);</div>
<div class="line">  cameraToAux();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment">AREXPORT void ArModeCamera::sonySerial()</span></div>
<div class="line"><span class="comment">{</span></div>
<div class="line"><span class="comment">  myCam = new ArSonyPTZ(myRobot);</span></div>
<div class="line"><span class="comment">  ArLog::log(ArLog::Terse, &quot;\nSony selected, now need to select serial port.&quot;);</span></div>
<div class="line"><span class="comment">  cameraToPort();</span></div>
<div class="line"><span class="comment">}</span></div>
<div class="line"><span class="comment">*/</span></div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeCamera::canonSerial()</div>
<div class="line">{</div>
<div class="line">  myCam = <span class="keyword">new</span> ArVCC4(myRobot);</div>
<div class="line">  ArLog::log(ArLog::Terse, </div>
<div class="line">         <span class="stringliteral">&quot;\nCanon VCC4 selected, now need to select serial port.&quot;</span>);</div>
<div class="line">  cameraToPort();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeCamera::dpptuSerial()</div>
<div class="line">{</div>
<div class="line">  myCam = <span class="keyword">new</span> ArDPPTU(myRobot);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;\nDPPTU selected, now need to select serial port.&quot;</span>);</div>
<div class="line">  cameraToPort();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment">AREXPORT void ArModeCamera::amptuSerial()</span></div>
<div class="line"><span class="comment">{</span></div>
<div class="line"><span class="comment">  myCam = new ArAMPTU(myRobot);</span></div>
<div class="line"><span class="comment">  ArLog::log(ArLog::Terse, &quot;\nAMPTU selected, now need to select serial port.&quot;);</span></div>
<div class="line"><span class="comment">  cameraToPort();</span></div>
<div class="line"><span class="comment">}</span></div>
<div class="line"><span class="comment">*/</span></div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeCamera::canonInvertedSerial()</div>
<div class="line">{</div>
<div class="line">  myCam = <span class="keyword">new</span> ArVCC4(myRobot, <span class="keyword">true</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, </div>
<div class="line">         <span class="stringliteral">&quot;\nInverted Canon VCC4 selected, now need to select serial port.&quot;</span>);</div>
<div class="line">  cameraToPort();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeCamera::rvisionSerial()</div>
<div class="line">{</div>
<div class="line">  myCam = <span class="keyword">new</span> ArRVisionPTZ(myRobot);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;\nRVision selected, now need to select serial port.&quot;</span>);</div>
<div class="line">  cameraToPort();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeCamera::com1()</div>
<div class="line">{</div>
<div class="line">  myConn.setPort(ArUtil::COM1);</div>
<div class="line">  portToMovement();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeCamera::com2()</div>
<div class="line">{</div>
<div class="line">  myConn.setPort(ArUtil::COM2);</div>
<div class="line">  portToMovement();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeCamera::com3()</div>
<div class="line">{</div>
<div class="line">  myConn.setPort(ArUtil::COM3);</div>
<div class="line">  portToMovement();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeCamera::com4()</div>
<div class="line">{</div>
<div class="line">  myConn.setPort(ArUtil::COM4);</div>
<div class="line">  portToMovement();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeCamera::usb0()</div>
<div class="line">{</div>
<div class="line">  myConn.setPort(<span class="stringliteral">&quot;/dev/ttyUSB0&quot;</span>);</div>
<div class="line">  portToMovement();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeCamera::usb9()</div>
<div class="line">{</div>
<div class="line">  myConn.setPort(<span class="stringliteral">&quot;/dev/ttyUSB9&quot;</span>);</div>
<div class="line">  portToMovement();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeCamera::aux1()</div>
<div class="line">{</div>
<div class="line">  myCam-&gt;setAuxPort(1);</div>
<div class="line">  auxToMovement();</div>
<div class="line">}</div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeCamera::aux2()</div>
<div class="line">{</div>
<div class="line">  myCam-&gt;setAuxPort(2);</div>
<div class="line">  auxToMovement();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ArModeCamera::cameraToMovement()</div>
<div class="line">{</div>
<div class="line">  myState = STATE_MOVEMENT;</div>
<div class="line">  myCam-&gt;init();</div>
<div class="line">  myRobot-&gt;setPTZ(myCam);</div>
<div class="line">  giveUpCameraKeys();</div>
<div class="line">  takeMovementKeys();</div>
<div class="line">  helpMovementKeys();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ArModeCamera::cameraToPort()</div>
<div class="line">{</div>
<div class="line">  myState = STATE_PORT;</div>
<div class="line">  giveUpCameraKeys();</div>
<div class="line">  takePortKeys();</div>
<div class="line">  helpPortKeys();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ArModeCamera::cameraToAux()</div>
<div class="line">{</div>
<div class="line">  giveUpCameraKeys();</div>
<div class="line">  takeAuxKeys();</div>
<div class="line">  helpAuxKeys();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ArModeCamera::portToMovement()</div>
<div class="line">{</div>
<div class="line">  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;ArModeCamera: Opening connection to camera on port %s&quot;</span>, myConn.getPortName());</div>
<div class="line">  <span class="keywordflow">if</span> (!myConn.openSimple())</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Terse, </div>
<div class="line">           <span class="stringliteral">&quot;\n\nArModeCamera: Could not open camera on that port, try another port.\n&quot;</span>);</div>
<div class="line">    helpPortKeys();</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span>(!myCam-&gt;setDeviceConnection(&amp;myConn))</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;\n\nArModeCamera: Error setting device connection!\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line">  myCam-&gt;init();</div>
<div class="line">  myRobot-&gt;setPTZ(myCam);</div>
<div class="line">  myState = STATE_MOVEMENT;</div>
<div class="line">  giveUpPortKeys();</div>
<div class="line">  takeMovementKeys();</div>
<div class="line">  helpMovementKeys();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ArModeCamera::auxToMovement()</div>
<div class="line">{</div>
<div class="line">  myCam-&gt;init();</div>
<div class="line">  myRobot-&gt;setPTZ(myCam);</div>
<div class="line">  myState = STATE_MOVEMENT;</div>
<div class="line">  giveUpAuxKeys();</div>
<div class="line">  takeMovementKeys();</div>
<div class="line">  helpMovementKeys();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ArModeCamera::takeCameraKeys()</div>
<div class="line">{</div>
<div class="line"><span class="comment">//  addKeyHandler(&#39;1&#39;, &amp;mySonyCB);</span></div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;1&#39;</span>, &amp;myCanonCB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;2&#39;</span>, &amp;myDpptuCB);</div>
<div class="line"><span class="comment">//  addKeyHandler(&#39;4&#39;, &amp;myAmptuCB);</span></div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;3&#39;</span>, &amp;myCanonInvertedCB);</div>
<div class="line"><span class="comment">//  addKeyHandler(&#39;!&#39;, &amp;mySonySerialCB);</span></div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;4&#39;</span>, &amp;myCanonSerialCB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;5&#39;</span>, &amp;myDpptuSerialCB);</div>
<div class="line"><span class="comment">//  addKeyHandler(&#39;$&#39;, &amp;myAmptuSerialCB);</span></div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;6&#39;</span>, &amp;myCanonInvertedSerialCB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;7&#39;</span>, &amp;myRVisionSerialCB);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ArModeCamera::giveUpCameraKeys()</div>
<div class="line">{</div>
<div class="line">  remKeyHandler(&amp;myCanonCB);</div>
<div class="line"><span class="comment">//  remKeyHandler(&amp;mySonyCB);</span></div>
<div class="line">  remKeyHandler(&amp;myDpptuCB);</div>
<div class="line"><span class="comment">//  remKeyHandler(&amp;myAmptuCB);</span></div>
<div class="line">  remKeyHandler(&amp;myCanonInvertedCB);</div>
<div class="line"><span class="comment">//  remKeyHandler(&amp;mySonySerialCB);</span></div>
<div class="line">  remKeyHandler(&amp;myCanonSerialCB);</div>
<div class="line">  remKeyHandler(&amp;myDpptuSerialCB);</div>
<div class="line"><span class="comment">//  remKeyHandler(&amp;myAmptuSerialCB);</span></div>
<div class="line">  remKeyHandler(&amp;myCanonInvertedSerialCB);</div>
<div class="line">  remKeyHandler(&amp;myRVisionSerialCB);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ArModeCamera::helpCameraKeys()</div>
<div class="line">{</div>
<div class="line">  ArLog::log(ArLog::Terse, </div>
<div class="line">         <span class="stringliteral">&quot;You now need to select what type of camera you have.&quot;</span>);</div>
<div class="line"><span class="comment">//  ArLog::log(ArLog::Terse, </span></div>
<div class="line">    <span class="comment">//     &quot;%13s: select a SONY PTZ camera attached to the robot&quot;, &quot;&#39;1&#39;&quot;);</span></div>
<div class="line">  ArLog::log(ArLog::Terse, </div>
<div class="line">         <span class="stringliteral">&quot;%13s: select a Canon VCC4 camera attached to the robot&quot;</span>, <span class="stringliteral">&quot;&#39;1&#39;&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, </div>
<div class="line">         <span class="stringliteral">&quot;%13s: select a DPPTU camera attached to the robot&quot;</span>, <span class="stringliteral">&quot;&#39;2&#39;&quot;</span>);</div>
<div class="line"><span class="comment">//  ArLog::log(ArLog::Terse, </span></div>
<div class="line"><span class="comment">//       &quot;%13s: select an AMPTU camera attached to the robot&quot;, &quot;&#39;4&#39;&quot;);</span></div>
<div class="line">  ArLog::log(ArLog::Terse, </div>
<div class="line">         <span class="stringliteral">&quot;%13s: select an inverted Canon VCC4 camera attached to the robot&quot;</span>, <span class="stringliteral">&quot;&#39;3&#39;&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">//  ArLog::log(ArLog::Terse, </span></div>
<div class="line"><span class="comment">//       &quot;%13s: select a SONY PTZ camera attached to a serial port&quot;, </span></div>
<div class="line"><span class="comment">//       &quot;&#39;!&#39;&quot;);</span></div>
<div class="line">  ArLog::log(ArLog::Terse, </div>
<div class="line">         <span class="stringliteral">&quot;%13s: select a Canon VCC4 camera attached to a serial port&quot;</span>, </div>
<div class="line">         <span class="stringliteral">&quot;&#39;4&#39;&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, </div>
<div class="line">         <span class="stringliteral">&quot;%13s: select a DPPTU camera attached to a serial port&quot;</span>,</div>
<div class="line">         <span class="stringliteral">&quot;&#39;5&#39;&quot;</span>);</div>
<div class="line"><span class="comment">//  ArLog::log(ArLog::Terse, </span></div>
<div class="line"><span class="comment">//       &quot;%13s: select an AMPTU camera attached to a serial port&quot;, </span></div>
<div class="line"><span class="comment">//       &quot;&#39;$&#39;&quot;);</span></div>
<div class="line">  ArLog::log(ArLog::Terse, </div>
<div class="line">         <span class="stringliteral">&quot;%13s: select an inverted Canon VCC4 camera attached to a serial port&quot;</span>, </div>
<div class="line">         <span class="stringliteral">&quot;&#39;6&#39;&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse,</div>
<div class="line">         <span class="stringliteral">&quot;%13s: select an RVision camera attached to a serial port&quot;</span>,</div>
<div class="line">         <span class="stringliteral">&quot;&#39;7&#39;&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ArModeCamera::takePortKeys()</div>
<div class="line">{</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;1&#39;</span>, &amp;myCom1CB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;2&#39;</span>, &amp;myCom2CB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;3&#39;</span>, &amp;myCom3CB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;4&#39;</span>, &amp;myCom4CB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;5&#39;</span>, &amp;myUSBCom0CB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;6&#39;</span>, &amp;myUSBCom9CB);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ArModeCamera::giveUpPortKeys()</div>
<div class="line">{</div>
<div class="line">  remKeyHandler(&amp;myCom1CB);</div>
<div class="line">  remKeyHandler(&amp;myCom2CB);</div>
<div class="line">  remKeyHandler(&amp;myCom3CB);</div>
<div class="line">  remKeyHandler(&amp;myCom4CB);</div>
<div class="line">  remKeyHandler(&amp;myUSBCom0CB);</div>
<div class="line">  remKeyHandler(&amp;myUSBCom9CB);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ArModeCamera::helpPortKeys()</div>
<div class="line">{</div>
<div class="line">  ArLog::log(ArLog::Terse, </div>
<div class="line">         <span class="stringliteral">&quot;You now need to select what port your camera is on.&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  select COM1 or /dev/ttyS0&quot;</span>, <span class="stringliteral">&quot;&#39;1&#39;&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  select COM2 or /dev/ttyS1&quot;</span>, <span class="stringliteral">&quot;&#39;2&#39;&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  select COM3 or /dev/ttyS2&quot;</span>, <span class="stringliteral">&quot;&#39;3&#39;&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  select COM4 or /dev/ttyS3&quot;</span>, <span class="stringliteral">&quot;&#39;4&#39;&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  select /dev/ttyUSB0&quot;</span>, <span class="stringliteral">&quot;&#39;5&#39;&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  select /dev/ttyUSB9&quot;</span>, <span class="stringliteral">&quot;&#39;6&#39;&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ArModeCamera::takeAuxKeys()</div>
<div class="line">{</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;1&#39;</span>, &amp;myAux1CB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;2&#39;</span>, &amp;myAux2CB);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ArModeCamera::giveUpAuxKeys()</div>
<div class="line">{</div>
<div class="line">  remKeyHandler(&amp;myAux1CB);</div>
<div class="line">  remKeyHandler(&amp;myAux2CB);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ArModeCamera::helpAuxKeys()</div>
<div class="line">{</div>
<div class="line">  ArLog::log(ArLog::Terse,</div>
<div class="line">             <span class="stringliteral">&quot;You now need to select what aux port your camera is on.&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  select AUX1&quot;</span>, <span class="stringliteral">&quot;&#39;1&#39;&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  select AUX2&quot;</span>, <span class="stringliteral">&quot;&#39;2&#39;&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ArModeCamera::takeMovementKeys()</div>
<div class="line">{</div>
<div class="line">  addKeyHandler(ArKeyHandler::UP, &amp;myUpCB);</div>
<div class="line">  addKeyHandler(ArKeyHandler::DOWN, &amp;myDownCB);</div>
<div class="line">  addKeyHandler(ArKeyHandler::LEFT, &amp;myLeftCB);</div>
<div class="line">  addKeyHandler(ArKeyHandler::RIGHT, &amp;myRightCB);</div>
<div class="line">  addKeyHandler(ArKeyHandler::SPACE, &amp;myCenterCB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;e&#39;</span>, &amp;myExerciseCB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;E&#39;</span>, &amp;myExerciseCB);</div>
<div class="line">  <span class="keywordflow">if</span> (myCam-&gt;canZoom())</div>
<div class="line">  {</div>
<div class="line">    addKeyHandler(<span class="charliteral">&#39;z&#39;</span>, &amp;myZoomInCB);</div>
<div class="line">    addKeyHandler(<span class="charliteral">&#39;Z&#39;</span>, &amp;myZoomInCB);</div>
<div class="line">    addKeyHandler(<span class="charliteral">&#39;x&#39;</span>, &amp;myZoomOutCB);</div>
<div class="line">    addKeyHandler(<span class="charliteral">&#39;X&#39;</span>, &amp;myZoomOutCB);</div>
<div class="line">  }</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;f&#39;</span>, &amp;myToggleAutoFocusCB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;F&#39;</span>, &amp;myToggleAutoFocusCB);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ArModeCamera::giveUpMovementKeys()</div>
<div class="line">{</div>
<div class="line">  remKeyHandler(&amp;myUpCB);</div>
<div class="line">  remKeyHandler(&amp;myDownCB);</div>
<div class="line">  remKeyHandler(&amp;myLeftCB);</div>
<div class="line">  remKeyHandler(&amp;myRightCB);</div>
<div class="line">  remKeyHandler(&amp;myCenterCB);</div>
<div class="line">  remKeyHandler(&amp;myExerciseCB);</div>
<div class="line">  <span class="keywordflow">if</span> (myCam-&gt;canZoom())</div>
<div class="line">  {</div>
<div class="line">    remKeyHandler(&amp;myZoomInCB);</div>
<div class="line">    remKeyHandler(&amp;myZoomOutCB);</div>
<div class="line">  }</div>
<div class="line">  remKeyHandler(&amp;myToggleAutoFocusCB);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ArModeCamera::helpMovementKeys()</div>
<div class="line">{</div>
<div class="line">  ArLog::log(ArLog::Terse, </div>
<div class="line">         <span class="stringliteral">&quot;Camera mode will now let you move the camera.&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  tilt camera up by %d&quot;</span>, <span class="stringliteral">&quot;up arrow&quot;</span>, myTiltAmount);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  tilt camera down by %d&quot;</span>, <span class="stringliteral">&quot;down arrow&quot;</span>, myTiltAmount);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  pan camera left by %d&quot;</span>, <span class="stringliteral">&quot;left arrow&quot;</span>, myPanAmount);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  pan camera right by %d&quot;</span>, <span class="stringliteral">&quot;right arrow&quot;</span>, myPanAmount);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  center camera and zoom out&quot;</span>, </div>
<div class="line">         <span class="stringliteral">&quot;space bar&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  exercise the camera&quot;</span>, <span class="stringliteral">&quot;&#39;e&#39; or &#39;E&#39;&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span> (myCam-&gt;canZoom())</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  zoom in&quot;</span>, <span class="stringliteral">&quot;&#39;z&#39; or &#39;Z&#39;&quot;</span>);</div>
<div class="line">    ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  zoom out&quot;</span>, <span class="stringliteral">&quot;&#39;x&#39; or &#39;X&#39;&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  toggle auto/fixed focus&quot;</span>, <span class="stringliteral">&quot;&#39;f&#39; or &#39;F&#39;&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT ArModeSonar::ArModeSonar(ArRobot *robot, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> key,</div>
<div class="line">                  <span class="keywordtype">char</span> key2) :</div>
<div class="line">  ArMode(robot, name, key, key2),</div>
<div class="line">  myAllSonarCB(this, &amp;ArModeSonar::allSonar),</div>
<div class="line">  myFirstSonarCB(this, &amp;ArModeSonar::firstSonar),</div>
<div class="line">  mySecondSonarCB(this, &amp;ArModeSonar::secondSonar),</div>
<div class="line">  myThirdSonarCB(this, &amp;ArModeSonar::thirdSonar),</div>
<div class="line">  myFourthSonarCB(this, &amp;ArModeSonar::fourthSonar)</div>
<div class="line">{</div>
<div class="line">  myState = STATE_FIRST;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT ArModeSonar::~ArModeSonar()</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeSonar::activate()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (!baseActivate())</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;1&#39;</span>, &amp;myAllSonarCB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;2&#39;</span>, &amp;myFirstSonarCB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;3&#39;</span>, &amp;mySecondSonarCB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;4&#39;</span>, &amp;myThirdSonarCB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;5&#39;</span>, &amp;myFourthSonarCB);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeSonar::deactivate()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (!baseDeactivate())</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  remKeyHandler(&amp;myAllSonarCB);</div>
<div class="line">  remKeyHandler(&amp;myFirstSonarCB);</div>
<div class="line">  remKeyHandler(&amp;mySecondSonarCB);</div>
<div class="line">  remKeyHandler(&amp;myThirdSonarCB);</div>
<div class="line">  remKeyHandler(&amp;myFourthSonarCB);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeSonar::help()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> i;</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;This mode displays different segments of sonar.&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, </div>
<div class="line">         <span class="stringliteral">&quot;You can use these keys to switch what is displayed:&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s: display all sonar&quot;</span>, <span class="stringliteral">&quot;&#39;1&#39;&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s: display sonar 0 - 7&quot;</span>, <span class="stringliteral">&quot;&#39;2&#39;&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s: display sonar 8 - 15&quot;</span>, <span class="stringliteral">&quot;&#39;3&#39;&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s: display sonar 16 - 23&quot;</span>, <span class="stringliteral">&quot;&#39;4&#39;&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s: display sonar 24 - 31&quot;</span>, <span class="stringliteral">&quot;&#39;5&#39;&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Sonar readings:&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span> (myState == STATE_ALL)</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Displaying all sonar.&quot;</span>);</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; myRobot-&gt;getNumSonar(); ++i)</div>
<div class="line">      printf(<span class="stringliteral">&quot;%6d&quot;</span>, i); </div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (myState == STATE_FIRST)</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Displaying 0-7 sonar.&quot;</span>);</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; myRobot-&gt;getNumSonar() &amp;&amp; i &lt;= 7; ++i)</div>
<div class="line">      printf(<span class="stringliteral">&quot;%6d&quot;</span>, i); </div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (myState == STATE_SECOND)</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Displaying 8-15 sonar.&quot;</span>);</div>
<div class="line">    <span class="keywordflow">for</span> (i = 8; i &lt; myRobot-&gt;getNumSonar() &amp;&amp; i &lt;= 15; ++i)</div>
<div class="line">      printf(<span class="stringliteral">&quot;%6d&quot;</span>, i); </div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (myState == STATE_THIRD)</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Displaying 16-23 sonar.&quot;</span>);</div>
<div class="line">    <span class="keywordflow">for</span> (i = 16; i &lt; myRobot-&gt;getNumSonar() &amp;&amp; i &lt;= 23; ++i)</div>
<div class="line">      printf(<span class="stringliteral">&quot;%6d&quot;</span>, i); </div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (myState == STATE_FOURTH)</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Displaying 24-31 sonar.&quot;</span>);</div>
<div class="line">    <span class="keywordflow">for</span> (i = 24; i &lt; myRobot-&gt;getNumSonar() &amp;&amp; i &lt;= 31; ++i)</div>
<div class="line">      printf(<span class="stringliteral">&quot;%6d&quot;</span>, i); </div>
<div class="line">  }</div>
<div class="line">  printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeSonar::userTask()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> i;</div>
<div class="line">  printf(<span class="stringliteral">&quot;\r&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span> (myState == STATE_ALL)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; myRobot-&gt;getNumSonar(); ++i)</div>
<div class="line">      printf(<span class="stringliteral">&quot;%6d&quot;</span>, myRobot-&gt;getSonarRange(i)); </div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (myState == STATE_FIRST)</div>
<div class="line">  {</div>
<div class="line">     <span class="keywordflow">for</span> (i = 0; i &lt; myRobot-&gt;getNumSonar() &amp;&amp; i &lt;= 7; ++i)</div>
<div class="line">      printf(<span class="stringliteral">&quot;%6d&quot;</span>, myRobot-&gt;getSonarRange(i));</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (myState == STATE_SECOND)</div>
<div class="line">  {</div>
<div class="line">     <span class="keywordflow">for</span> (i = 8; i &lt; myRobot-&gt;getNumSonar() &amp;&amp; i &lt;= 15; ++i)</div>
<div class="line">      printf(<span class="stringliteral">&quot;%6d&quot;</span>, myRobot-&gt;getSonarRange(i));</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (myState == STATE_THIRD)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">for</span> (i = 16; i &lt; myRobot-&gt;getNumSonar() &amp;&amp; i &lt;= 23; ++i)</div>
<div class="line">      printf(<span class="stringliteral">&quot;%6d&quot;</span>, myRobot-&gt;getSonarRange(i)); </div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (myState == STATE_FOURTH)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">for</span> (i = 24; i &lt; myRobot-&gt;getNumSonar() &amp;&amp; i &lt;= 31; ++i)</div>
<div class="line">      printf(<span class="stringliteral">&quot;%6d&quot;</span>, myRobot-&gt;getSonarRange(i)); </div>
<div class="line">  }</div>
<div class="line">  fflush(stdout);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeSonar::allSonar()</div>
<div class="line">{</div>
<div class="line">  myState = STATE_ALL;</div>
<div class="line">  printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">  help();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeSonar::firstSonar()</div>
<div class="line">{</div>
<div class="line">  myState = STATE_FIRST;</div>
<div class="line">  printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">  help();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeSonar::secondSonar()</div>
<div class="line">{</div>
<div class="line">  myState = STATE_SECOND;</div>
<div class="line">  printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">  help();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeSonar::thirdSonar()</div>
<div class="line">{</div>
<div class="line">  myState = STATE_THIRD;</div>
<div class="line">  printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">  help();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeSonar::fourthSonar()</div>
<div class="line">{</div>
<div class="line">  myState = STATE_FOURTH;</div>
<div class="line">  printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">  help();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT ArModeBumps::ArModeBumps(ArRobot *robot, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> key, <span class="keywordtype">char</span> key2): </div>
<div class="line">  ArMode(robot, name, key, key2)</div>
<div class="line">{</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT ArModeBumps::~ArModeBumps()</div>
<div class="line">{</div>
<div class="line">  </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeBumps::activate()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (!baseActivate())</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeBumps::deactivate()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (!baseDeactivate())</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeBumps::help()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Bumps mode will display whether bumpers are triggered or not...&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;keep in mind it is assuming you have a full bump ring... so you should&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;ignore readings for where there aren&#39;t bumpers.&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Bumper readings:&quot;</span>);</div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; myRobot-&gt;getNumFrontBumpers(); i++)</div>
<div class="line">  {</div>
<div class="line">    printf(<span class="stringliteral">&quot;%6d&quot;</span>, i + 1);</div>
<div class="line">  }</div>
<div class="line">  printf(<span class="stringliteral">&quot; |&quot;</span>);</div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; myRobot-&gt;getNumRearBumpers(); i++)</div>
<div class="line">  {</div>
<div class="line">    printf(<span class="stringliteral">&quot;%6d&quot;</span>, i + 1);</div>
<div class="line">  }</div>
<div class="line">  printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeBumps::userTask()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;</div>
<div class="line">  <span class="keywordtype">int</span> val;</div>
<div class="line">  <span class="keywordtype">int</span> bit;</div>
<div class="line">  <span class="keywordflow">if</span> (myRobot == NULL)</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  printf(<span class="stringliteral">&quot;\r&quot;</span>);</div>
<div class="line">  val = ((myRobot-&gt;getStallValue() &amp; 0xff00) &gt;&gt; 8);</div>
<div class="line">  <span class="keywordflow">for</span> (i = 0, bit = 2; i &lt; myRobot-&gt;getNumFrontBumpers(); i++, bit *= 2)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">if</span> (val &amp; bit)</div>
<div class="line">      printf(<span class="stringliteral">&quot;%6s&quot;</span>, <span class="stringliteral">&quot;trig&quot;</span>);</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      printf(<span class="stringliteral">&quot;%6s&quot;</span>, <span class="stringliteral">&quot;clear&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">  printf(<span class="stringliteral">&quot; |&quot;</span>);</div>
<div class="line">  val = ((myRobot-&gt;getStallValue() &amp; 0xff));</div>
<div class="line">  <span class="keywordflow">for</span> (i = 0, bit = 2; i &lt; myRobot-&gt;getNumRearBumpers(); i++, bit *= 2)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">if</span> (val &amp; bit)</div>
<div class="line">      printf(<span class="stringliteral">&quot;%6s&quot;</span>, <span class="stringliteral">&quot;trig&quot;</span>);</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      printf(<span class="stringliteral">&quot;%6s&quot;</span>, <span class="stringliteral">&quot;clear&quot;</span>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT ArModePosition::ArModePosition(ArRobot *robot, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> key, <span class="keywordtype">char</span> key2, ArAnalogGyro *gyro): </div>
<div class="line">  ArMode(robot, name, key, key2),</div>
<div class="line">  myUpCB(this, &amp;ArModePosition::up),</div>
<div class="line">  myDownCB(this, &amp;ArModePosition::down),</div>
<div class="line">  myLeftCB(this, &amp;ArModePosition::left),</div>
<div class="line">  myRightCB(this, &amp;ArModePosition::right),</div>
<div class="line">  myStopCB(this, &amp;ArModePosition::stop),</div>
<div class="line">  myResetCB(this, &amp;ArModePosition::reset),</div>
<div class="line">  myModeCB(this, &amp;ArModePosition::mode),</div>
<div class="line">  myGyroCB(this, &amp;ArModePosition::gyro),</div>
<div class="line">  myIncDistCB(this, &amp;ArModePosition::incDistance),</div>
<div class="line">  myDecDistCB(this, &amp;ArModePosition::decDistance)</div>
<div class="line">{</div>
<div class="line">  myGyro = gyro;</div>
<div class="line">  myMode = MODE_BOTH;</div>
<div class="line">  myModeString = <span class="stringliteral">&quot;both&quot;</span>;</div>
<div class="line">  myInHeadingMode = <span class="keyword">false</span>;</div>
<div class="line">  myDistance = 1000;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (myGyro != NULL &amp;&amp; !myGyro-&gt;hasNoInternalData())</div>
<div class="line">    myGyroZero = myGyro-&gt;getHeading();</div>
<div class="line">  myRobotZero = myRobot-&gt;getRawEncoderPose().getTh();</div>
<div class="line">  myInHeadingMode = <span class="keyword">true</span>;</div>
<div class="line">  myHeading = myRobot-&gt;getTh();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT ArModePosition::~ArModePosition()</div>
<div class="line">{</div>
<div class="line">  </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModePosition::activate()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (!baseActivate())</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">  addKeyHandler(ArKeyHandler::UP, &amp;myUpCB);</div>
<div class="line">  addKeyHandler(ArKeyHandler::DOWN, &amp;myDownCB);</div>
<div class="line">  addKeyHandler(ArKeyHandler::LEFT, &amp;myLeftCB);  </div>
<div class="line">  addKeyHandler(ArKeyHandler::RIGHT, &amp;myRightCB);</div>
<div class="line">  addKeyHandler(ArKeyHandler::SPACE, &amp;myStopCB);</div>
<div class="line">  addKeyHandler(ArKeyHandler::PAGEUP, &amp;myIncDistCB);</div>
<div class="line">  addKeyHandler(ArKeyHandler::PAGEDOWN, &amp;myDecDistCB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;r&#39;</span>, &amp;myResetCB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;R&#39;</span>, &amp;myResetCB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;x&#39;</span>, &amp;myModeCB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;X&#39;</span>, &amp;myModeCB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;z&#39;</span>, &amp;myGyroCB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;Z&#39;</span>, &amp;myGyroCB);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModePosition::deactivate()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (!baseDeactivate())</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">  remKeyHandler(&amp;myUpCB);</div>
<div class="line">  remKeyHandler(&amp;myDownCB);</div>
<div class="line">  remKeyHandler(&amp;myLeftCB);</div>
<div class="line">  remKeyHandler(&amp;myRightCB);</div>
<div class="line">  remKeyHandler(&amp;myStopCB);</div>
<div class="line">  remKeyHandler(&amp;myResetCB);</div>
<div class="line">  remKeyHandler(&amp;myModeCB);</div>
<div class="line">  remKeyHandler(&amp;myGyroCB);</div>
<div class="line">  remKeyHandler(&amp;myIncDistCB);</div>
<div class="line">  remKeyHandler(&amp;myDecDistCB);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModePosition::up()</div>
<div class="line">{</div>
<div class="line">  myRobot-&gt;move(myDistance);</div>
<div class="line">  <span class="keywordflow">if</span> (myInHeadingMode)</div>
<div class="line">  {</div>
<div class="line">    myInHeadingMode = <span class="keyword">false</span>;</div>
<div class="line">    myHeading = myRobot-&gt;getTh();</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModePosition::down()</div>
<div class="line">{</div>
<div class="line">  myRobot-&gt;move(-myDistance);</div>
<div class="line">  <span class="keywordflow">if</span> (myInHeadingMode)</div>
<div class="line">  {</div>
<div class="line">    myInHeadingMode = <span class="keyword">false</span>;</div>
<div class="line">    myHeading = myRobot-&gt;getTh();</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModePosition::incDistance()</div>
<div class="line">{</div>
<div class="line">  myDistance += 500;</div>
<div class="line">  puts(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">  help();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModePosition::decDistance()</div>
<div class="line">{</div>
<div class="line">  myDistance -= 500;</div>
<div class="line">  <span class="keywordflow">if</span>(myDistance &lt; 500) myDistance = 500;</div>
<div class="line">  puts(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">  help();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModePosition::left()</div>
<div class="line">{</div>
<div class="line">  myRobot-&gt;setDeltaHeading(90);</div>
<div class="line">  myInHeadingMode = <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModePosition::right()</div>
<div class="line">{</div>
<div class="line">  myRobot-&gt;setDeltaHeading(-90);</div>
<div class="line">  myInHeadingMode = <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModePosition::stop()</div>
<div class="line">{</div>
<div class="line">  myRobot-&gt;stop();</div>
<div class="line">  myInHeadingMode = <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModePosition::reset()</div>
<div class="line">{</div>
<div class="line">  myRobot-&gt;stop();</div>
<div class="line">  myRobot-&gt;moveTo(ArPose(0, 0, 0));</div>
<div class="line">  <span class="keywordflow">if</span> (myGyro != NULL &amp;&amp; !myGyro-&gt;hasNoInternalData())</div>
<div class="line">    myGyroZero = myGyro-&gt;getHeading();</div>
<div class="line">  myRobotZero = myRobot-&gt;getRawEncoderPose().getTh();</div>
<div class="line">  myInHeadingMode = <span class="keyword">true</span>;</div>
<div class="line">  myHeading = myRobot-&gt;getTh();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModePosition::mode()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (myMode == MODE_BOTH)</div>
<div class="line">  {</div>
<div class="line">    myMode = MODE_EITHER;</div>
<div class="line">    myModeString = <span class="stringliteral">&quot;either&quot;</span>;</div>
<div class="line">    myInHeadingMode = <span class="keyword">true</span>;</div>
<div class="line">    myRobot-&gt;stop();</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (myMode == MODE_EITHER)</div>
<div class="line">  {</div>
<div class="line">    myMode = MODE_BOTH;</div>
<div class="line">    myModeString = <span class="stringliteral">&quot;both&quot;</span>;</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModePosition::gyro()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (myGyro == NULL || !myGyro-&gt;haveGottenData())</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (myGyro != NULL &amp;&amp; myGyro-&gt;isActive())</div>
<div class="line">    myGyro-&gt;deactivate();</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (myGyro != NULL &amp;&amp; !myGyro-&gt;isActive() &amp;&amp; </div>
<div class="line">       myGyro-&gt;hasGyroOnlyMode() &amp;&amp; !myGyro-&gt;isGyroOnlyActive())</div>
<div class="line">    myGyro-&gt;activateGyroOnly();</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (myGyro != NULL &amp;&amp; !myGyro-&gt;isActive())</div>
<div class="line">    myGyro-&gt;activate();</div>
<div class="line"> </div>
<div class="line">  help();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModePosition::help()</div>
<div class="line">{</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Mode is one of two values:&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s: heading and move can happen simultaneously&quot;</span>, </div>
<div class="line">         <span class="stringliteral">&quot;both&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s: only heading or move is active (move holds heading)&quot;</span>, <span class="stringliteral">&quot;either&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  forward %.1f meter(s)&quot;</span>, <span class="stringliteral">&quot;up arrow&quot;</span>, myDistance/1000.0);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  backward %.1f meter(s)&quot;</span>, <span class="stringliteral">&quot;down arrow&quot;</span>, myDistance/1000.0);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  increase distance by 1/2 meter&quot;</span>, <span class="stringliteral">&quot;page up&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  decrease distance by 1/2 meter&quot;</span>, <span class="stringliteral">&quot;page down&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  turn left 90 degrees&quot;</span>, <span class="stringliteral">&quot;left arrow&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  turn right 90 degrees&quot;</span>, <span class="stringliteral">&quot;right arrow&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  stop&quot;</span>, <span class="stringliteral">&quot;space bar&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  reset ARIA position to (0, 0, 0)&quot;</span>, <span class="stringliteral">&quot;&#39;r&#39; or &#39;R&#39;&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  switch heading/velocity mode&quot;</span>,<span class="stringliteral">&quot;&#39;x&#39; or &#39;X&#39;&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span> (myGyro != NULL &amp;&amp; myGyro-&gt;haveGottenData() &amp;&amp; !myGyro-&gt;hasGyroOnlyMode())</div>
<div class="line">    ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  turn gyro on or off (stays this way in other modes)&quot;</span>,<span class="stringliteral">&quot;&#39;z&#39; or &#39;Z&#39;&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span> (myGyro != NULL &amp;&amp; myGyro-&gt;haveGottenData() &amp;&amp; myGyro-&gt;hasGyroOnlyMode())</div>
<div class="line">    ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  turn gyro on or off or gyro only (stays this way in other modes)&quot;</span>,<span class="stringliteral">&quot;&#39;z&#39; or &#39;Z&#39;&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Position mode shows the position stats on a robot.&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span> (myGyro != NULL &amp;&amp; myGyro-&gt;haveGottenData() &amp;&amp; </div>
<div class="line">      !myGyro-&gt;hasNoInternalData())</div>
<div class="line">    ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%7s%7s%9s%7s%8s%7s%8s%6s%10s%10s%10s&quot;</span>, <span class="stringliteral">&quot;x&quot;</span>, <span class="stringliteral">&quot;y&quot;</span>, <span class="stringliteral">&quot;th&quot;</span>, <span class="stringliteral">&quot;comp&quot;</span>, <span class="stringliteral">&quot;volts&quot;</span>, <span class="stringliteral">&quot;mpacs&quot;</span>, <span class="stringliteral">&quot;mode&quot;</span>, <span class="stringliteral">&quot;gyro&quot;</span>, <span class="stringliteral">&quot;gyro_th&quot;</span>, <span class="stringliteral">&quot;robot_th&quot;</span>, <span class="stringliteral">&quot;raw&quot;</span>);</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (myGyro != NULL &amp;&amp; myGyro-&gt;haveGottenData() &amp;&amp; </div>
<div class="line">       myGyro-&gt;hasNoInternalData())</div>
<div class="line">    ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%7s%7s%9s%7s%8s%7s%8s%6s%10s&quot;</span>, <span class="stringliteral">&quot;x&quot;</span>, <span class="stringliteral">&quot;y&quot;</span>, <span class="stringliteral">&quot;th&quot;</span>, <span class="stringliteral">&quot;comp&quot;</span>, <span class="stringliteral">&quot;volts&quot;</span>, <span class="stringliteral">&quot;mpacs&quot;</span>, <span class="stringliteral">&quot;mode&quot;</span>, <span class="stringliteral">&quot;gyro&quot;</span>, <span class="stringliteral">&quot;raw&quot;</span>);</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%7s%7s%9s%7s%8s%7s%8s%10s&quot;</span>, <span class="stringliteral">&quot;x&quot;</span>, <span class="stringliteral">&quot;y&quot;</span>, <span class="stringliteral">&quot;th&quot;</span>, <span class="stringliteral">&quot;comp&quot;</span>, <span class="stringliteral">&quot;volts&quot;</span>, <span class="stringliteral">&quot;mpacs&quot;</span>, <span class="stringliteral">&quot;mode&quot;</span>, <span class="stringliteral">&quot;raw&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModePosition::userTask()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (myRobot == NULL)</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  <span class="comment">// if we&#39;re in either mode and not in the heading mode try to keep the</span></div>
<div class="line">  <span class="comment">// same heading (in heading mode its controlled by those commands)</span></div>
<div class="line">  <span class="keywordflow">if</span> (myMode == MODE_EITHER &amp;&amp; !myInHeadingMode)</div>
<div class="line">  {</div>
<div class="line">    myRobot-&gt;setHeading(myHeading);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordtype">double</span> voltage;</div>
<div class="line">  <span class="keywordflow">if</span> (myRobot-&gt;getRealBatteryVoltage() &gt; 0)</div>
<div class="line">    voltage = myRobot-&gt;getRealBatteryVoltage();</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    voltage = myRobot-&gt;getBatteryVoltage();</div>
<div class="line"> </div>
<div class="line">  std::string gyroString;</div>
<div class="line">  <span class="keywordflow">if</span> (myGyro == NULL)</div>
<div class="line">    gyroString = <span class="stringliteral">&quot;none&quot;</span>;</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (myGyro-&gt;isActive())</div>
<div class="line">    gyroString = <span class="stringliteral">&quot;on&quot;</span>;</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (myGyro-&gt;hasGyroOnlyMode() &amp;&amp; myGyro-&gt;isGyroOnlyActive())</div>
<div class="line">    gyroString = <span class="stringliteral">&quot;only&quot;</span>;</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    gyroString = <span class="stringliteral">&quot;off&quot;</span>;</div>
<div class="line"> </div>
<div class="line">  ArPose raw = myRobot-&gt;getRawEncoderPose();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (myGyro != NULL &amp;&amp; myGyro-&gt;haveGottenData() &amp;&amp; </div>
<div class="line">      !myGyro-&gt;hasNoInternalData())</div>
<div class="line">    printf(<span class="stringliteral">&quot;\r%7.0f%7.0f%9.2f%7.0f%8.2f%7d%8s%6s%10.2f%10.2f %10.2f,%.2f,%.2f&quot;</span>, </div>
<div class="line">       myRobot-&gt;getX(),  myRobot-&gt;getY(), myRobot-&gt;getTh(), </div>
<div class="line">       myRobot-&gt;getCompass(), voltage,</div>
<div class="line">       myRobot-&gt;getMotorPacCount(),</div>
<div class="line">       myMode == MODE_BOTH ? <span class="stringliteral">&quot;both&quot;</span> : <span class="stringliteral">&quot;either&quot;</span>, </div>
<div class="line">       gyroString.c_str(),</div>
<div class="line">       ArMath::subAngle(myGyro-&gt;getHeading(), myGyroZero), </div>
<div class="line">       ArMath::subAngle(myRobot-&gt;getRawEncoderPose().getTh(),myRobotZero),</div>
<div class="line">       raw.getX(), raw.getY(), raw.getTh()</div>
<div class="line">    );</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (myGyro != NULL &amp;&amp; myGyro-&gt;haveGottenData() &amp;&amp; </div>
<div class="line">      myGyro-&gt;hasNoInternalData())</div>
<div class="line">    printf(<span class="stringliteral">&quot;\r%7.0f%7.0f%9.2f%7.0f%8.2f%7d%8s%6s%10.2f,%.2f,%.2f&quot;</span>, </div>
<div class="line">       myRobot-&gt;getX(),  myRobot-&gt;getY(), myRobot-&gt;getTh(), </div>
<div class="line">       myRobot-&gt;getCompass(), voltage,</div>
<div class="line">       myRobot-&gt;getMotorPacCount(),</div>
<div class="line">       myMode == MODE_BOTH ? <span class="stringliteral">&quot;both&quot;</span> : <span class="stringliteral">&quot;either&quot;</span>, </div>
<div class="line">       gyroString.c_str(),</div>
<div class="line">       raw.getX(), raw.getY(), raw.getTh()</div>
<div class="line"> </div>
<div class="line">  );</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    printf(<span class="stringliteral">&quot;\r%7.0f%7.0f%9.2f%7.0f%8.2f%7d%8s%10.2f,%.2f,%.2f&quot;</span>, myRobot-&gt;getX(), </div>
<div class="line">       myRobot-&gt;getY(), myRobot-&gt;getTh(), myRobot-&gt;getCompass(), </div>
<div class="line">       voltage, myRobot-&gt;getMotorPacCount(), </div>
<div class="line">       myMode == MODE_BOTH ? <span class="stringliteral">&quot;both&quot;</span> : <span class="stringliteral">&quot;either&quot;</span>,</div>
<div class="line">       raw.getX(), raw.getY(), raw.getTh()</div>
<div class="line">    );</div>
<div class="line">  fflush(stdout);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT ArModeIO::ArModeIO(ArRobot *robot, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> key, <span class="keywordtype">char</span> key2): </div>
<div class="line">  ArMode(robot, name, key, key2),</div>
<div class="line">  myTog1CB(this, &amp;ArModeIO::toggleOutput, 1),</div>
<div class="line">  myTog2CB(this, &amp;ArModeIO::toggleOutput, 2),</div>
<div class="line">  myTog3CB(this, &amp;ArModeIO::toggleOutput, 3),</div>
<div class="line">  myTog4CB(this, &amp;ArModeIO::toggleOutput, 4),</div>
<div class="line">  myTog5CB(this, &amp;ArModeIO::toggleOutput, 5),</div>
<div class="line">  myTog6CB(this, &amp;ArModeIO::toggleOutput, 6),</div>
<div class="line">  myTog7CB(this, &amp;ArModeIO::toggleOutput, 7),</div>
<div class="line">  myTog8CB(this, &amp;ArModeIO::toggleOutput, 8)</div>
<div class="line">{</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT ArModeIO::~ArModeIO()</div>
<div class="line">{</div>
<div class="line">  </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeIO::activate()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (!baseActivate())</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  <span class="keywordflow">if</span> (myRobot == NULL)</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  myRobot-&gt;comInt(ArCommands::IOREQUEST, 2);</div>
<div class="line">  myOutput[0] = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line">  myLastPacketTime = myRobot-&gt;getIOPacketTime();</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;1&#39;</span>, &amp;myTog1CB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;2&#39;</span>, &amp;myTog2CB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;3&#39;</span>, &amp;myTog3CB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;4&#39;</span>, &amp;myTog4CB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;5&#39;</span>, &amp;myTog5CB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;6&#39;</span>, &amp;myTog6CB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;7&#39;</span>, &amp;myTog7CB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;8&#39;</span>, &amp;myTog8CB);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeIO::deactivate()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (!baseDeactivate())</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  <span class="keywordflow">if</span> (myRobot == NULL)</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  myRobot-&gt;comInt(ArCommands::IOREQUEST, 0);</div>
<div class="line">  remKeyHandler(&amp;myTog1CB);</div>
<div class="line">  remKeyHandler(&amp;myTog2CB);</div>
<div class="line">  remKeyHandler(&amp;myTog3CB);</div>
<div class="line">  remKeyHandler(&amp;myTog4CB);</div>
<div class="line">  remKeyHandler(&amp;myTog5CB);</div>
<div class="line">  remKeyHandler(&amp;myTog6CB);</div>
<div class="line">  remKeyHandler(&amp;myTog7CB);</div>
<div class="line">  remKeyHandler(&amp;myTog8CB);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeIO::help()</div>
<div class="line">{</div>
<div class="line">  ArLog::log(ArLog::Terse, </div>
<div class="line">         <span class="stringliteral">&quot;IO mode shows the IO (digin, digout, a/d) from the robot.&quot;</span>);</div>
<div class="line">  myExplanationReady = <span class="keyword">false</span>;</div>
<div class="line">  myExplained = <span class="keyword">false</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ArModeIO::toggleOutput(<span class="keywordtype">int</span> which)</div>
<div class="line">{</div>
<div class="line">  printf(<span class="stringliteral">&quot;toggling output %d. Current output is %s\n&quot;</span>, which, byte_as_bitstring(myRobot-&gt;getDigOut()).c_str());</div>
<div class="line">  ArTypes::UByte mask = (1 &lt;&lt; (which-1));</div>
<div class="line">  ArTypes::UByte bits = ~(myRobot-&gt;getDigOut());</div>
<div class="line">  printf(<span class="stringliteral">&quot;-&gt; DIGOUT %s %s\n&quot;</span>, byte_as_bitstring(mask).c_str(), byte_as_bitstring(bits).c_str());</div>
<div class="line">  myRobot-&gt;com2Bytes(ArCommands::DIGOUT, mask, bits);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeIO::userTask()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> num;</div>
<div class="line">  <span class="keywordtype">int</span> i, j;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> value;</div>
<div class="line">  <span class="keywordtype">int</span> bit;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">int</span> label_size = 256;</div>
<div class="line">  <span class="keywordtype">char</span> label[label_size];</div>
<div class="line">  myOutput[0] = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//if (myLastPacketTime.mSecSince(myRobot-&gt;getIOPacketTime()) == 0)</span></div>
<div class="line">  <span class="comment">//  return;</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (!myExplanationReady)</div>
<div class="line">    myExplanation[0] = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line"> </div>
<div class="line">  value = myRobot-&gt;getFlags();</div>
<div class="line">  <span class="keywordflow">if</span> (!myExplanationReady)</div>
<div class="line">  {</div>
<div class="line">    snprintf(label, label_size, <span class="stringliteral">&quot;flags&quot;</span>);</div>
<div class="line">    snprintf(myExplanation, OutputBuffLen, <span class="stringliteral">&quot;%s%17s  &quot;</span>, myExplanation, label);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">for</span> (j = 0, bit = 1; j &lt; 16; ++j, bit *= 2)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">if</span> (j == 8)</div>
<div class="line">      snprintf(myOutput, OutputBuffLen, <span class="stringliteral">&quot;%s &quot;</span>, myOutput);</div>
<div class="line">    <span class="keywordflow">if</span> (value &amp; bit)</div>
<div class="line">      snprintf(myOutput, OutputBuffLen, <span class="stringliteral">&quot;%s%d&quot;</span>, myOutput, 1);</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      snprintf(myOutput, OutputBuffLen, <span class="stringliteral">&quot;%s%d&quot;</span>, myOutput, 0);</div>
<div class="line">  }</div>
<div class="line">  snprintf(myOutput, OutputBuffLen, <span class="stringliteral">&quot;%s  &quot;</span>, myOutput);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (myRobot-&gt;hasFaultFlags())</div>
<div class="line">  {</div>
<div class="line">    value = myRobot-&gt;getFaultFlags();</div>
<div class="line">    <span class="keywordflow">if</span> (!myExplanationReady)</div>
<div class="line">    {</div>
<div class="line">      snprintf(label, label_size, <span class="stringliteral">&quot;fault_flags&quot;</span>);</div>
<div class="line">      snprintf(myExplanation, OutputBuffLen, <span class="stringliteral">&quot;%s%17s  &quot;</span>, myExplanation, label);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">for</span> (j = 0, bit = 1; j &lt; 16; ++j, bit *= 2)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">if</span> (j == 8)</div>
<div class="line">        snprintf(myOutput, OutputBuffLen, <span class="stringliteral">&quot;%s &quot;</span>, myOutput);</div>
<div class="line">      <span class="keywordflow">if</span> (value &amp; bit)</div>
<div class="line">        snprintf(myOutput, OutputBuffLen, <span class="stringliteral">&quot;%s%d&quot;</span>, myOutput, 1);</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        snprintf(myOutput, OutputBuffLen, <span class="stringliteral">&quot;%s%d&quot;</span>, myOutput, 0);</div>
<div class="line">    }</div>
<div class="line">    snprintf(myOutput, OutputBuffLen, <span class="stringliteral">&quot;%s  &quot;</span>, myOutput);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  num = myRobot-&gt;getIODigInSize();</div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; num; ++i)</div>
<div class="line">  {</div>
<div class="line">    value = myRobot-&gt;getIODigIn(i);</div>
<div class="line">    <span class="keywordflow">if</span> (!myExplanationReady)</div>
<div class="line">    {</div>
<div class="line">      snprintf(label, label_size, <span class="stringliteral">&quot;digin%d&quot;</span>, i);</div>
<div class="line">      snprintf(myExplanation, OutputBuffLen, <span class="stringliteral">&quot;%s%8s  &quot;</span>, myExplanation, label);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">for</span> (j = 0, bit = 1; j &lt; 8; ++j, bit *= 2)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">if</span> (value &amp; bit)</div>
<div class="line">        snprintf(myOutput, OutputBuffLen, <span class="stringliteral">&quot;%s%d&quot;</span>, myOutput, 1);</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        snprintf(myOutput, OutputBuffLen, <span class="stringliteral">&quot;%s%d&quot;</span>, myOutput, 0);</div>
<div class="line">    }</div>
<div class="line">    snprintf(myOutput, OutputBuffLen, <span class="stringliteral">&quot;%s  &quot;</span>, myOutput);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span>(num == 0) <span class="comment">// use default Pioneer IO from SIP only if no IODigIns</span></div>
<div class="line">  {</div>
<div class="line">    value = myRobot-&gt;getDigIn();</div>
<div class="line">    <span class="keywordflow">if</span>(!myExplanationReady)</div>
<div class="line">    {</div>
<div class="line">      snprintf(label, label_size, <span class="stringliteral">&quot;digin&quot;</span>);</div>
<div class="line">      snprintf(myExplanation, OutputBuffLen, <span class="stringliteral">&quot;%s%8s  &quot;</span>, myExplanation, label);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">for</span> (j = 0, bit = 1; j &lt; 8; ++j, bit *= 2)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">if</span> (value &amp; bit)</div>
<div class="line">        snprintf(myOutput, OutputBuffLen, <span class="stringliteral">&quot;%s%d&quot;</span>, myOutput, 1);</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        snprintf(myOutput, OutputBuffLen, <span class="stringliteral">&quot;%s%d&quot;</span>, myOutput, 0);</div>
<div class="line">    }</div>
<div class="line">    snprintf(myOutput, OutputBuffLen, <span class="stringliteral">&quot;%s  &quot;</span>, myOutput);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  num = myRobot-&gt;getIODigOutSize();</div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; num; ++i)</div>
<div class="line">  {</div>
<div class="line">    value = myRobot-&gt;getIODigOut(i);</div>
<div class="line">    <span class="keywordflow">if</span> (!myExplanationReady)</div>
<div class="line">    {</div>
<div class="line">      snprintf(label, label_size, <span class="stringliteral">&quot;digout%d&quot;</span>, i);</div>
<div class="line">      snprintf(myExplanation, OutputBuffLen, <span class="stringliteral">&quot;%s%8s  &quot;</span>, myExplanation, label);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">for</span> (j = 0, bit = 1; j &lt; 8; ++j, bit *= 2)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">if</span> (value &amp; bit)</div>
<div class="line">        snprintf(myOutput, OutputBuffLen, <span class="stringliteral">&quot;%s%d&quot;</span>, myOutput, 1);</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        snprintf(myOutput, OutputBuffLen, <span class="stringliteral">&quot;%s%d&quot;</span>, myOutput, 0);</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">//snprintf(myOutput, OutputBuffLen, &quot;%s  &quot;, myOutput);</span></div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span>(num == 0) <span class="comment">// use default Pioneer IO from SIP only if no IODigIns</span></div>
<div class="line">  {</div>
<div class="line">    value = myRobot-&gt;getDigOut();</div>
<div class="line">    <span class="keywordflow">if</span>(!myExplanationReady)</div>
<div class="line">    {</div>
<div class="line">      snprintf(label, label_size, <span class="stringliteral">&quot;digout&quot;</span>);</div>
<div class="line">      snprintf(myExplanation, OutputBuffLen, <span class="stringliteral">&quot;%s%8s  &quot;</span>, myExplanation, label);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">for</span> (j = 0, bit = 1; j &lt; 8; ++j, bit *= 2)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">if</span> (value &amp; bit)</div>
<div class="line">        snprintf(myOutput, OutputBuffLen, <span class="stringliteral">&quot;%s%d&quot;</span>, myOutput, 1);</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        snprintf(myOutput, OutputBuffLen, <span class="stringliteral">&quot;%s%d&quot;</span>, myOutput, 0);</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">//snprintf(myOutput, OutputBuffLen, &quot;%s  &quot;, myOutput);</span></div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  num = myRobot-&gt;getIOAnalogSize();</div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; num; ++i)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">if</span> (!myExplanationReady)</div>
<div class="line">    {</div>
<div class="line">      snprintf(label, label_size, <span class="stringliteral">&quot;a/d%d&quot;</span>, i);</div>
<div class="line">      snprintf(myExplanation, OutputBuffLen, <span class="stringliteral">&quot;%s%6s&quot;</span>, myExplanation, label);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">      int ad = myRobot-&gt;getIOAnalog(i);</span></div>
<div class="line"><span class="comment">      double adVal;</span></div>
<div class="line"><span class="comment">    ad &amp;= 0xfff;</span></div>
<div class="line"><span class="comment">    adVal = ad * .0048828;</span></div>
<div class="line"><span class="comment">    snprintf(myOutput, OutputBuffLen, &quot;%s%6.2f&quot;, myOutput,adVal);</span></div>
<div class="line"><span class="comment">    */</span></div>
<div class="line">    snprintf(myOutput, OutputBuffLen, <span class="stringliteral">&quot;%s%6.2f&quot;</span>, myOutput, myRobot-&gt;getIOAnalogVoltage(i));</div>
<div class="line">    </div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (!myExplained)</div>
<div class="line">  {</div>
<div class="line">    printf(<span class="stringliteral">&quot;Robot has %d input bits, %d output bits, %d analog io. Robot %s have fault flags.\n&quot;</span>,</div>
<div class="line">      myRobot-&gt;getIODigInSize(),</div>
<div class="line">      myRobot-&gt;getIODigOutSize(),</div>
<div class="line">      myRobot-&gt;getIOAnalogSize(),</div>
<div class="line">      myRobot-&gt;hasFaultFlags() ? <span class="stringliteral">&quot;does&quot;</span> : <span class="stringliteral">&quot;does not&quot;</span></div>
<div class="line">    );</div>
<div class="line">    printf(<span class="stringliteral">&quot;\n%s\n&quot;</span>, myExplanation);</div>
<div class="line">    myExplained = <span class="keyword">true</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  printf(<span class="stringliteral">&quot;\r%s&quot;</span>, myOutput);</div>
<div class="line">  fflush(stdout);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT ArModeLaser::ArModeLaser(ArRobot *robot, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, </div>
<div class="line">                  <span class="keywordtype">char</span> key, <span class="keywordtype">char</span> key2) :</div>
<div class="line">  ArMode(robot, name, key, key2),</div>
<div class="line">  myTogMiddleCB(this, &amp;ArModeLaser::togMiddle)</div>
<div class="line">{</div>
<div class="line">  myPrintMiddle = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">  ArLaser *laser;</div>
<div class="line">  <span class="keywordtype">int</span> i;</div>
<div class="line">  <span class="keywordflow">for</span> (i = 1; i &lt;= 10; i++)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">if</span> ((laser = myRobot-&gt;findLaser(i)) != NULL)</div>
<div class="line">    {</div>
<div class="line">      myLaserCallbacks[i] = <span class="keyword">new</span> ArFunctor1C&lt;ArModeLaser, </div>
<div class="line">      <span class="keywordtype">int</span>&gt;(<span class="keyword">this</span>, &amp;ArModeLaser::switchToLaser, i),</div>
<div class="line">      myLasers[i] = laser;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  </div>
<div class="line">  myLaser = NULL;</div>
<div class="line">  myState = STATE_UNINITED;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT ArModeLaser::~ArModeLaser()</div>
<div class="line">{</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeLaser::activate()</div>
<div class="line">{</div>
<div class="line">  <span class="comment">// this is here because there needs to be the laser set up for the</span></div>
<div class="line">  <span class="comment">// help to work right</span></div>
<div class="line">  std::map&lt;int, ArLaser *&gt;::iterator it;</div>
<div class="line">  <span class="keywordflow">if</span> (myLaser == NULL)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">if</span> ((it = myLasers.begin()) == myLasers.end())</div>
<div class="line">    {</div>
<div class="line">      ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;Laser mode tried to activate, but has no lasers&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">      myLaser = (*it).second;</div>
<div class="line">      myLaserNumber = (*it).first;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">bool</span> alreadyActive = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (ourActiveMode == <span class="keyword">this</span>)</div>
<div class="line">    alreadyActive = <span class="keyword">true</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (!alreadyActive &amp;&amp; !baseActivate())</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (myRobot == NULL)</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Verbose, <span class="stringliteral">&quot;Laser mode activated but there is no robot.&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (myLaser == NULL)</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Verbose, <span class="stringliteral">&quot;Laser mode activated but there are no lasers.&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (!alreadyActive)</div>
<div class="line">  {</div>
<div class="line">    </div>
<div class="line">    addKeyHandler(<span class="charliteral">&#39;z&#39;</span>, &amp;myTogMiddleCB);</div>
<div class="line">    addKeyHandler(<span class="charliteral">&#39;Z&#39;</span>, &amp;myTogMiddleCB);</div>
<div class="line">    </div>
<div class="line">    std::map&lt;int, ArFunctor1C&lt;ArModeLaser, int&gt; *&gt;::iterator kIt;</div>
<div class="line">    <span class="keywordflow">for</span> (kIt = myLaserCallbacks.begin(); kIt != myLaserCallbacks.end(); kIt++)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">if</span> ((*kIt).first &gt;= 1 || (*kIt).first &lt;= 9)</div>
<div class="line">    addKeyHandler(<span class="charliteral">&#39;0&#39;</span> + (*kIt).first, (*kIt).second);</div>
<div class="line">    }   </div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (myState == STATE_UNINITED)</div>
<div class="line">  {</div>
<div class="line">    myLaser-&gt;lockDevice();</div>
<div class="line">    <span class="keywordflow">if</span> (myLaser-&gt;isConnected())</div>
<div class="line">    {</div>
<div class="line">      ArLog::log(ArLog::Verbose, </div>
<div class="line">         <span class="stringliteral">&quot;\nArModeLaser using already existing and connected laser.&quot;</span>);</div>
<div class="line">      myState = STATE_CONNECTED;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (myLaser-&gt;isTryingToConnect())</div>
<div class="line">    {</div>
<div class="line">      ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;\nArModeLaser already connecting to %s.&quot;</span>,</div>
<div class="line">         myLaser-&gt;getName());</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">      ArLog::log(ArLog::Terse,</div>
<div class="line">         <span class="stringliteral">&quot;\nArModeLaser is connecting to %s.&quot;</span>,</div>
<div class="line">         myLaser-&gt;getName());</div>
<div class="line">      myLaser-&gt;asyncConnect();</div>
<div class="line">      myState = STATE_CONNECTING;</div>
<div class="line">    }</div>
<div class="line">    myLaser-&gt;unlockDevice();</div>
<div class="line">  } </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeLaser::deactivate()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (!baseDeactivate())</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">  remKeyHandler(&amp;myTogMiddleCB);</div>
<div class="line">  </div>
<div class="line">  std::map&lt;int, ArFunctor1C&lt;ArModeLaser, int&gt; *&gt;::iterator it;</div>
<div class="line">  <span class="keywordflow">for</span> (it = myLaserCallbacks.begin(); it != myLaserCallbacks.end(); it++)</div>
<div class="line">  {</div>
<div class="line">    remKeyHandler((*it).second);</div>
<div class="line">  }   </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeLaser::help()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (myLaser == NULL)</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Terse, </div>
<div class="line">           <span class="stringliteral">&quot;There are no lasers, this mode cannot do anything&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  ArLog::log(ArLog::Terse, </div>
<div class="line">         <span class="stringliteral">&quot;Laser mode connects to a laser, or uses a previously established connection.&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse,</div>
<div class="line">         <span class="stringliteral">&quot;Laser mode then displays the closest and furthest reading from the laser.&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13s:  toggle between far reading and middle reading with reflectivity&quot;</span>, <span class="stringliteral">&quot;&#39;z&#39; or &#39;Z&#39;&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  std::map&lt;int, ArFunctor1C&lt;ArModeLaser, int&gt; *&gt;::iterator it;</div>
<div class="line">  <span class="keywordflow">for</span> (it = myLaserCallbacks.begin(); it != myLaserCallbacks.end(); it++)</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%13d:  %s&quot;</span>, (*it).first, </div>
<div class="line">           myLasers[(*it).first]-&gt;getName());</div>
<div class="line">  }   </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeLaser::userTask()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">double</span> dist = HUGE_VAL, angle = -1;</div>
<div class="line">  <span class="keywordtype">int</span> reflec = -1;</div>
<div class="line">  <span class="keywordtype">double</span> midDist = HUGE_VAL, midAngle = -1;</div>
<div class="line">  <span class="keywordtype">int</span> midReflec = -1;</div>
<div class="line">  <span class="keywordtype">double</span> farDist = -HUGE_VAL, farAngle = -1;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (myRobot == NULL || myLaser == NULL)</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (myState == STATE_CONNECTED &amp;&amp; !myPrintMiddle)</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> std::list&lt;ArPoseWithTime *&gt; *readings;</div>
<div class="line">    std::list&lt;ArPoseWithTime *&gt;::const_iterator it;</div>
<div class="line">    <span class="keywordtype">bool</span> found = <span class="keyword">false</span>;</div>
<div class="line">  </div>
<div class="line">    myLaser-&gt;lockDevice();</div>
<div class="line">    <span class="keywordflow">if</span> (!myLaser-&gt;isConnected())</div>
<div class="line">    {</div>
<div class="line">      ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;\n\nLaser mode lost connection to the laser.&quot;</span>);</div>
<div class="line">      ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Select that laser or laser mode again to try reconnecting to the laser.\n&quot;</span>);</div>
<div class="line">      myState = STATE_UNINITED;</div>
<div class="line">    }</div>
<div class="line">    dist = myLaser-&gt;currentReadingPolar(-90, 90, &amp;angle);</div>
<div class="line">    <span class="keywordflow">if</span> (dist &lt; myLaser-&gt;getMaxRange())</div>
<div class="line">      printf(<span class="stringliteral">&quot;\rClose: %8.0fmm %5.1f deg   &quot;</span>, dist, angle);</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      printf(<span class="stringliteral">&quot;\rNo close reading.         &quot;</span>);</div>
<div class="line"> </div>
<div class="line">    readings = myLaser-&gt;getCurrentBuffer();</div>
<div class="line">    <span class="keywordflow">for</span> (it = readings-&gt;begin(), found = <span class="keyword">false</span>; it != readings-&gt;end(); it++)</div>
<div class="line">    {</div>
<div class="line">      dist = myRobot-&gt;findDistanceTo(*(*it));</div>
<div class="line">      angle = myRobot-&gt;findDeltaHeadingTo(*(*it));</div>
<div class="line">      <span class="keywordflow">if</span> (!found || dist &gt; farDist)</div>
<div class="line">      {</div>
<div class="line">    found = <span class="keyword">true</span>;</div>
<div class="line">    farDist = dist;</div>
<div class="line">    farAngle = angle;</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (found)</div>
<div class="line">      printf(<span class="stringliteral">&quot;Far: %8.0fmm %5.1f deg&quot;</span>, </div>
<div class="line">         farDist, farAngle);</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      printf(<span class="stringliteral">&quot;No far reading found&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;         %lu readings   &quot;</span>, readings-&gt;size());</div>
<div class="line">    myLaser-&gt;unlockDevice();</div>
<div class="line">    fflush(stdout);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (myState == STATE_CONNECTED &amp;&amp; myPrintMiddle)</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> std::list&lt;ArSensorReading *&gt; *rawReadings;</div>
<div class="line">    std::list&lt;ArSensorReading *&gt;::const_iterator rawIt;</div>
<div class="line">    myLaser-&gt;lockDevice();</div>
<div class="line">    <span class="keywordflow">if</span> (!myLaser-&gt;isConnected())</div>
<div class="line">    {</div>
<div class="line">      ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;\n\nLaser mode lost connection to the laser.&quot;</span>);</div>
<div class="line">      ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Switch out of this mode and back if you want to try reconnecting to the laser.\n&quot;</span>);</div>
<div class="line">      myState = STATE_UNINITED;</div>
<div class="line">    }</div>
<div class="line">    rawReadings = myLaser-&gt;getRawReadings();</div>
<div class="line">    <span class="keywordtype">int</span> middleReading = rawReadings-&gt;size() / 2;</div>
<div class="line">    <span class="keywordflow">if</span> (rawReadings-&gt;begin() != rawReadings-&gt;end())</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordtype">int</span> i;</div>
<div class="line">      <span class="keywordflow">for</span> (rawIt = rawReadings-&gt;begin(), i = 0; </div>
<div class="line">       rawIt != rawReadings-&gt;end(); </div>
<div class="line">       rawIt++, i++)</div>
<div class="line">      {</div>
<div class="line">    <span class="keywordflow">if</span> ((*rawIt)-&gt;getIgnoreThisReading())</div>
<div class="line">      <span class="keywordflow">continue</span>;</div>
<div class="line">    <span class="keywordflow">if</span> (rawIt == rawReadings-&gt;begin() || </div>
<div class="line">        (*rawIt)-&gt;getRange() &lt; dist)</div>
<div class="line">    {</div>
<div class="line">      dist = (*rawIt)-&gt;getRange();</div>
<div class="line">      angle = (*rawIt)-&gt;getSensorTh();</div>
<div class="line">      reflec = (*rawIt)-&gt;getExtraInt();</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (i == middleReading)</div>
<div class="line">    {</div>
<div class="line">      midDist = (*rawIt)-&gt;getRange();</div>
<div class="line">      midAngle = (*rawIt)-&gt;getSensorTh();</div>
<div class="line">      midReflec = (*rawIt)-&gt;getExtraInt();</div>
<div class="line">    }</div>
<div class="line">      }</div>
<div class="line">      printf(</div>
<div class="line">      <span class="stringliteral">&quot;\rClose: %8.0fmm %5.1f deg %d refl          Middle: %8.0fmm %5.1fdeg, %d refl&quot;</span>, </div>
<div class="line">          dist, angle, reflec, midDist, midAngle, midReflec);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      printf(<span class="stringliteral">&quot;\rNo readings&quot;</span>);</div>
<div class="line">    myLaser-&gt;unlockDevice(); </div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (myState == STATE_CONNECTING)</div>
<div class="line">  {</div>
<div class="line">    myLaser-&gt;lockDevice();</div>
<div class="line">    <span class="keywordflow">if</span> (myLaser-&gt;isConnected())</div>
<div class="line">    {</div>
<div class="line">      ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;\nLaser mode has connected to the laser.\n&quot;</span>);</div>
<div class="line">      myState = STATE_CONNECTED;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!myLaser-&gt;isTryingToConnect())</div>
<div class="line">    {</div>
<div class="line">      ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;\nLaser mode failed to connect to the laser.\n&quot;</span>);</div>
<div class="line">      ArLog::log(ArLog::Terse, </div>
<div class="line">         <span class="stringliteral">&quot;Switch out of this mode and back to try reconnecting.\n&quot;</span>);</div>
<div class="line">      myState = STATE_UNINITED;</div>
<div class="line">    }</div>
<div class="line">    myLaser-&gt;unlockDevice();</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ArModeLaser::togMiddle()</div>
<div class="line">{</div>
<div class="line">  myPrintMiddle = !myPrintMiddle;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeLaser::switchToLaser(<span class="keywordtype">int</span> laserNumber)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (laserNumber == myLaserNumber &amp;&amp; myLaser-&gt;isConnected())</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Verbose, </div>
<div class="line">           <span class="stringliteral">&quot;ArModeLaser::switchToLaser: Already on laser %s&quot;</span>, myLaser-&gt;getName());</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  std::map&lt;int, ArLaser *&gt;::iterator it;</div>
<div class="line">  <span class="keywordflow">if</span> ((it = myLasers.find(laserNumber)) == myLasers.end())</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;ArModeLaser::switchToLaser: told to switch to laser %d but that laser does not exist&quot;</span>); </div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line">  myLaser = (*it).second;</div>
<div class="line">  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;\r\n\nSwitching to laser %s\n&quot;</span>, </div>
<div class="line">         myLaser-&gt;getName()); </div>
<div class="line">  myState = STATE_UNINITED;</div>
<div class="line">  myLaserNumber = laserNumber;</div>
<div class="line"> </div>
<div class="line">  activate();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if 0</span></div>
<div class="line"> </div>
<div class="line">AREXPORT ArModeActs::ArModeActs(ArRobot *robot, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> key, </div>
<div class="line">                <span class="keywordtype">char</span> key2, ArACTS_1_2 *acts): </div>
<div class="line">  ArMode(robot, name, key, key2),</div>
<div class="line">  myChannel1CB(this, &amp;ArModeActs::channel1),</div>
<div class="line">  myChannel2CB(this, &amp;ArModeActs::channel2),</div>
<div class="line">  myChannel3CB(this, &amp;ArModeActs::channel3),</div>
<div class="line">  myChannel4CB(this, &amp;ArModeActs::channel4),</div>
<div class="line">  myChannel5CB(this, &amp;ArModeActs::channel5),</div>
<div class="line">  myChannel6CB(this, &amp;ArModeActs::channel6),</div>
<div class="line">  myChannel7CB(this, &amp;ArModeActs::channel7),</div>
<div class="line">  myChannel8CB(this, &amp;ArModeActs::channel8),</div>
<div class="line">  myStopCB(this, &amp;ArModeActs::stop),</div>
<div class="line">  myStartCB(this, &amp;ArModeActs::start),</div>
<div class="line">  myToggleAcquireCB(this, &amp;ArModeActs::toggleAcquire)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (acts != NULL)</div>
<div class="line">    myActs = acts;</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    myActs = <span class="keyword">new</span> ArACTS_1_2;</div>
<div class="line">  myRobot = robot;</div>
<div class="line">  myActs-&gt;openPort(myRobot);</div>
<div class="line">  myGroup = <span class="keyword">new</span> ArActionGroupColorFollow(myRobot, myActs, camera);</div>
<div class="line">  myGroup-&gt;deactivate();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Destructor</span></div>
<div class="line">AREXPORT ArModeActs::~ArModeActs()</div>
<div class="line">{</div>
<div class="line">  </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Activate the mode</span></div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeActs::activate()</div>
<div class="line">{</div>
<div class="line">  <span class="comment">// Activate the group</span></div>
<div class="line">  <span class="keywordflow">if</span> (!baseActivate())</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  myGroup-&gt;activateExclusive();</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// Add key handlers for keyboard input</span></div>
<div class="line">  addKeyHandler(ArKeyHandler::SPACE, &amp;myStopCB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;z&#39;</span>, &amp;myStartCB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;Z&#39;</span>, &amp;myStartCB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;x&#39;</span>, &amp;myToggleAcquireCB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;X&#39;</span>, &amp;myToggleAcquireCB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;1&#39;</span>, &amp;myChannel1CB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;2&#39;</span>, &amp;myChannel2CB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;3&#39;</span>, &amp;myChannel3CB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;4&#39;</span>, &amp;myChannel4CB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;5&#39;</span>, &amp;myChannel5CB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;6&#39;</span>, &amp;myChannel6CB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;7&#39;</span>, &amp;myChannel7CB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;8&#39;</span>, &amp;myChannel8CB);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Set the camera</span></div>
<div class="line">  camera = myRobot-&gt;getPTZ();</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// Tell us whether we are connected to ACTS or not</span></div>
<div class="line">  <span class="keywordflow">if</span>(myActs-&gt;isConnected())</div>
<div class="line">    { </div>
<div class="line">      printf(<span class="stringliteral">&quot;\nConnected to ACTS.\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">else</span> printf(<span class="stringliteral">&quot;\nNot connected to ACTS.\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Tell us whether a camera is defined or not</span></div>
<div class="line">  <span class="keywordflow">if</span>(camera != NULL)</div>
<div class="line">    {</div>
<div class="line">      printf(<span class="stringliteral">&quot;\nCamera defined.\n\n&quot;</span>);</div>
<div class="line">      myGroup-&gt;setCamera(camera);</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    {  </div>
<div class="line">      printf(<span class="stringliteral">&quot;\nNo camera defined.\n&quot;</span>);</div>
<div class="line">      printf(<span class="stringliteral">&quot;The robot will not tilt its camera up or down until\n&quot;</span>);</div>
<div class="line">      printf(<span class="stringliteral">&quot;a camera has been defined in camera mode (&#39;c&#39; or &#39;C&#39;).\n\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Deactivate the group</span></div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeActs::deactivate()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (!baseDeactivate())</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Remove the key handlers</span></div>
<div class="line">  remKeyHandler(&amp;myStopCB);</div>
<div class="line">  remKeyHandler(&amp;myStartCB);</div>
<div class="line">  remKeyHandler(&amp;myToggleAcquireCB);</div>
<div class="line">  remKeyHandler(&amp;myChannel1CB);</div>
<div class="line">  remKeyHandler(&amp;myChannel2CB);</div>
<div class="line">  remKeyHandler(&amp;myChannel3CB);</div>
<div class="line">  remKeyHandler(&amp;myChannel4CB);</div>
<div class="line">  remKeyHandler(&amp;myChannel5CB);</div>
<div class="line">  remKeyHandler(&amp;myChannel6CB);</div>
<div class="line">  remKeyHandler(&amp;myChannel7CB);</div>
<div class="line">  remKeyHandler(&amp;myChannel8CB);</div>
<div class="line"> </div>
<div class="line">  myGroup-&gt;deactivate();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Display the available commands</span></div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeActs::help()</div>
<div class="line">{</div>
<div class="line">  ArLog::log(ArLog::Terse, </div>
<div class="line">       <span class="stringliteral">&quot;ACTS mode will drive the robot in an attempt to follow a color blob.\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%20s:  Pick a channel&quot;</span>,     <span class="stringliteral">&quot;1 - 8    &quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%20s:  toggle acquire mode&quot;</span>, <span class="stringliteral">&quot;&#39;x&#39; or &#39;X&#39;&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%20s:  start movement&quot;</span>,     <span class="stringliteral">&quot;&#39;z&#39; or &#39;Z&#39;&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%20s:  stop movement&quot;</span>,      <span class="stringliteral">&quot;space bar&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line">  </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Display data about this mode</span></div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeActs::userTask()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> myChannel;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> *acquire;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> *move;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> *blob;</div>
<div class="line"> </div>
<div class="line">  myChannel = myGroup-&gt;getChannel();</div>
<div class="line">  <span class="keywordflow">if</span>(myGroup-&gt;getAcquire()) acquire = <span class="stringliteral">&quot;actively acquiring&quot;</span>;</div>
<div class="line">  <span class="keywordflow">else</span> acquire = <span class="stringliteral">&quot;passively acquiring&quot;</span>;</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">if</span>(myGroup-&gt;getMovement()) move = <span class="stringliteral">&quot;movement on&quot;</span>;</div>
<div class="line">  <span class="keywordflow">else</span> move = <span class="stringliteral">&quot;movement off&quot;</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span>(myGroup-&gt;getBlob()) blob = <span class="stringliteral">&quot;blob in sight&quot;</span>;</div>
<div class="line">  <span class="keywordflow">else</span> blob = <span class="stringliteral">&quot;no blob in sight&quot;</span>;</div>
<div class="line"> </div>
<div class="line">  printf(<span class="stringliteral">&quot;\r Channel: %d  %15s %25s %20s&quot;</span>, myChannel, move, acquire, blob);</div>
<div class="line">  fflush(stdout);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// The channels</span></div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeActs::channel1()</div>
<div class="line">{</div>
<div class="line">  myGroup-&gt;setChannel(1);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeActs::channel2()</div>
<div class="line">{</div>
<div class="line">  myGroup-&gt;setChannel(2);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeActs::channel3()</div>
<div class="line">{</div>
<div class="line">  myGroup-&gt;setChannel(3);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeActs::channel4()</div>
<div class="line">{</div>
<div class="line">  myGroup-&gt;setChannel(4);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeActs::channel5()</div>
<div class="line">{</div>
<div class="line">  myGroup-&gt;setChannel(5);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeActs::channel6()</div>
<div class="line">{</div>
<div class="line">  myGroup-&gt;setChannel(6);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeActs::channel7()</div>
<div class="line">{</div>
<div class="line">  myGroup-&gt;setChannel(7);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeActs::channel8()</div>
<div class="line">{</div>
<div class="line">  myGroup-&gt;setChannel(8);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Stop the robot from moving</span></div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeActs::stop()</div>
<div class="line">{</div>
<div class="line">  myGroup-&gt;stopMovement();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Allow the robot to move</span></div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeActs::start()</div>
<div class="line">{</div>
<div class="line">  myGroup-&gt;startMovement();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Toggle whether or not the robot is allowed</span></div>
<div class="line"><span class="comment">// to aquire anything</span></div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeActs::toggleAcquire()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span>(myGroup-&gt;getAcquire())</div>
<div class="line">    myGroup-&gt;setAcquire(<span class="keyword">false</span>);</div>
<div class="line">  <span class="keywordflow">else</span> myGroup-&gt;setAcquire(<span class="keyword">true</span>);</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">AREXPORT ArModeCommand::ArModeCommand(ArRobot *robot, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> key, <span class="keywordtype">char</span> key2): </div>
<div class="line">  ArMode(robot, name, key, key2),</div>
<div class="line">  my0CB(this, &amp;ArModeCommand::addChar, <span class="stringliteral">&#39;0&#39;</span>),</div>
<div class="line">  my1CB(this, &amp;ArModeCommand::addChar, <span class="stringliteral">&#39;1&#39;</span>),</div>
<div class="line">  my2CB(this, &amp;ArModeCommand::addChar, <span class="stringliteral">&#39;2&#39;</span>),</div>
<div class="line">  my3CB(this, &amp;ArModeCommand::addChar, <span class="stringliteral">&#39;3&#39;</span>),</div>
<div class="line">  my4CB(this, &amp;ArModeCommand::addChar, <span class="stringliteral">&#39;4&#39;</span>),</div>
<div class="line">  my5CB(this, &amp;ArModeCommand::addChar, <span class="stringliteral">&#39;5&#39;</span>),</div>
<div class="line">  my6CB(this, &amp;ArModeCommand::addChar, <span class="stringliteral">&#39;6&#39;</span>),</div>
<div class="line">  my7CB(this, &amp;ArModeCommand::addChar, <span class="stringliteral">&#39;7&#39;</span>),</div>
<div class="line">  my8CB(this, &amp;ArModeCommand::addChar, <span class="stringliteral">&#39;8&#39;</span>),</div>
<div class="line">  my9CB(this, &amp;ArModeCommand::addChar, <span class="stringliteral">&#39;9&#39;</span>),</div>
<div class="line">  myMinusCB(this, &amp;ArModeCommand::addChar, <span class="stringliteral">&#39;-&#39;</span>),</div>
<div class="line">  myBackspaceCB(this, &amp;ArModeCommand::addChar, ArKeyHandler::BACKSPACE),</div>
<div class="line">  mySpaceCB(this, &amp;ArModeCommand::addChar, ArKeyHandler::SPACE),</div>
<div class="line">  myEnterCB(this, &amp;ArModeCommand::finishParsing)</div>
<div class="line"> </div>
<div class="line">{</div>
<div class="line">  reset(<span class="keyword">false</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT ArModeCommand::~ArModeCommand()</div>
<div class="line">{</div>
<div class="line">  </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeCommand::activate()</div>
<div class="line">{</div>
<div class="line">  reset(<span class="keyword">false</span>);</div>
<div class="line">  <span class="keywordflow">if</span> (!baseActivate())</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  myRobot-&gt;stopStateReflection();</div>
<div class="line">  takeKeys();</div>
<div class="line">  reset(<span class="keyword">true</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeCommand::deactivate()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (!baseDeactivate())</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  giveUpKeys();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeCommand::help()</div>
<div class="line">{</div>
<div class="line">  </div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Command mode has three ways to send commands&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%-30s: Sends com(&lt;command&gt;)&quot;</span>, <span class="stringliteral">&quot;&lt;command&gt;&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%-30s: Sends comInt(&lt;command&gt;, &lt;integer&gt;)&quot;</span>, <span class="stringliteral">&quot;&lt;command&gt; &lt;integer&gt;&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%-30s: Sends com2Bytes(&lt;command&gt;, &lt;byte1&gt;, &lt;byte2&gt;)&quot;</span>, <span class="stringliteral">&quot;&lt;command&gt; &lt;byte1&gt; &lt;byte2&gt;&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ArModeCommand::addChar(<span class="keywordtype">int</span> ch)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (ch &lt; &#39;0&#39; &amp;&amp; ch &gt; <span class="charliteral">&#39;9&#39;</span> &amp;&amp; ch != <span class="charliteral">&#39;-&#39;</span> &amp;&amp; ch != ArKeyHandler::BACKSPACE &amp;&amp; </div>
<div class="line">      ch != ArKeyHandler::SPACE)</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Something horribly wrong in command mode since number is &lt; 0 || &gt; 9 (it is the value %d)&quot;</span>, ch);</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">size_t</span> size = <span class="keyword">sizeof</span>(myCommandString);</div>
<div class="line">  <span class="keywordtype">size_t</span> len = strlen(myCommandString);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (ch == ArKeyHandler::BACKSPACE)</div>
<div class="line">  {</div>
<div class="line">    <span class="comment">// don&#39;t overrun backwards</span></div>
<div class="line">    <span class="keywordflow">if</span> (len &lt; 1)</div>
<div class="line">      <span class="keywordflow">return</span>;</div>
<div class="line">    myCommandString[len-1] = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line">    printf(<span class="stringliteral">&quot;\r&gt; %s  \r&gt; %s&quot;</span>, myCommandString, myCommandString);</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (ch == ArKeyHandler::SPACE)</div>
<div class="line">  {</div>
<div class="line">    <span class="comment">// if we&#39;re at the start or have a space or - just return</span></div>
<div class="line">    <span class="keywordflow">if</span> (len &lt; 1 || myCommandString[len-1] == <span class="charliteral">&#39; &#39;</span> || </div>
<div class="line">    myCommandString[len-1] == <span class="charliteral">&#39;-&#39;</span>)</div>
<div class="line">      <span class="keywordflow">return</span>;</div>
<div class="line">    myCommandString[len] = <span class="charliteral">&#39; &#39;</span>;</div>
<div class="line">    myCommandString[len+1] = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line">    printf(<span class="stringliteral">&quot; &quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (ch == <span class="charliteral">&#39;-&#39;</span>)</div>
<div class="line">  {</div>
<div class="line">    <span class="comment">// make sure it isn&#39;t the command trying to be negated or that its the start of the byte</span></div>
<div class="line">    <span class="keywordflow">if</span> (len &lt; 1 || myCommandString[len-1] != <span class="charliteral">&#39; &#39;</span>)</div>
<div class="line">      <span class="keywordflow">return</span>;</div>
<div class="line">    printf(<span class="stringliteral">&quot;%c&quot;</span>, <span class="charliteral">&#39;-&#39;</span>);</div>
<div class="line">    myCommandString[len] = <span class="charliteral">&#39;-&#39;</span>;</div>
<div class="line">    myCommandString[len+1] = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (len + 1 &gt;= size)</div>
<div class="line">  {</div>
<div class="line">    printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">    ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Command is too long, abandoning command&quot;</span>);</div>
<div class="line">    reset();</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">  {</div>
<div class="line">    printf(<span class="stringliteral">&quot;%c&quot;</span>, ch);</div>
<div class="line">    myCommandString[len] = ch;</div>
<div class="line">    myCommandString[len+1] = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ArModeCommand::finishParsing()</div>
<div class="line">{</div>
<div class="line">  </div>
<div class="line">  ArArgumentBuilder builder;</div>
<div class="line">  builder.addPlain(myCommandString);</div>
<div class="line">  <span class="keywordtype">int</span> command;</div>
<div class="line">  <span class="keywordtype">int</span> int1;</div>
<div class="line">  <span class="keywordtype">int</span> int2;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (myCommandString[0] == <span class="charliteral">&#39;\0&#39;</span>)</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">  printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span> (builder.getArgc() == 0)</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Syntax error, no arguments.&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (builder.getArgc() == 1)</div>
<div class="line">  {</div>
<div class="line">    command = builder.getArgInt(0);</div>
<div class="line">    <span class="keywordflow">if</span> (command &lt; 0 || command &gt; 255 || !builder.isArgInt(0))</div>
<div class="line">    {</div>
<div class="line">      ArLog::log(ArLog::Terse, </div>
<div class="line">         <span class="stringliteral">&quot;Invalid command, must be an integer between 0 and 255&quot;</span>);</div>
<div class="line">      reset();</div>
<div class="line">      <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">      ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;com(%d)&quot;</span>, command);</div>
<div class="line">      myRobot-&gt;com(command);</div>
<div class="line">      reset();</div>
<div class="line">      <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (builder.getArgc() == 2)</div>
<div class="line">  {</div>
<div class="line">    command = builder.getArgInt(0);</div>
<div class="line">    int1 = builder.getArgInt(1);</div>
<div class="line">    <span class="keywordflow">if</span> (command &lt; 0 || command &gt; 255 || !builder.isArgInt(0))</div>
<div class="line">    {</div>
<div class="line">      ArLog::log(ArLog::Terse, </div>
<div class="line">         <span class="stringliteral">&quot;Invalid command, must be an integer between 0 and 255&quot;</span>);</div>
<div class="line">      reset();</div>
<div class="line">      <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (int1 &lt; -32767 || int1 &gt; 32767 || !builder.isArgInt(1))</div>
<div class="line">    {</div>
<div class="line">      ArLog::log(ArLog::Terse, </div>
<div class="line">     <span class="stringliteral">&quot;Invalid integer, must be an integer between -32767 and 32767&quot;</span>);</div>
<div class="line">      reset();</div>
<div class="line">      <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">      ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;comInt(%d, %d)&quot;</span>, command,</div>
<div class="line">         int1);</div>
<div class="line">      myRobot-&gt;comInt(command, int1);</div>
<div class="line">      reset();</div>
<div class="line">      <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (builder.getArgc() == 3)</div>
<div class="line">  {</div>
<div class="line">    command = builder.getArgInt(0);</div>
<div class="line">    int1 = builder.getArgInt(1);</div>
<div class="line">    int2 = builder.getArgInt(2);</div>
<div class="line">    <span class="keywordflow">if</span> (command &lt; 0 || command &gt; 255 || !builder.isArgInt(0))</div>
<div class="line">    {</div>
<div class="line">      ArLog::log(ArLog::Terse, </div>
<div class="line">         <span class="stringliteral">&quot;Invalid command, must be between 0 and 255&quot;</span>);</div>
<div class="line">      reset();</div>
<div class="line">      <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (int1 &lt; -128 || int1 &gt; 255 || !builder.isArgInt(1))</div>
<div class="line">    {</div>
<div class="line">      ArLog::log(ArLog::Terse, </div>
<div class="line">     <span class="stringliteral">&quot;Invalid byte1, must be an integer between -128 and 127, or between 0 and 255&quot;</span>);</div>
<div class="line">      reset();</div>
<div class="line">      <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (int2 &lt; -128 || int2 &gt; 255 || !builder.isArgInt(2))</div>
<div class="line">    {</div>
<div class="line">      ArLog::log(ArLog::Terse, </div>
<div class="line">     <span class="stringliteral">&quot;Invalid byte2, must be an integer between -128 and 127, or between 0 and 255&quot;</span>);</div>
<div class="line">      reset();</div>
<div class="line">      <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">      ArLog::log(ArLog::Terse, </div>
<div class="line">         <span class="stringliteral">&quot;com2Bytes(%d, %d, %d)&quot;</span>, </div>
<div class="line">         command, int1, int2);</div>
<div class="line">      myRobot-&gt;com2Bytes(command, int1, int2);</div>
<div class="line">      reset();</div>
<div class="line">      <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Syntax error, too many arguments&quot;</span>);</div>
<div class="line">    reset();</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ArModeCommand::reset(<span class="keywordtype">bool</span> print)</div>
<div class="line">{</div>
<div class="line">  myCommandString[0] = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line">  <span class="keywordflow">if</span> (print)</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;&gt; &quot;</span>);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ArModeCommand::takeKeys()</div>
<div class="line">{</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;0&#39;</span>, &amp;my0CB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;1&#39;</span>, &amp;my1CB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;2&#39;</span>, &amp;my2CB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;3&#39;</span>, &amp;my3CB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;4&#39;</span>, &amp;my4CB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;5&#39;</span>, &amp;my5CB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;6&#39;</span>, &amp;my6CB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;7&#39;</span>, &amp;my7CB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;8&#39;</span>, &amp;my8CB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;9&#39;</span>, &amp;my9CB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;-&#39;</span>, &amp;myMinusCB);</div>
<div class="line">  addKeyHandler(ArKeyHandler::BACKSPACE, &amp;myBackspaceCB);</div>
<div class="line">  addKeyHandler(ArKeyHandler::ENTER, &amp;myEnterCB);</div>
<div class="line">  addKeyHandler(ArKeyHandler::SPACE, &amp;mySpaceCB);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ArModeCommand::giveUpKeys()</div>
<div class="line">{</div>
<div class="line">  remKeyHandler(&amp;my0CB);</div>
<div class="line">  remKeyHandler(&amp;my1CB);</div>
<div class="line">  remKeyHandler(&amp;my2CB);</div>
<div class="line">  remKeyHandler(&amp;my3CB);</div>
<div class="line">  remKeyHandler(&amp;my4CB);</div>
<div class="line">  remKeyHandler(&amp;my5CB);</div>
<div class="line">  remKeyHandler(&amp;my6CB);</div>
<div class="line">  remKeyHandler(&amp;my7CB);</div>
<div class="line">  remKeyHandler(&amp;my8CB);</div>
<div class="line">  remKeyHandler(&amp;my9CB);</div>
<div class="line">  remKeyHandler(&amp;myBackspaceCB);</div>
<div class="line">  remKeyHandler(&amp;myMinusCB);</div>
<div class="line">  remKeyHandler(&amp;myEnterCB);</div>
<div class="line">  remKeyHandler(&amp;mySpaceCB);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if 0</span></div>
<div class="line"> </div>
<div class="line">AREXPORT ArModeTCM2::ArModeTCM2(ArRobot *robot, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> key, <span class="keywordtype">char</span> key2, ArTCM2 *tcm2): </div>
<div class="line">  ArMode(robot, name, key, key2)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (tcm2 != NULL)</div>
<div class="line">    myTCM2 = tcm2;</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    myTCM2 = <span class="keyword">new</span> ArTCMCompassRobot(robot);</div>
<div class="line"> </div>
<div class="line">  myOffCB = <span class="keyword">new</span> ArFunctorC&lt;ArTCM2&gt;(myTCM2, &amp;ArTCM2::commandOff);</div>
<div class="line">  myCompassCB = <span class="keyword">new</span> ArFunctorC&lt;ArTCM2&gt;(myTCM2, &amp;ArTCM2::commandJustCompass);</div>
<div class="line">  myOnePacketCB = <span class="keyword">new</span> ArFunctorC&lt;ArTCM2&gt;(myTCM2, &amp;ArTCM2::commandOnePacket);</div>
<div class="line">  myContinuousPacketsCB = <span class="keyword">new</span> ArFunctorC&lt;ArTCM2&gt;(</div>
<div class="line">      myTCM2, &amp;ArTCM2::commandContinuousPackets);</div>
<div class="line">  myUserCalibrationCB = <span class="keyword">new</span> ArFunctorC&lt;ArTCM2&gt;(</div>
<div class="line">      myTCM2, &amp;ArTCM2::commandUserCalibration);</div>
<div class="line">  myAutoCalibrationCB = <span class="keyword">new</span> ArFunctorC&lt;ArTCM2&gt;(</div>
<div class="line">      myTCM2, &amp;ArTCM2::commandAutoCalibration);</div>
<div class="line">  myStopCalibrationCB = <span class="keyword">new</span> ArFunctorC&lt;ArTCM2&gt;(</div>
<div class="line">      myTCM2, &amp;ArTCM2::commandStopCalibration);</div>
<div class="line">  myResetCB = <span class="keyword">new</span> ArFunctorC&lt;ArTCM2&gt;(</div>
<div class="line">      myTCM2, &amp;ArTCM2::commandSoftReset);</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT ArModeTCM2::~ArModeTCM2()</div>
<div class="line">{</div>
<div class="line">  </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeTCM2::activate()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (!baseActivate())</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  myTCM2-&gt;commandContinuousPackets();</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;0&#39;</span>, myOffCB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;1&#39;</span>, myCompassCB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;2&#39;</span>, myOnePacketCB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;3&#39;</span>, myContinuousPacketsCB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;4&#39;</span>, myUserCalibrationCB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;5&#39;</span>, myAutoCalibrationCB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;6&#39;</span>, myStopCalibrationCB);</div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;7&#39;</span>, myResetCB);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeTCM2::deactivate()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (!baseDeactivate())</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  myTCM2-&gt;commandJustCompass();</div>
<div class="line">  remKeyHandler(myOffCB);</div>
<div class="line">  remKeyHandler(myCompassCB);</div>
<div class="line">  remKeyHandler(myOnePacketCB);</div>
<div class="line">  remKeyHandler(myContinuousPacketsCB);</div>
<div class="line">  remKeyHandler(myUserCalibrationCB);</div>
<div class="line">  remKeyHandler(myAutoCalibrationCB);</div>
<div class="line">  remKeyHandler(myStopCalibrationCB);</div>
<div class="line">  remKeyHandler(myResetCB);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeTCM2::help()</div>
<div class="line">{</div>
<div class="line">  ArLog::log(ArLog::Terse, </div>
<div class="line">         <span class="stringliteral">&quot;TCM2 mode shows the data from the TCM2 compass and lets you send the TCM2 commands&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%20s:  turn TCM2 off&quot;</span>, <span class="stringliteral">&quot;&#39;0&#39;&quot;</span>);  </div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%20s:  just get compass readings&quot;</span>, <span class="stringliteral">&quot;&#39;1&#39;&quot;</span>);  </div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%20s:  get a single set of TCM2 data&quot;</span>, <span class="stringliteral">&quot;&#39;2&#39;&quot;</span>);  </div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%20s:  get continuous TCM2 data&quot;</span>, <span class="stringliteral">&quot;&#39;3&#39;&quot;</span>);  </div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%20s:  start user calibration&quot;</span>, <span class="stringliteral">&quot;&#39;4&#39;&quot;</span>);  </div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%20s:  start auto calibration&quot;</span>, <span class="stringliteral">&quot;&#39;5&#39;&quot;</span>);  </div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%20s:  stop calibration and get a single set of data&quot;</span>, <span class="stringliteral">&quot;&#39;6&#39;&quot;</span>);  </div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;%20s:  soft reset of compass&quot;</span>, <span class="stringliteral">&quot;&#39;7&#39;&quot;</span>);  </div>
<div class="line"> </div>
<div class="line">  printf(<span class="stringliteral">&quot;%6s %5s %5s %6s %6s %6s %6s %10s %4s %4s %6s %3s\n&quot;</span>, </div>
<div class="line">     <span class="stringliteral">&quot;comp&quot;</span>, <span class="stringliteral">&quot;pitch&quot;</span>, <span class="stringliteral">&quot;roll&quot;</span>, <span class="stringliteral">&quot;magX&quot;</span>, <span class="stringliteral">&quot;magY&quot;</span>, <span class="stringliteral">&quot;magZ&quot;</span>, <span class="stringliteral">&quot;temp&quot;</span>, <span class="stringliteral">&quot;error&quot;</span>,</div>
<div class="line">     <span class="stringliteral">&quot;calH&quot;</span>, <span class="stringliteral">&quot;calV&quot;</span>, <span class="stringliteral">&quot;calM&quot;</span>, <span class="stringliteral">&quot;cnt&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeTCM2::userTask()</div>
<div class="line">{</div>
<div class="line">  printf(<span class="stringliteral">&quot;\r%6.1f %5.1f %5.1f %6.2f %6.2f %6.2f %6.1f 0x%08x %4.0f %4.0f %6.2f %3d&quot;</span>, </div>
<div class="line">     myTCM2-&gt;getCompass(), myTCM2-&gt;getPitch(), myTCM2-&gt;getRoll(), </div>
<div class="line">     myTCM2-&gt;getXMagnetic(), myTCM2-&gt;getYMagnetic(), </div>
<div class="line">     myTCM2-&gt;getZMagnetic(), </div>
<div class="line">     myTCM2-&gt;getTemperature(), myTCM2-&gt;getError(), </div>
<div class="line">     myTCM2-&gt;getCalibrationH(), myTCM2-&gt;getCalibrationV(), </div>
<div class="line">     myTCM2-&gt;getCalibrationM(), myTCM2-&gt;getPacCount());</div>
<div class="line">  fflush(stdout);</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">AREXPORT ArModeConfig::ArModeConfig(ArRobot *robot, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> key1, <span class="keywordtype">char</span> key2) :</div>
<div class="line">  ArMode(robot, name, key1, key2),</div>
<div class="line">  myRobot(robot),</div>
<div class="line">  myConfigPacketReader(robot, false, &amp;myGotConfigPacketCB),</div>
<div class="line">  myGotConfigPacketCB(this, &amp;ArModeConfig::gotConfigPacket)</div>
<div class="line">{</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeConfig::help()</div>
<div class="line">{</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Robot Config mode requests a CONFIG packet from the robot and displays the result.&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeConfig::activate()</div>
<div class="line">{</div>
<div class="line">  baseActivate();  <span class="comment">// returns false on double activate, but we want to use this signal to request another config packet, so ignore.</span></div>
<div class="line">  <span class="keywordflow">if</span>(!myConfigPacketReader.requestPacket())</div>
<div class="line">    ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;ArModeConfig: Warning: config packet reader did not request (another) CONFIG packet.&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeConfig::deactivate()</div>
<div class="line">{</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ArModeConfig::gotConfigPacket()</div>
<div class="line">{</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;\nRobot CONFIG packet received:&quot;</span>);</div>
<div class="line">  myConfigPacketReader.log();</div>
<div class="line">  myConfigPacketReader.logMovement();</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Additional robot information:&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;HasStateOfCharge %d&quot;</span>, myRobot-&gt;haveStateOfCharge());</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;StateOfChargeLow %f&quot;</span>, myRobot-&gt;getStateOfChargeLow());</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;StateOfChargeShutdown %f&quot;</span>, myRobot-&gt;getStateOfChargeShutdown());</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;HasFaultFlags %d&quot;</span>, myRobot-&gt;hasFaultFlags());</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;HasTableIR %d&quot;</span>, myRobot-&gt;hasTableSensingIR());</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;NumSonar (rec&#39;d) %d&quot;</span>, myRobot-&gt;getNumSonar());</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;HasTemperature (rec&#39;d) %d&quot;</span>, myRobot-&gt;hasTemperature());</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;HasSettableVelMaxes %d&quot;</span>, myRobot-&gt;hasSettableVelMaxes());</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;HasSettableAccsDecs %d&quot;</span>, myRobot-&gt;hasSettableAccsDecs());</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;HasLatVel %d&quot;</span>, myRobot-&gt;hasLatVel());</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;HasMoveCommand %d&quot;</span>, myRobot-&gt;getRobotParams()-&gt;hasMoveCommand());</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Radius %f Width %f Length %f LengthFront %f LengthRear %f Diagonal %f&quot;</span>, </div>
<div class="line">    myRobot-&gt;getRobotRadius(),</div>
<div class="line">    myRobot-&gt;getRobotWidth(),</div>
<div class="line">    myRobot-&gt;getRobotLength(),</div>
<div class="line">    myRobot-&gt;getRobotLengthFront(),</div>
<div class="line">    myRobot-&gt;getRobotLengthRear(),</div>
<div class="line">    myRobot-&gt;getRobotDiagonal() </div>
<div class="line">  );</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">AREXPORT ArModeRobotStatus::ArModeRobotStatus(ArRobot *robot, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> key1, <span class="keywordtype">char</span> key2) :</div>
<div class="line">  ArMode(robot, name, key1, key2),</div>
<div class="line">  myRobot(robot),</div>
<div class="line">  myDebugMessageCB(this, &amp;ArModeRobotStatus::handleDebugMessage),</div>
<div class="line">  mySafetyStateCB(this, &amp;ArModeRobotStatus::handleSafetyStatePacket),</div>
<div class="line">  mySafetyWarningCB(this, &amp;ArModeRobotStatus::handleSafetyWarningPacket),</div>
<div class="line">  myBatteryShutdown(false),</div>
<div class="line">  myToggleShutdownCB(this, &amp;ArModeRobotStatus::toggleShutdown)</div>
<div class="line">{</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeRobotStatus::help()</div>
<div class="line">{</div>
<div class="line">  puts(<span class="stringliteral">&quot;Robot diagnostic flags mode prints the current state of the robot&#39;s error and diagnostic flags.&quot;</span>); </div>
<div class="line">  puts(<span class="stringliteral">&quot;Additional debug and status information will also be requested from the robot and logged if received.&quot;</span>);</div>
<div class="line">  puts(<span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line">  puts(<span class="stringliteral">&quot;volt:        Reported battery voltage&quot;</span>);</div>
<div class="line">  puts(<span class="stringliteral">&quot;soc:         Reported battery state of charge (if available)&quot;</span>);</div>
<div class="line">  puts(<span class="stringliteral">&quot;temp:        Reported temperature (-127 if unavailable)&quot;</span>);</div>
<div class="line">  puts(<span class="stringliteral">&quot;motors:      Are motors enabled?&quot;</span>);</div>
<div class="line">  puts(<span class="stringliteral">&quot;estop:       Is any e-stop button or mechanism engaged?&quot;</span>);</div>
<div class="line">  puts(<span class="stringliteral">&quot;stall:       Is left (L) or right (R) motor stalled?&quot;</span>);</div>
<div class="line">  puts(<span class="stringliteral">&quot;stallflags:  0=left motor stall, 1-7=front bumper segments hit, 8=right motor stall, 9-15=rear bumpers&quot;</span> );</div>
<div class="line">  puts(<span class="stringliteral">&quot;sip/s:       Robot status packets (SIP) received per second. Normally 10.&quot;</span>);</div>
<div class="line">  puts(<span class="stringliteral">&quot;flags:       0 = motors enabled, 1-4 = sonar array enabled, 5 = estop, 7-8 = legacy IR, 9 = joystick button, 11 = high temperature &quot;</span>);</div>
<div class="line">  puts(<span class="stringliteral">&quot;faults:      0=power error, 1=high temperature, 2=power error, 3=undervoltage, 4=gyro fault, 5=battery overtemperature, \n&quot;</span></div>
<div class="line">       <span class="stringliteral">&quot;             6=battery balance needed, 7=encoder degradation warning, 8=encoder failure, 9=drive fault, 10=estop mismatch,\n&quot;</span></div>
<div class="line">       <span class="stringliteral">&quot;             11=estop fail, 12=speed zone fault, 13=safety system fault, 14=backed up too fast, 15=joydrive warning&quot;</span></div>
<div class="line">  );</div>
<div class="line">  puts(<span class="stringliteral">&quot;chargestate: Battery charging status&quot;</span>);</div>
<div class="line">  puts(<span class="stringliteral">&quot;chargepower: Whether battery charge power is being received by battery (if this robot can measure this)&quot;</span>);</div>
<div class="line">  puts(<span class="stringliteral">&quot;flags3:      0=joystick override mode enabled, 1=amp comm error, 2=silent estop, 3=laser error N, 4=RCL disabled, 5=rotation saturated&quot;</span>);</div>
<div class="line">  puts(<span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  printf(<span class="stringliteral">&quot;Key commands:\n%13s:  wait for battery SoC to fall below 30%% (or if SoC is unavailable, for voltage to fall below 11.5V) and shut down robot power\n\n&quot;</span>, <span class="stringliteral">&quot;x&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  printFlagsHeader();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeRobotStatus::activate()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span>(baseActivate())</div>
<div class="line">  {</div>
<div class="line">    <span class="comment">// only do the following on the first activate. they remain activated.</span></div>
<div class="line">    myRobot-&gt;lock();</div>
<div class="line">    myRobot-&gt;addPacketHandler(&amp;myDebugMessageCB);</div>
<div class="line">    myRobot-&gt;addPacketHandler(&amp;mySafetyStateCB);</div>
<div class="line">    myRobot-&gt;addPacketHandler(&amp;mySafetyWarningCB);</div>
<div class="line">    myRobot-&gt;unlock();</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">  {</div>
<div class="line">    <span class="comment">// error activating base mode class</span></div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  addKeyHandler(<span class="charliteral">&#39;x&#39;</span>, &amp;myToggleShutdownCB);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span>(myBatteryShutdown) puts(<span class="stringliteral">&quot;Will send commands to shut down robot power if state of charge is &lt;= 30%% or battery voltage is &lt;= 11.5/23V. Press X to cancel.&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  puts(<span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line">  printFlagsHeader();</div>
<div class="line">  printFlags();</div>
<div class="line">  puts(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    </div>
<div class="line">  myRobot-&gt;lock();</div>
<div class="line">  <span class="keywordtype">int</span> flags = myRobot-&gt;getFlags();</div>
<div class="line">  <span class="keywordtype">int</span> faults = myRobot-&gt;hasFaultFlags() ? myRobot-&gt;getFaultFlags() : 0;</div>
<div class="line">  <span class="keywordtype">int</span> flags3 = myRobot-&gt;hasFlags3() ? myRobot-&gt;getFlags3() : 0;</div>
<div class="line">  <span class="keywordtype">int</span> configflags = 0;</div>
<div class="line">  <span class="keyword">const</span> ArRobotConfigPacketReader *configreader = myRobot-&gt;getOrigRobotConfig();</div>
<div class="line">  <span class="keywordflow">if</span>(configreader)</div>
<div class="line">    configflags = configreader-&gt;getConfigFlags();</div>
<div class="line">  myRobot-&gt;unlock();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span>(flags)</div>
<div class="line">  {</div>
<div class="line">    puts(<span class="stringliteral">&quot;Active Flags:&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>(flags &amp; ArUtil::BIT0)</div>
<div class="line">      puts(<span class="stringliteral">&quot;\tMotors are enabled (flag 0)&quot;</span>);</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      puts(<span class="stringliteral">&quot;\tMotors are disabled (flag 0)&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>(flags &amp; ArUtil::BIT5)</div>
<div class="line">      puts(<span class="stringliteral">&quot;\tESTOP (flag 5)&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>(flags &amp; ArUtil::BIT9)</div>
<div class="line">      puts(<span class="stringliteral">&quot;\tJoystick button pressed (flag 9)&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>(flags &amp; ArUtil::BIT11)</div>
<div class="line">      puts(<span class="stringliteral">&quot;\tHigh temperature. (flag 11)&quot;</span>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span>(faults)</div>
<div class="line">  {</div>
<div class="line">    puts(<span class="stringliteral">&quot;Active Fault Flags:&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>(faults &amp; ArUtil::BIT0)</div>
<div class="line">      puts(<span class="stringliteral">&quot;\tPDB Laser Status Error (fault 0)&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>(faults &amp; ArUtil::BIT1)</div>
<div class="line">      puts(<span class="stringliteral">&quot;\tHigh Temperature (fault 1)&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>(faults &amp; ArUtil::BIT2)</div>
<div class="line">      puts(<span class="stringliteral">&quot;\tPDB Error (fault 2)&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>(faults &amp; ArUtil::BIT3)</div>
<div class="line">      puts(<span class="stringliteral">&quot;\tUndervoltage/Low Battery (fault 3)&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>(faults &amp; ArUtil::BIT4)</div>
<div class="line">      puts(<span class="stringliteral">&quot;\tGyro Critical Fault (fault 4)&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>(faults &amp; ArUtil::BIT5)</div>
<div class="line">      puts(<span class="stringliteral">&quot;\tBattery Overtemperature (fault 5)&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>(faults &amp; ArUtil::BIT6)</div>
<div class="line">      puts(<span class="stringliteral">&quot;\tBattery balance required (fault 6)&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>(faults &amp; ArUtil::BIT7)</div>
<div class="line">      puts(<span class="stringliteral">&quot;\tEncoder degradation (fault 7)&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>(faults &amp; ArUtil::BIT8)</div>
<div class="line">      puts(<span class="stringliteral">&quot;\tEncoder failure (fault 8)&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>(faults &amp; ArUtil::BIT9)</div>
<div class="line">      puts(<span class="stringliteral">&quot;\tCritical general driving fault (fault 9)&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>(faults &amp; ArUtil::BIT10)</div>
<div class="line">      puts(<span class="stringliteral">&quot;\tESTOP Mismatch Warning. One ESTOP channel may be intermittent or failing. Check connections to control panel. (ESTOP_MISMATCH_FLAG, 10)&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>(faults &amp; ArUtil::BIT11)</div>
<div class="line">      puts(<span class="stringliteral">&quot;\tESTOP Safety Fault. ESTOP circuitry has failed. Motors disabled until safety system recommision or disabled. (ESTOP_SAFETY_FAULT, 11)&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>(faults &amp; ArUtil::BIT12)</div>
<div class="line">      puts(<span class="stringliteral">&quot;\tLaser/speed zone failure or zone mismatch. Speed limited until safety system recommisioa or disabled.  (SPEED_ZONE_SAFETY_FAULT, 12)&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>(faults &amp; ArUtil::BIT13)</div>
<div class="line">      puts(<span class="stringliteral">&quot;\tSAFETY_UNKNOWN_FAULT (fault 13)&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>(faults &amp; ArUtil::BIT14)</div>
<div class="line">      puts(<span class="stringliteral">&quot;\tBacked up too fast. Reduce speed to avoid or disable safety system to allow faster reverse motion. (fault 14)&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>(faults &amp; ArUtil::BIT15)</div>
<div class="line">      puts(<span class="stringliteral">&quot;\tJoydrive unsafe mode warning (fault 15)&quot;</span>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">if</span>(flags3)</div>
<div class="line">  {</div>
<div class="line">    puts(<span class="stringliteral">&quot;Active Flags3:&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>(flags3 &amp; ArUtil::BIT0)</div>
<div class="line">      puts(<span class="stringliteral">&quot;\tJoystick override mode enabled (0)&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>(flags3 &amp; ArUtil::BIT1)</div>
<div class="line">      puts(<span class="stringliteral">&quot;\tAmp. comm. error (1)&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>(flags3 &amp; ArUtil::BIT2)</div>
<div class="line">      puts(<span class="stringliteral">&quot;\tSilent E-Stop (2)&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>(flags3 &amp; ArUtil::BIT3)</div>
<div class="line">      puts(<span class="stringliteral">&quot;\tLaser safety circuit error (S300 error &#39;n&#39;) (3)&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>(~flags3 &amp; ArUtil::BIT4)</div>
<div class="line">      puts(<span class="stringliteral">&quot;\tRotation control loop not enabled (4)&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>(flags3 &amp; ArUtil::BIT5)</div>
<div class="line">      puts(<span class="stringliteral">&quot;\tRotation integrator saturated (5)&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">    </div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">if</span>(configflags &amp; ArUtil::BIT0)</div>
<div class="line">  {</div>
<div class="line">    puts(<span class="stringliteral">&quot;ConfigFlags:&quot;</span>);</div>
<div class="line">    puts(<span class="stringliteral">&quot;\tFirmware boot error. Robot controller bootloader detected but no firmware. (config flag 0 set)&quot;</span>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  fflush(stdout);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// TODO keys to enable/disable: LogMovementSent, LogMovementReceived,</span></div>
<div class="line">  <span class="comment">// LogVelocitiesReceived, PacketsReceivedTracking, LogSIPContents,</span></div>
<div class="line">  <span class="comment">// PacketsSentTracking.</span></div>
<div class="line">  <span class="comment">// TODO keys to start/stop WHEEL_INFO</span></div>
<div class="line">  </div>
<div class="line">  <span class="comment">// TODO get simulator info</span></div>
<div class="line"> </div>
<div class="line">  myRobot-&gt;comInt(214, 1); <span class="comment">// request state of safety systems</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">// print first header line for user task refresh</span></div>
<div class="line">  puts(<span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line">  printFlagsHeader();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeRobotStatus::deactivate()</div>
<div class="line">{</div>
<div class="line">  remKeyHandler(&amp;myToggleShutdownCB);</div>
<div class="line">  <span class="comment">// commented out to keep packet handlers active so we can use other modes but</span></div>
<div class="line">  <span class="comment">// still see debug messages</span></div>
<div class="line">  <span class="comment">//myRobot-&gt;remPacketHandler(&amp;myDebugMessageCB);</span></div>
<div class="line">  <span class="comment">//myRobot-&gt;remPacketHandler(&amp;mySafetyStateCB);</span></div>
<div class="line">  <span class="comment">//myRobot-&gt;remPacketHandler(&amp;mySafetyWarningCB);</span></div>
<div class="line">  <span class="keywordflow">if</span>(!baseDeactivate()) <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ArModeRobotStatus::toggleShutdown()</div>
<div class="line">{</div>
<div class="line">  myBatteryShutdown = !myBatteryShutdown;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span>(myBatteryShutdown)</div>
<div class="line">  {</div>
<div class="line">    puts(<span class="stringliteral">&quot;Will shut down robot power when state of charge is &lt;= 30%% or battery voltage is &lt;= 11.5/23V.&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">  {</div>
<div class="line">    puts(<span class="stringliteral">&quot;Cancelled shutdown&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">AREXPORT <span class="keywordtype">void</span> ArModeRobotStatus::userTask()</div>
<div class="line">{</div>
<div class="line">  printFlags();</div>
<div class="line">  printf(<span class="stringliteral">&quot;\r&quot;</span>);</div>
<div class="line">  fflush(stdout);</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">if</span>(myBatteryShutdown &amp;&amp;</div>
<div class="line">    ( (myRobot-&gt;haveStateOfCharge() &amp;&amp; (myRobot-&gt;getStateOfCharge() &lt;= 30)) ||</div>
<div class="line">      (!myRobot-&gt;haveStateOfCharge() &amp;&amp; (myRobot-&gt;getBatteryVoltage() &lt;= 11.5)) )</div>
<div class="line">  )</div>
<div class="line">  {</div>
<div class="line">    puts(<span class="stringliteral">&quot;stopping robot&quot;</span>);</div>
<div class="line">    myRobot-&gt;com(ArCommands::STOP);</div>
<div class="line">    ArUtil::sleep(50);</div>
<div class="line">    myRobot-&gt;comInt(ArCommands::ESTOP, 1);</div>
<div class="line">    puts(<span class="stringliteral">&quot;sending (various) commands to shut down robot&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    std::map&lt;int, ArBatteryMTX*&gt; *batMap = myRobot-&gt;getBatteryMap();</div>
<div class="line">    <span class="keywordflow">if</span>(batMap)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">for</span>(std::map&lt;int, ArBatteryMTX*&gt;::reverse_iterator i = batMap-&gt;rbegin(); i != batMap-&gt;rend(); ++i)</div>
<div class="line">      {</div>
<div class="line">        puts(<span class="stringliteral">&quot;telling an MTX battery to shut off&quot;</span>);</div>
<div class="line">        ArBatteryMTX *b = i-&gt;second;</div>
<div class="line">        <span class="keywordflow">if</span>(b &amp;&amp; b-&gt;isConnected()) b-&gt;sendEmergencyPowerOff();</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    puts(<span class="stringliteral">&quot;telling mt400 to shut off&quot;</span>);</div>
<div class="line">    myRobot-&gt;com2Bytes(31, 1, 1); <span class="comment">// mt400/patrolbot</span></div>
<div class="line"> </div>
<div class="line">    puts(<span class="stringliteral">&quot;telling seekur to recenter and power off&quot;</span>);</div>
<div class="line">    myRobot-&gt;com(119); <span class="comment">// seekur</span></div>
<div class="line"> </div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ArModeRobotStatus::printFlagsHeader()</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span>* headerfmt = </div>
<div class="line">    <span class="stringliteral">&quot;%-4s &quot;</span>  <span class="comment">// volts</span></div>
<div class="line">    <span class="stringliteral">&quot;%-4s &quot;</span>  <span class="comment">// soc</span></div>
<div class="line">    <span class="stringliteral">&quot;%-4s &quot;</span>     <span class="comment">// temp</span></div>
<div class="line">    <span class="stringliteral">&quot;%-6s &quot;</span>     <span class="comment">// mot.enable?</span></div>
<div class="line">    <span class="stringliteral">&quot;%-6s &quot;</span>      <span class="comment">// estop?</span></div>
<div class="line">    <span class="stringliteral">&quot;%-6s &quot;</span>      <span class="comment">// stallL?</span></div>
<div class="line">    <span class="stringliteral">&quot;%-2s &quot;</span>      <span class="comment">// stallR?</span></div>
<div class="line">    <span class="stringliteral">&quot;%-16s &quot;</span>     <span class="comment">// stallval</span></div>
<div class="line">    <span class="stringliteral">&quot;%-5s &quot;</span>      <span class="comment">// #sip/sec    </span></div>
<div class="line">    <span class="stringliteral">&quot;%-16s &quot;</span>     <span class="comment">// flags</span></div>
<div class="line">    <span class="stringliteral">&quot;%-16s &quot;</span>     <span class="comment">// fault flags</span></div>
<div class="line">    <span class="stringliteral">&quot;%-13s &quot;</span>     <span class="comment">// chargestate</span></div>
<div class="line">    <span class="stringliteral">&quot;%-7s &quot;</span>     <span class="comment">// chargerpower</span></div>
<div class="line">    <span class="stringliteral">&quot;%-32s &quot;</span>     <span class="comment">// flags3</span></div>
<div class="line">    <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  printf(headerfmt,</div>
<div class="line">        <span class="stringliteral">&quot;volt&quot;</span>,</div>
<div class="line">        <span class="stringliteral">&quot;soc&quot;</span>,</div>
<div class="line">        <span class="stringliteral">&quot;temp&quot;</span>,</div>
<div class="line">        <span class="stringliteral">&quot;motors&quot;</span>,</div>
<div class="line">        <span class="stringliteral">&quot;estop&quot;</span>,</div>
<div class="line">        <span class="stringliteral">&quot;L stall&quot;</span>,</div>
<div class="line">        <span class="stringliteral">&quot;R&quot;</span>,</div>
<div class="line">        <span class="stringliteral">&quot;stallval&quot;</span>,</div>
<div class="line">        <span class="stringliteral">&quot;sip/s&quot;</span>,</div>
<div class="line">        <span class="stringliteral">&quot;flags&quot;</span>,</div>
<div class="line">        <span class="stringliteral">&quot;faults&quot;</span>,</div>
<div class="line">        <span class="stringliteral">&quot;chargestate&quot;</span>,</div>
<div class="line">        <span class="stringliteral">&quot;charge&quot;</span>,</div>
<div class="line">        <span class="stringliteral">&quot;flags3&quot;</span></div>
<div class="line">    );</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ArModeRobotStatus::printFlags()</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span>* datafmt = </div>
<div class="line">    <span class="stringliteral">&quot;%-03.01f &quot;</span>  <span class="comment">// volts</span></div>
<div class="line">    <span class="stringliteral">&quot;%-03.02f &quot;</span>  <span class="comment">// soc</span></div>
<div class="line">    <span class="stringliteral">&quot;%- 04d &quot;</span>     <span class="comment">// temp</span></div>
<div class="line">    <span class="stringliteral">&quot;%-6s &quot;</span>     <span class="comment">// mot.enable?</span></div>
<div class="line">    <span class="stringliteral">&quot;%-6s &quot;</span>      <span class="comment">// estop?</span></div>
<div class="line">    <span class="stringliteral">&quot;%-6s &quot;</span>      <span class="comment">// stallL?</span></div>
<div class="line">    <span class="stringliteral">&quot;%-3s &quot;</span>      <span class="comment">// stallR?</span></div>
<div class="line">    <span class="stringliteral">&quot;%-16s &quot;</span>     <span class="comment">// stallval</span></div>
<div class="line">    <span class="stringliteral">&quot;%-5d &quot;</span>      <span class="comment">// #sip/sec    </span></div>
<div class="line">    <span class="stringliteral">&quot;%-16s &quot;</span>     <span class="comment">// flags</span></div>
<div class="line">    <span class="stringliteral">&quot;%-16s &quot;</span>     <span class="comment">// fault flags</span></div>
<div class="line">    <span class="stringliteral">&quot;%-13s &quot;</span>     <span class="comment">// chargestate</span></div>
<div class="line">    <span class="stringliteral">&quot;%-7s &quot;</span>     <span class="comment">// chargerpower</span></div>
<div class="line">    <span class="stringliteral">&quot;%-32s &quot;</span>     <span class="comment">// flags3</span></div>
<div class="line">  ;</div>
<div class="line"> </div>
<div class="line">  myRobot-&gt;lock();</div>
<div class="line"> </div>
<div class="line">  printf(datafmt,</div>
<div class="line">    myRobot-&gt;getRealBatteryVoltage(),</div>
<div class="line">    myRobot-&gt;getStateOfCharge(),</div>
<div class="line">    myRobot-&gt;getTemperature(),</div>
<div class="line">    myRobot-&gt;areMotorsEnabled()?<span class="stringliteral">&quot;yes&quot;</span>:<span class="stringliteral">&quot;NO&quot;</span>,</div>
<div class="line">    myRobot-&gt;isEStopPressed()?<span class="stringliteral">&quot;YES&quot;</span>:<span class="stringliteral">&quot;no&quot;</span>,</div>
<div class="line">    myRobot-&gt;isLeftMotorStalled()?<span class="stringliteral">&quot;YES&quot;</span>:<span class="stringliteral">&quot;no&quot;</span>,</div>
<div class="line">    myRobot-&gt;isRightMotorStalled()?<span class="stringliteral">&quot;YES&quot;</span>:<span class="stringliteral">&quot;no&quot;</span>,</div>
<div class="line">    int16_as_bitstring(myRobot-&gt;getStallValue()).c_str(),</div>
<div class="line">    myRobot-&gt;getMotorPacCount() ,</div>
<div class="line">    int16_as_bitstring(myRobot-&gt;getFlags()).c_str(),</div>
<div class="line">    myRobot-&gt;hasFaultFlags() ? int16_as_bitstring(myRobot-&gt;getFaultFlags()).c_str() : <span class="stringliteral">&quot;n/a&quot;</span>,</div>
<div class="line">    myRobot-&gt;getChargeStateName(),</div>
<div class="line">    myRobot-&gt;isChargerPowerGood() ? <span class="stringliteral">&quot;YES&quot;</span> : <span class="stringliteral">&quot;no&quot;</span>,</div>
<div class="line">    myRobot-&gt;hasFlags3() ? int32_as_bitstring(myRobot-&gt;getFlags3()).c_str() : <span class="stringliteral">&quot;n/a&quot;</span></div>
<div class="line">  );</div>
<div class="line">  myRobot-&gt;unlock();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">bool</span> ArModeRobotStatus::handleDebugMessage(ArRobotPacket *pkt)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span>(pkt-&gt;getID() != ArCommands::MARCDEBUG) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">  <span class="keywordtype">char</span> msg[256];</div>
<div class="line">  pkt-&gt;bufToStr(msg, <span class="keyword">sizeof</span>(msg));</div>
<div class="line">  msg[255] = 0;</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Firmware Debug Message Received: %s&quot;</span>, msg);</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> *ArModeRobotStatus::safetyStateName(<span class="keywordtype">int</span> state)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">switch</span> (state) {</div>
<div class="line">    <span class="keywordflow">case</span> 0:</div>
<div class="line">      <span class="keywordflow">return</span> <span class="stringliteral">&quot;unknown/initial&quot;</span>;</div>
<div class="line">    <span class="keywordflow">case</span> 0x10:</div>
<div class="line">      <span class="keywordflow">return</span> <span class="stringliteral">&quot;failure&quot;</span>;</div>
<div class="line">    <span class="keywordflow">case</span> 0x20: </div>
<div class="line">      <span class="keywordflow">return</span> <span class="stringliteral">&quot;warning&quot;</span>;</div>
<div class="line">    <span class="keywordflow">case</span> 0x40:</div>
<div class="line">      <span class="keywordflow">return</span> <span class="stringliteral">&quot;commissioned&quot;</span>;</div>
<div class="line">    <span class="keywordflow">case</span> 0x50:</div>
<div class="line">      <span class="keywordflow">return</span> <span class="stringliteral">&quot;decommissioned/disabled&quot;</span>;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> <span class="stringliteral">&quot;invalid/unknown&quot;</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">bool</span> ArModeRobotStatus::handleSafetyStatePacket(ArRobotPacket *p)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span>(p-&gt;getID() != 214) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">  <span class="keywordtype">int</span> state = p-&gt;bufToUByte();</div>
<div class="line">  <span class="keywordtype">int</span> estop_state = p-&gt;bufToUByte();</div>
<div class="line">  <span class="keywordtype">int</span> laser_state = p-&gt;bufToUByte();</div>
<div class="line">  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;Safety system state: 0x%x, system0(estop)=0x%x, %s, system1(laser)=0x%x, %s\n&quot;</span>, state, estop_state, safetyStateName(estop_state), laser_state, safetyStateName(laser_state));</div>
<div class="line">  <span class="keywordflow">if</span>(state == 0x10) ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Warning: Safety system enabled with failure detected, robot controller will not allow motion.&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span>(state == 0x20) ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Warning: Safety system enabled with warning indicated, robot controller will limit robot motion.&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span>(estop_state == 0x10) ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Warning: Safety estop subsystem enabled with failure detected, robot controller will not allow motion.&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span>(estop_state == 0x20) ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Warning: Safety estop subsystem enabled with warning indicated, robot controller will limit robot motion.&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span>(laser_state == 0x10) ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Warning: Safety laser subsystem enabled with failure detected, robot controller will not allow motion.&quot;</span>); </div>
<div class="line">  <span class="keywordflow">if</span>(laser_state == 0x20) ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Warning: Safety laser subsystem enabled with warning indicated, robot controller will limit robot motion.&quot;</span>);</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">bool</span> ArModeRobotStatus::handleSafetyWarningPacket(ArRobotPacket *p)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span>(p-&gt;getID() != 217) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Safety system warning received!&quot;</span>);</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// let other stuff also handle it</span></div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.18 </li>
  </ul>
</div>
</body>
</html>
